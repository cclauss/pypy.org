<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Allocation Removal in the Toy Optimizer | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2022/10/toy-optimizer-allocation-removal.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../../assets/css/tipuesearch.css">
<meta name="author" content="Carl Friedrich Bolz-Tereick">
<link rel="prev" href="../07/ddorf-sprint-sep-2022.html" title="Düsseldorf HPy/PyPy/GraalPy sprint September 19-23rd 2022" type="text/html">
<link rel="next" href="blog-15-years.html" title="The PyPy Blog Turns 15 Years" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Allocation Removal in the Toy Optimizer">
<meta property="og:url" content="https://www.pypy.org/posts/2022/10/toy-optimizer-allocation-removal.html">
<meta property="og:description" content="One of the workhorse optimization of RPython's tracing JIT is allocation
removal, which removes short-lived object allocation from traces. Many Python
programs create a lot of objects that only live f">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-10-25T07:55:00Z">
<meta property="article:tag" content="toy-optimizer">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog/">Index</a> </li>  
                    <li> <a href="../../../categories/">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://twitter.com/pypyproject">Twitter</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../../../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../../../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><article class="post-rest h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Allocation Removal in the Toy Optimizer</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2022-10-25T07:55:00Z" itemprop="datePublished" title="2022-10-25 07:55">2022-10-25 07:55</time></a>
            </p>
            
                <p class="commentline">            <a href="toy-optimizer-allocation-removal.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>One of the workhorse optimization of RPython's tracing JIT is <a class="reference external" href="https://dl.acm.org/doi/10.1145/1929501.1929508">allocation
removal</a>, which removes short-lived object allocation from traces. Many Python
programs create a lot of objects that only live for a short time, and whose
lifespan is fully predictable (common examples are integer and float boxes, but
also tuples, frames, intermediate string results, etc). Allocation removal will
try (and very often succeed) to remove these allocations from traces. In
this blog post I want to show a toy version of how allocation removal is
implemented.</p>
<p>In the <a class="reference external" href="../07/toy-optimizer.html">previous</a> blog post of this series I showed the complete code for
writing a toy one-pass optimizer that does constant folding, common
subexpression elimination and strength reduction. In this
second post, I want to use allocation removal as a more advanced optimization
pass. The basic optimization framework is the same, we will use the same
datastructures for intermediate representation and also keep using the same
union find data structure to store equivalences between IR operations. Here's
the infrastructure code from the last post:</p>
<div class="code"><pre class="code python"><a id="rest_code_00b059b9999c477385194305353991dd-1" name="rest_code_00b059b9999c477385194305353991dd-1" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-1"></a><span class="kn">import</span> <span class="nn">pytest</span>
<a id="rest_code_00b059b9999c477385194305353991dd-2" name="rest_code_00b059b9999c477385194305353991dd-2" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-2"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<a id="rest_code_00b059b9999c477385194305353991dd-3" name="rest_code_00b059b9999c477385194305353991dd-3" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-3"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-4" name="rest_code_00b059b9999c477385194305353991dd-4" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-4"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-5" name="rest_code_00b059b9999c477385194305353991dd-5" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-5"></a><span class="k">class</span> <span class="nc">Value</span><span class="p">:</span>
<a id="rest_code_00b059b9999c477385194305353991dd-6" name="rest_code_00b059b9999c477385194305353991dd-6" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-6"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-7" name="rest_code_00b059b9999c477385194305353991dd-7" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-7"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"abstract"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-8" name="rest_code_00b059b9999c477385194305353991dd-8" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-8"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-9" name="rest_code_00b059b9999c477385194305353991dd-9" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-9"></a>    <span class="k">def</span> <span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-10" name="rest_code_00b059b9999c477385194305353991dd-10" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-10"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"abstract"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-11" name="rest_code_00b059b9999c477385194305353991dd-11" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-11"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-12" name="rest_code_00b059b9999c477385194305353991dd-12" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-12"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-13" name="rest_code_00b059b9999c477385194305353991dd-13" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-13"></a><span class="k">class</span> <span class="nc">Operation</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-14" name="rest_code_00b059b9999c477385194305353991dd-14" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-14"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="rest_code_00b059b9999c477385194305353991dd-15" name="rest_code_00b059b9999c477385194305353991dd-15" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-15"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Value</span><span class="p">]</span>
<a id="rest_code_00b059b9999c477385194305353991dd-16" name="rest_code_00b059b9999c477385194305353991dd-16" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-16"></a>    <span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-17" name="rest_code_00b059b9999c477385194305353991dd-17" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="rest_code_00b059b9999c477385194305353991dd-18" name="rest_code_00b059b9999c477385194305353991dd-18" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
<a id="rest_code_00b059b9999c477385194305353991dd-19" name="rest_code_00b059b9999c477385194305353991dd-19" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_00b059b9999c477385194305353991dd-20" name="rest_code_00b059b9999c477385194305353991dd-20" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_00b059b9999c477385194305353991dd-21" name="rest_code_00b059b9999c477385194305353991dd-21" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-21"></a><span class="hll">
</span><a id="rest_code_00b059b9999c477385194305353991dd-22" name="rest_code_00b059b9999c477385194305353991dd-22" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-22"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-23" name="rest_code_00b059b9999c477385194305353991dd-23" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-23"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="rest_code_00b059b9999c477385194305353991dd-24" name="rest_code_00b059b9999c477385194305353991dd-24" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-24"></a>            <span class="sa">f</span><span class="s2">"Operation(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, "</span>
<a id="rest_code_00b059b9999c477385194305353991dd-25" name="rest_code_00b059b9999c477385194305353991dd-25" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-25"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span><span class="si">}</span><span class="s2">, "</span>
<a id="rest_code_00b059b9999c477385194305353991dd-26" name="rest_code_00b059b9999c477385194305353991dd-26" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-26"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_00b059b9999c477385194305353991dd-27" name="rest_code_00b059b9999c477385194305353991dd-27" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-27"></a>        <span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-28" name="rest_code_00b059b9999c477385194305353991dd-28" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-28"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-29" name="rest_code_00b059b9999c477385194305353991dd-29" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-29"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
<a id="rest_code_00b059b9999c477385194305353991dd-30" name="rest_code_00b059b9999c477385194305353991dd-30" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-30"></a>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span>
<a id="rest_code_00b059b9999c477385194305353991dd-31" name="rest_code_00b059b9999c477385194305353991dd-31" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-31"></a>        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">Operation</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-32" name="rest_code_00b059b9999c477385194305353991dd-32" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-32"></a>            <span class="nb">next</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">forwarded</span>
<a id="rest_code_00b059b9999c477385194305353991dd-33" name="rest_code_00b059b9999c477385194305353991dd-33" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-33"></a>            <span class="k">if</span> <span class="nb">next</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_00b059b9999c477385194305353991dd-34" name="rest_code_00b059b9999c477385194305353991dd-34" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-34"></a>                <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_00b059b9999c477385194305353991dd-35" name="rest_code_00b059b9999c477385194305353991dd-35" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-35"></a>            <span class="n">op</span> <span class="o">=</span> <span class="nb">next</span>
<a id="rest_code_00b059b9999c477385194305353991dd-36" name="rest_code_00b059b9999c477385194305353991dd-36" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-36"></a>        <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_00b059b9999c477385194305353991dd-37" name="rest_code_00b059b9999c477385194305353991dd-37" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-37"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-38" name="rest_code_00b059b9999c477385194305353991dd-38" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-38"></a>    <span class="k">def</span> <span class="nf">arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-39" name="rest_code_00b059b9999c477385194305353991dd-39" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-39"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
<a id="rest_code_00b059b9999c477385194305353991dd-40" name="rest_code_00b059b9999c477385194305353991dd-40" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-40"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-41" name="rest_code_00b059b9999c477385194305353991dd-41" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-41"></a>    <span class="k">def</span> <span class="nf">make_equal_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-42" name="rest_code_00b059b9999c477385194305353991dd-42" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">_set_forwarded</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-43" name="rest_code_00b059b9999c477385194305353991dd-43" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-43"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-44" name="rest_code_00b059b9999c477385194305353991dd-44" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-44"></a>    <span class="k">def</span> <span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-45" name="rest_code_00b059b9999c477385194305353991dd-45" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_00b059b9999c477385194305353991dd-46" name="rest_code_00b059b9999c477385194305353991dd-46" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-46"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-47" name="rest_code_00b059b9999c477385194305353991dd-47" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-47"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-48" name="rest_code_00b059b9999c477385194305353991dd-48" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-48"></a><span class="k">class</span> <span class="nc">Constant</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-49" name="rest_code_00b059b9999c477385194305353991dd-49" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-49"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-50" name="rest_code_00b059b9999c477385194305353991dd-50" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_00b059b9999c477385194305353991dd-51" name="rest_code_00b059b9999c477385194305353991dd-51" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-51"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-52" name="rest_code_00b059b9999c477385194305353991dd-52" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-52"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-53" name="rest_code_00b059b9999c477385194305353991dd-53" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-53"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Constant(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_00b059b9999c477385194305353991dd-54" name="rest_code_00b059b9999c477385194305353991dd-54" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-54"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-55" name="rest_code_00b059b9999c477385194305353991dd-55" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-55"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-56" name="rest_code_00b059b9999c477385194305353991dd-56" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-56"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="rest_code_00b059b9999c477385194305353991dd-57" name="rest_code_00b059b9999c477385194305353991dd-57" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-57"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-58" name="rest_code_00b059b9999c477385194305353991dd-58" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-58"></a>    <span class="k">def</span> <span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-59" name="rest_code_00b059b9999c477385194305353991dd-59" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-59"></a>        <span class="k">assert</span> <span class="p">(</span>
<a id="rest_code_00b059b9999c477385194305353991dd-60" name="rest_code_00b059b9999c477385194305353991dd-60" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-60"></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-61" name="rest_code_00b059b9999c477385194305353991dd-61" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-61"></a>            <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_00b059b9999c477385194305353991dd-62" name="rest_code_00b059b9999c477385194305353991dd-62" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-62"></a>        <span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-63" name="rest_code_00b059b9999c477385194305353991dd-63" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-63"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-64" name="rest_code_00b059b9999c477385194305353991dd-64" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-64"></a><span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-65" name="rest_code_00b059b9999c477385194305353991dd-65" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-65"></a>    <span class="k">def</span> <span class="nf">opbuilder</span><span class="p">(</span><span class="n">opname</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-66" name="rest_code_00b059b9999c477385194305353991dd-66" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-66"></a>        <span class="k">def</span> <span class="nf">wraparg</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-67" name="rest_code_00b059b9999c477385194305353991dd-67" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-67"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-68" name="rest_code_00b059b9999c477385194305353991dd-68" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-68"></a>                <span class="n">arg</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-69" name="rest_code_00b059b9999c477385194305353991dd-69" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-69"></a>            <span class="k">return</span> <span class="n">arg</span>
<a id="rest_code_00b059b9999c477385194305353991dd-70" name="rest_code_00b059b9999c477385194305353991dd-70" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-70"></a>        <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-71" name="rest_code_00b059b9999c477385194305353991dd-71" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-71"></a>            <span class="c1"># construct an Operation, wrap the</span>
<a id="rest_code_00b059b9999c477385194305353991dd-72" name="rest_code_00b059b9999c477385194305353991dd-72" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-72"></a>            <span class="c1"># arguments in Constants if necessary</span>
<a id="rest_code_00b059b9999c477385194305353991dd-73" name="rest_code_00b059b9999c477385194305353991dd-73" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-73"></a>            <span class="n">op</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="n">opname</span><span class="p">,</span>
<a id="rest_code_00b059b9999c477385194305353991dd-74" name="rest_code_00b059b9999c477385194305353991dd-74" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-74"></a>                <span class="p">[</span><span class="n">wraparg</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
<a id="rest_code_00b059b9999c477385194305353991dd-75" name="rest_code_00b059b9999c477385194305353991dd-75" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-75"></a>            <span class="c1"># add it to self, the basic block</span>
<a id="rest_code_00b059b9999c477385194305353991dd-76" name="rest_code_00b059b9999c477385194305353991dd-76" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-76"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-77" name="rest_code_00b059b9999c477385194305353991dd-77" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-77"></a>            <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_00b059b9999c477385194305353991dd-78" name="rest_code_00b059b9999c477385194305353991dd-78" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-78"></a>        <span class="k">return</span> <span class="n">build</span>
<a id="rest_code_00b059b9999c477385194305353991dd-79" name="rest_code_00b059b9999c477385194305353991dd-79" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-79"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-80" name="rest_code_00b059b9999c477385194305353991dd-80" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-80"></a>    <span class="c1"># a bunch of operations we support</span>
<a id="rest_code_00b059b9999c477385194305353991dd-81" name="rest_code_00b059b9999c477385194305353991dd-81" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-81"></a>    <span class="n">add</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"add"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-82" name="rest_code_00b059b9999c477385194305353991dd-82" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-82"></a>    <span class="n">mul</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"mul"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-83" name="rest_code_00b059b9999c477385194305353991dd-83" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-83"></a>    <span class="n">getarg</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"getarg"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-84" name="rest_code_00b059b9999c477385194305353991dd-84" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-84"></a>    <span class="n">dummy</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"dummy"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-85" name="rest_code_00b059b9999c477385194305353991dd-85" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-85"></a>    <span class="n">lshift</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"lshift"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-86" name="rest_code_00b059b9999c477385194305353991dd-86" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-86"></a>    <span class="c1"># some new one for this post</span>
<a id="rest_code_00b059b9999c477385194305353991dd-87" name="rest_code_00b059b9999c477385194305353991dd-87" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-87"></a>    <span class="n">alloc</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"alloc"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-88" name="rest_code_00b059b9999c477385194305353991dd-88" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-88"></a><span class="hll">    <span class="n">load</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"load"</span><span class="p">)</span>
</span><a id="rest_code_00b059b9999c477385194305353991dd-89" name="rest_code_00b059b9999c477385194305353991dd-89" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-89"></a><span class="hll">    <span class="n">store</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"store"</span><span class="p">)</span>
</span><a id="rest_code_00b059b9999c477385194305353991dd-90" name="rest_code_00b059b9999c477385194305353991dd-90" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-90"></a><span class="hll">    <span class="nb">print</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"print"</span><span class="p">)</span>
</span><a id="rest_code_00b059b9999c477385194305353991dd-91" name="rest_code_00b059b9999c477385194305353991dd-91" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-91"></a><span class="hll">
</span><a id="rest_code_00b059b9999c477385194305353991dd-92" name="rest_code_00b059b9999c477385194305353991dd-92" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-92"></a><span class="hll"><span class="k">def</span> <span class="nf">bb_to_str</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">,</span> <span class="n">varprefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"var"</span><span class="p">):</span>
</span><a id="rest_code_00b059b9999c477385194305353991dd-93" name="rest_code_00b059b9999c477385194305353991dd-93" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-93"></a>    <span class="k">def</span> <span class="nf">arg_to_str</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-94" name="rest_code_00b059b9999c477385194305353991dd-94" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-94"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-95" name="rest_code_00b059b9999c477385194305353991dd-95" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-95"></a>            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-96" name="rest_code_00b059b9999c477385194305353991dd-96" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-96"></a>        <span class="k">else</span><span class="p">:</span>
<a id="rest_code_00b059b9999c477385194305353991dd-97" name="rest_code_00b059b9999c477385194305353991dd-97" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-97"></a>            <span class="k">return</span> <span class="n">varnames</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
<a id="rest_code_00b059b9999c477385194305353991dd-98" name="rest_code_00b059b9999c477385194305353991dd-98" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-98"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-99" name="rest_code_00b059b9999c477385194305353991dd-99" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-99"></a>    <span class="n">varnames</span> <span class="o">=</span> <span class="p">{}</span>
<a id="rest_code_00b059b9999c477385194305353991dd-100" name="rest_code_00b059b9999c477385194305353991dd-100" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-100"></a>    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<a id="rest_code_00b059b9999c477385194305353991dd-101" name="rest_code_00b059b9999c477385194305353991dd-101" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-101"></a>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-102" name="rest_code_00b059b9999c477385194305353991dd-102" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-102"></a>        <span class="n">var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">varprefix</span><span class="si">}{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span>
<a id="rest_code_00b059b9999c477385194305353991dd-103" name="rest_code_00b059b9999c477385194305353991dd-103" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-103"></a>        <span class="n">varnames</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
<a id="rest_code_00b059b9999c477385194305353991dd-104" name="rest_code_00b059b9999c477385194305353991dd-104" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-104"></a>        <span class="n">arguments</span> <span class="o">=</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="rest_code_00b059b9999c477385194305353991dd-105" name="rest_code_00b059b9999c477385194305353991dd-105" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-105"></a>            <span class="n">arg_to_str</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a id="rest_code_00b059b9999c477385194305353991dd-106" name="rest_code_00b059b9999c477385194305353991dd-106" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-106"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
<a id="rest_code_00b059b9999c477385194305353991dd-107" name="rest_code_00b059b9999c477385194305353991dd-107" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-107"></a>        <span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-108" name="rest_code_00b059b9999c477385194305353991dd-108" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-108"></a>        <span class="n">strop</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">arguments</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_00b059b9999c477385194305353991dd-109" name="rest_code_00b059b9999c477385194305353991dd-109" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-109"></a>        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strop</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-110" name="rest_code_00b059b9999c477385194305353991dd-110" href="toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-110"></a>    <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
<p>There are two changes to the code from the last post: <code class="docutils literal">Operation</code> instances
have a new <code class="docutils literal">.info</code> field, which is set to <code class="docutils literal">None</code> by default. We will learn
how the info field is used a bit further down. Also, we define some new
operations.</p>
<section id="interpreter"><h2>Interpreter<a href="#interpreter" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>In this post we will mainly concern ourselves with optimizing
programs that allocate memory. We assume that our language is garbage collected
and memory safe. The new operations that we will optimize are <code class="docutils literal">alloc</code>
(allocates some new object), <code class="docutils literal">store</code> (stores a value into a fixed field of an
object), <code class="docutils literal">load</code> (loads the value from a field in the object).</p>
<p>We are leaving out a lot of details of a "real" system here, usually an
<code class="docutils literal">alloc</code> operation would get some extra information, for example the type of
the freshly allocated object or at least its size. <code class="docutils literal">load</code> and <code class="docutils literal">store</code> would
typically have some kind of field offset and maybe some information about the
field's type</p>
<p>Here's a simple program that uses these operations:</p>
<pre class="literal-block">var0 = getarg(0)
obj0 = alloc()
store(obj0, 0, var0)
var1 = load(obj0, 0)
print(var1)</pre>
<p>The code allocates a new object <code class="docutils literal">obj0</code>, stores <code class="docutils literal">var0</code> into field <code class="docutils literal">0</code> of
the object, the loads the same field and prints the result of the load.</p>
<p>Before we get started in writing the optimizer for these operations, let's try
to understand the semantics of the new operations a bit better. To do this, we
can sketch a small interpreter for basic blocks, supporting only <code class="docutils literal">getarg</code>,
<code class="docutils literal">alloc</code>, <code class="docutils literal">store</code>, <code class="docutils literal">load</code>, <code class="docutils literal">print</code>:</p>
<div class="code"><pre class="code python"><a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-1" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-1" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-1"></a><span class="k">def</span> <span class="nf">test_interpret</span><span class="p">():</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-2" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-2" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-3" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-3" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-4" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-4" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-4"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-5" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-5" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-5"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-6" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-6" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-6"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-7" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-7" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-7"></a>    <span class="n">bb</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-8" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-8" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-8"></a>    <span class="k">assert</span> <span class="n">interpret</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span> <span class="o">==</span> <span class="mi">17</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-9" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-9" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-9"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-10" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-10" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-10"></a><span class="k">class</span> <span class="nc">Object</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-11" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-11" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-11"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-12" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-12" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-13" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-13" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-13"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-14" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-14" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-14"></a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span> <span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-15" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-15" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-16" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-16" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-16"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-17" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-17" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-17"></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-18" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-18" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-18"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-19" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-19" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-19"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-20" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-20" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-20"></a><span class="k">def</span> <span class="nf">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-21" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-21" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-21"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">Constant</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-22" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-22" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-22"></a>    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-23" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-23" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-23"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-24" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-24" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-24"></a><span class="k">def</span> <span class="nf">interpret</span><span class="p">(</span><span class="n">bb</span> <span class="p">:</span> <span class="n">Block</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-25" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-25" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-25"></a>    <span class="k">def</span> <span class="nf">argval</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-26" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-26" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-26"></a>        <span class="n">arg</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-27" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-27" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-27"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-28" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-28" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-28"></a>            <span class="k">return</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-29" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-29" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-29"></a>        <span class="k">else</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-30" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-30" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-30"></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-31" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-31" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-31"></a>            <span class="k">return</span> <span class="n">arg</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-32" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-32" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-32"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-33" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-33" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-33"></a>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-34" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-34" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-34"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"getarg"</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-35" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-35" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-35"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-36" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-36" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-36"></a>        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-37" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-37" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-37"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Object</span><span class="p">()</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-38" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-38" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-38"></a>        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"load"</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-39" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-39" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-39"></a>            <span class="n">fieldnum</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-40" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-40" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-40"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">argval</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fieldnum</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-41" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-41" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-41"></a>        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"store"</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-42" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-42" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-42"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">argval</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-43" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-43" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-43"></a>            <span class="n">fieldnum</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-44" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-44" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-44"></a>            <span class="n">fieldvalue</span> <span class="o">=</span> <span class="n">argval</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-45" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-45" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-45"></a>            <span class="n">obj</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">fieldnum</span><span class="p">,</span> <span class="n">fieldvalue</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-46" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-46" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-46"></a>            <span class="c1"># no result, only side effect</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-47" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-47" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-47"></a>            <span class="k">continue</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-48" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-48" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-48"></a>        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"print"</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-49" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-49" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-49"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">argval</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-50" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-50" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-50"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-51" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-51" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-51"></a>            <span class="k">return</span> <span class="n">res</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-52" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-52" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-52"></a>        <span class="k">else</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-53" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-53" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-53"></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-54" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-54" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-54"></a>                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> not supported"</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-55" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-55" href="toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-55"></a>        <span class="n">op</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">res</span>
</pre></div>
<p>The interpreter  walks the operations of a block, executing each one in turn. It
uses the <code class="docutils literal">info</code> field to store the result of each already executed
<code class="docutils literal">Operation</code>. In this interpreter sketch we stop at the first <code class="docutils literal">print</code> that
we execute and return its argument for the simple but bad reason that it makes
<code class="docutils literal">test_interpret</code> easier to write.</p>
<p>Objects in the interpreter are represented using a class <code class="docutils literal">Object</code>, which
stores the object's field into a Python dictionary. As written above, this is a
simplification, in a real system the <cite>alloc</cite> operation might for example take
some kind of type as an argument, that describes which kinds of fields an
object has and how they are laid out in memory, which would allow more
efficient storage of the content. But we don't want to care about this level of
detail in the post, so using a dict in the interpreter is good enough.</p>
</section><section id="version-1-naive-attempt"><h2>Version 1: Naive Attempt<a href="#version-1-naive-attempt" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>In many programs, some allocated objects don't live for very long and have a
completely predictable lifetime. They get allocated, used for a while, and then
there is no way to reference them any more, so the garbage collector will
reclaim them. The very first example block had such an allocation:</p>
<pre class="literal-block">var0 = getarg(0)
obj0 = alloc()
store(obj0, 0, var0)
var1 = load(obj0, 0)
print(var1)</pre>
<p>Here <code class="docutils literal">obj0</code> is written to, then read from, and then it's no longer used. We
want to optimize such programs to remove this <code class="docutils literal">alloc</code> operation. The optimized
version of this program would look like this:</p>
<pre class="literal-block">var0 = getarg(0)
print(var0)</pre>
<p>The <code class="docutils literal">alloc</code>, <code class="docutils literal">store</code> and <code class="docutils literal">load</code> operations have been completely removed.
This is a pretty important optimizations for PyPy's JIT: Allocations, memory
reads and writes are quite costly and occur <em>a lot</em> in Python, so getting rid
of as many of them as possible is instrumental for performance.</p>
<p>Implementing the optimization is not a lot of code! However, understanding all
the corner cases of the
optimization and making sure that the resulting program behave correctly is not
completely trivial. Therefore we will develop the optimization step by step, in
a test driven fashion: I will start each section with a new test that shows a
bug in the version of the optimization that we have so far.</p>
<p>Let's start in a really naive way. Here's the first test we would like to
pass, using the example program above:</p>
<div class="code"><pre class="code python"><a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-1" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-1" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-1"></a><span class="k">def</span> <span class="nf">test_remove_unused_allocation</span><span class="p">():</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-2" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-2" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-3" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-3" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-4" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-4" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-4"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-5" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-5" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-5"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-6" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-6" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-6"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-7" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-7" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-7"></a>    <span class="n">bb</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-8" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-8" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-8"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-9" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-9" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-9"></a>    <span class="c1"># the virtual object looks like this:</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-10" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-10" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-10"></a>    <span class="c1">#  obj</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-11" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-11" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-11"></a>    <span class="c1"># ┌──────────┐</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-12" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-12" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-12"></a>    <span class="c1"># │ 0: var0  │</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-13" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-13" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-13"></a>    <span class="c1"># └──────────┘</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-14" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-14" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-14"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-15" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-15" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-15"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-16" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-16" href="toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-16"></a><span class="s2">optvar1 = print(optvar0)"""</span>
</pre></div>
<p>We will define a class <code class="docutils literal">VirtualObject</code> that is basically identical to
<code class="docutils literal">Object</code> above. But it will not be used by the interpreter, instead we will
use it during optimization.</p>
<div class="code"><pre class="code python"><a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-1" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-1" href="toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-1"></a><span class="k">class</span> <span class="nc">VirtualObject</span><span class="p">:</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-2" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-2" href="toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-3" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-3" href="toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-4" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-4" href="toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-4"></a>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-5" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-5" href="toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-5"></a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-6" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-6" href="toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-7" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-7" href="toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-7"></a>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-8" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-8" href="toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-8"></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-9" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-9" href="toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-9"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</pre></div>
<p>The structure of the optimizer is going to be like those in the first blog post.
The optimizer makes a single pass over all operations. It removes some and
emits others.</p>
<p>This first version of the allocation removal optimizer is going to be extremely
optimistic. It simply assumes that <em>all</em> the allocations in the program can be
optimized away. That is not realistic in practice. We will have to
refine this approach later, but it's a good way to start. That means whenever
the optimizer sees an <code class="docutils literal">alloc</code> operation, it removes it and creates a
<code class="docutils literal">VirtualObject</code> object which stores the information that is known during
optimization about the result of the <code class="docutils literal">alloc</code>. Like in the interpreter, the
<code class="docutils literal">VirtualObject</code> is stored in the <code class="docutils literal">.info</code> field of the <code class="docutils literal">Operation</code> instance
that represents the <code class="docutils literal">alloc</code>.</p>
<p>When the optimizer sees a <code class="docutils literal">store</code> operation, it will also remove it and
instead execute the store by calling the <code class="docutils literal">VirtualObject.store</code> method.
Here is one important difference between the interpreter and the optimizer: In
the interpreter, the values that were stored into an <code class="docutils literal">Object</code> (and thus
put into the object's <code class="docutils literal">.contents</code> dictionary) were runtime values, for
example integers or other objects. In the optimizer however, the
fields of the <code class="docutils literal">VirtualObject</code> store <code class="docutils literal">Value</code> instances, either <code class="docutils literal">Constant</code>
instances or <code class="docutils literal">Operation</code> instances.</p>
<p>When the optimizer sees a <code class="docutils literal">load</code> operation, it <em>also</em> removes it, and replaces
the <code class="docutils literal">load</code> with the <code class="docutils literal">Operation</code> (or <code class="docutils literal">Constant</code>) that is stored in the
<code class="docutils literal">VirtualObject</code> at that point:</p>
<div class="code"><pre class="code python"><a id="rest_code_3272498ce285485698127a1bcb985796-1" name="rest_code_3272498ce285485698127a1bcb985796-1" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-1"></a><span class="k">def</span> <span class="nf">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-2" name="rest_code_3272498ce285485698127a1bcb985796-2" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-3" name="rest_code_3272498ce285485698127a1bcb985796-3" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-3"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-4" name="rest_code_3272498ce285485698127a1bcb985796-4" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-4"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span><span class="p">:</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-5" name="rest_code_3272498ce285485698127a1bcb985796-5" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-5"></a>            <span class="n">op</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">VirtualObject</span><span class="p">()</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-6" name="rest_code_3272498ce285485698127a1bcb985796-6" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-6"></a>            <span class="k">continue</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-7" name="rest_code_3272498ce285485698127a1bcb985796-7" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-7"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"load"</span><span class="p">:</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-8" name="rest_code_3272498ce285485698127a1bcb985796-8" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-8"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-9" name="rest_code_3272498ce285485698127a1bcb985796-9" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-9"></a>            <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-10" name="rest_code_3272498ce285485698127a1bcb985796-10" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-10"></a>            <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-11" name="rest_code_3272498ce285485698127a1bcb985796-11" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-11"></a>            <span class="k">continue</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-12" name="rest_code_3272498ce285485698127a1bcb985796-12" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-12"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"store"</span><span class="p">:</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-13" name="rest_code_3272498ce285485698127a1bcb985796-13" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-13"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-14" name="rest_code_3272498ce285485698127a1bcb985796-14" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-14"></a>            <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-15" name="rest_code_3272498ce285485698127a1bcb985796-15" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-15"></a>            <span class="n">info</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-16" name="rest_code_3272498ce285485698127a1bcb985796-16" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-16"></a>            <span class="k">continue</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-17" name="rest_code_3272498ce285485698127a1bcb985796-17" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-17"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-18" name="rest_code_3272498ce285485698127a1bcb985796-18" href="toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-18"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
</pre></div>
<p>This is the first version of the optimization. It doesn't handle all kinds of
difficult cases, and we'll have to do something about its optimism.
But, already in this minimalistic form, we can write a slightly more complicated
test with two allocations, one object pointing to the other. It works correctly
too, both allocations are removed:</p>
<div class="code"><pre class="code python"><a id="rest_code_741d7a376c38438398deb1b590d35c07-1" name="rest_code_741d7a376c38438398deb1b590d35c07-1" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-1"></a><span class="k">def</span> <span class="nf">test_remove_two_allocations</span><span class="p">():</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-2" name="rest_code_741d7a376c38438398deb1b590d35c07-2" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-3" name="rest_code_741d7a376c38438398deb1b590d35c07-3" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-4" name="rest_code_741d7a376c38438398deb1b590d35c07-4" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-4"></a>    <span class="n">obj0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-5" name="rest_code_741d7a376c38438398deb1b590d35c07-5" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-5"></a>    <span class="n">sto1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-6" name="rest_code_741d7a376c38438398deb1b590d35c07-6" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-6"></a>    <span class="n">obj1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-7" name="rest_code_741d7a376c38438398deb1b590d35c07-7" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-7"></a>    <span class="n">sto2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj0</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-8" name="rest_code_741d7a376c38438398deb1b590d35c07-8" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-8"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-9" name="rest_code_741d7a376c38438398deb1b590d35c07-9" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-9"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-10" name="rest_code_741d7a376c38438398deb1b590d35c07-10" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-10"></a>    <span class="n">bb</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">var2</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-11" name="rest_code_741d7a376c38438398deb1b590d35c07-11" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-11"></a>    <span class="c1"># the virtual objects look like this:</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-12" name="rest_code_741d7a376c38438398deb1b590d35c07-12" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-12"></a>    <span class="c1">#  obj0</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-13" name="rest_code_741d7a376c38438398deb1b590d35c07-13" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-13"></a>    <span class="c1"># ┌──────┐</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-14" name="rest_code_741d7a376c38438398deb1b590d35c07-14" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-14"></a>    <span class="c1"># │ 0: ╷ │</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-15" name="rest_code_741d7a376c38438398deb1b590d35c07-15" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-15"></a>    <span class="c1"># └────┼─┘</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-16" name="rest_code_741d7a376c38438398deb1b590d35c07-16" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-16"></a>    <span class="c1">#      │</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-17" name="rest_code_741d7a376c38438398deb1b590d35c07-17" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-17"></a>    <span class="c1">#      ▼</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-18" name="rest_code_741d7a376c38438398deb1b590d35c07-18" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-18"></a>    <span class="c1">#     obj1</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-19" name="rest_code_741d7a376c38438398deb1b590d35c07-19" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-19"></a>    <span class="c1">#   ┌─────────┐</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-20" name="rest_code_741d7a376c38438398deb1b590d35c07-20" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-20"></a>    <span class="c1">#   │ 0: var0 │</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-21" name="rest_code_741d7a376c38438398deb1b590d35c07-21" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-21"></a>    <span class="c1">#   └─────────┘</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-22" name="rest_code_741d7a376c38438398deb1b590d35c07-22" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-22"></a>    <span class="c1"># therefore</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-23" name="rest_code_741d7a376c38438398deb1b590d35c07-23" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-23"></a>    <span class="c1"># var1 is the same as obj0</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-24" name="rest_code_741d7a376c38438398deb1b590d35c07-24" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-24"></a>    <span class="c1"># var2 is the same as var0</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-25" name="rest_code_741d7a376c38438398deb1b590d35c07-25" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-25"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-26" name="rest_code_741d7a376c38438398deb1b590d35c07-26" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-26"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-27" name="rest_code_741d7a376c38438398deb1b590d35c07-27" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-27"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-28" name="rest_code_741d7a376c38438398deb1b590d35c07-28" href="toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-28"></a><span class="s2">optvar1 = print(optvar0)"""</span>
</pre></div>
</section><section id="version-2-re-materializing-allocations"><h2>Version 2: Re-Materializing Allocations<a href="#version-2-re-materializing-allocations" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>To make it easier to talk about how the optimizer operates, let's introduce
some terminology. As already seen by the choice
of the class name <code class="docutils literal">VirtualObject</code>, we will call an object <strong>virtual</strong> if the
optimizer has optimized away the <code class="docutils literal">alloc</code> operation that creates the object.
Other objects are equivalently <strong>not virtual</strong>, for example those that have
existed before we enter the current code block.</p>
<p>The first problem that we need to fix is the assumption that every
allocation can be removed. So far we only looked at small programs where every
allocation could be removed, or equivalently, where every object is virtual.
A program that creates virtual objects, stores into and loads from them, and
then forgets the objects. In this simple case removing the allocations is fine.
As we saw in the previous section, it's also fine to have a virtual object
reference another virtual, both allocations can be removed.</p>
<p>What are the cases were we <em>can't</em> remove an allocation?
The first version of the optimizer simply assumed that every allocation can be
removed. This can't work. We will replace this assumption with the following
simple heuristic:</p>
<p>If a reference to a virtual object <code class="docutils literal">a</code> is stored into an object <code class="docutils literal">b</code>
that is not virtual, then <code class="docutils literal">a</code> will also stop being virtual. If an object <code class="docutils literal">a</code>
that was virtual stops being virtual, we say that it <strong>escapes</strong>. <a class="reference internal" href="toy-optimizer-allocation-removal.html#target-4">¹</a></p>
<p>The simplest test case for this happening looks like this:</p>
<div class="code"><pre class="code python"><a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-1" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-1" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-1"></a><span class="k">def</span> <span class="nf">test_materialize</span><span class="p">():</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-2" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-2" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-3" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-3" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-4" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-4" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-4"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-5" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-5" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-5"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-6" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-6" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-6"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-7" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-7" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-7"></a>    <span class="c1">#  obj is virtual, without any fields</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-8" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-8" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-8"></a>    <span class="c1"># ┌───────┐</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-9" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-9" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-9"></a>    <span class="c1"># │ empty │</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-10" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-10" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-10"></a>    <span class="c1"># └───────┘</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-11" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-11" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-11"></a>    <span class="c1"># then we store a reference to obj into</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-12" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-12" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-12"></a>    <span class="c1"># field 0 of var0. Since var0 is not virtual,</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-13" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-13" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-13"></a>    <span class="c1"># obj escapes, so we have to put it back</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-14" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-14" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-14"></a>    <span class="c1"># into the optimized basic block</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-15" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-15" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-15"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-16" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-16" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-16"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-17" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-17" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-17"></a><span class="s2">optvar1 = alloc()</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-18" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-18" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-18"></a><span class="s2">optvar2 = store(optvar0, 0, optvar1)"""</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-19" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-19" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-19"></a>    <span class="c1"># so far, fails like this:</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-20" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-20" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-20"></a>    <span class="c1"># the line:</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-21" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-21" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-21"></a>    <span class="c1"># info.store(field, op.arg(2))</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-22" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-22" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-22"></a>    <span class="c1"># produces an AttributeError because info</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-23" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-23" href="toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-23"></a>    <span class="c1"># is None</span>
</pre></div>
<p>If the optimizer reaches a point where a virtual object escapes (like the
<code class="docutils literal">store</code> operation in the test), the optimizer has already removed the <code class="docutils literal">alloc</code>
operation that created the virtual object. If the object escapes, we don't want
to go back in the operations list and re-insert the <code class="docutils literal">alloc</code> operation, that
sounds potentially very complicated. Instead, we re-insert the <code class="docutils literal">alloc</code>
operation that will recreate the virtual object at the point of escape using a
helper function <code class="docutils literal">materialize</code>.</p>
<div class="code"><pre class="code python"><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-1" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-1" href="toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-1"></a><span class="hll"><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-2" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-2" href="toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-2"></a><span class="hll">    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-3" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-3" href="toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-3"></a><span class="hll">    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-4" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-4" href="toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-4"></a><span class="hll">    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-5" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-5" href="toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-5"></a><span class="hll">    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">VirtualObject</span><span class="p">)</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-6" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-6" href="toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-6"></a><span class="hll">    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-7" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-7" href="toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-7"></a><span class="hll">    <span class="c1"># put the alloc operation back into the trace</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-8" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-8" href="toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-8"></a><span class="hll">    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></pre></div>
<p>I've added a number of fairly strong assertions to <code class="docutils literal">materialize</code> to encode our
current assumptions about the situations in which it expects to be called. We
will remove some of them later as we generalize the code.</p>
<p>Now that we have <code class="docutils literal">materialize</code> we need to change <code class="docutils literal">optimize_alloc_removal</code> to
recognize the case of storing a virtual object into a non-virtual one. We can
recognize <code class="docutils literal">Operation</code> instances that produced a virtual object by looking at
their <code class="docutils literal">.info</code> field. If it is <code class="docutils literal">None</code>, the object is not virtual, otherwise
it is. If we store something into a virtual object, we leave the code as above.
If we store a virtual object into an object that is not virtual, we will first
materialize the virtual object, and then emit the store.</p>
<div class="code"><pre class="code python"><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-1" name="rest_code_b615420c2cef4c14913ec23f92b9899a-1" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-1"></a><span class="k">def</span> <span class="nf">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-2" name="rest_code_b615420c2cef4c14913ec23f92b9899a-2" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-3" name="rest_code_b615420c2cef4c14913ec23f92b9899a-3" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-3"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-4" name="rest_code_b615420c2cef4c14913ec23f92b9899a-4" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-4"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span><span class="p">:</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-5" name="rest_code_b615420c2cef4c14913ec23f92b9899a-5" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-5"></a>            <span class="n">op</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">VirtualObject</span><span class="p">()</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-6" name="rest_code_b615420c2cef4c14913ec23f92b9899a-6" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-6"></a>            <span class="k">continue</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-7" name="rest_code_b615420c2cef4c14913ec23f92b9899a-7" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-7"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"load"</span><span class="p">:</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-8" name="rest_code_b615420c2cef4c14913ec23f92b9899a-8" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-8"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-9" name="rest_code_b615420c2cef4c14913ec23f92b9899a-9" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-9"></a>            <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-10" name="rest_code_b615420c2cef4c14913ec23f92b9899a-10" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-10"></a>            <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-11" name="rest_code_b615420c2cef4c14913ec23f92b9899a-11" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-11"></a>            <span class="k">continue</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-12" name="rest_code_b615420c2cef4c14913ec23f92b9899a-12" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-12"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"store"</span><span class="p">:</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-13" name="rest_code_b615420c2cef4c14913ec23f92b9899a-13" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-13"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-14" name="rest_code_b615420c2cef4c14913ec23f92b9899a-14" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-14"></a><span class="hll">            <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="c1"># virtual</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-15" name="rest_code_b615420c2cef4c14913ec23f92b9899a-15" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-15"></a><span class="hll">                <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-16" name="rest_code_b615420c2cef4c14913ec23f92b9899a-16" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-16"></a><span class="hll">                <span class="n">info</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-17" name="rest_code_b615420c2cef4c14913ec23f92b9899a-17" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-17"></a><span class="hll">                <span class="k">continue</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-18" name="rest_code_b615420c2cef4c14913ec23f92b9899a-18" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-18"></a><span class="hll">            <span class="k">else</span><span class="p">:</span> <span class="c1"># not virtual</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-19" name="rest_code_b615420c2cef4c14913ec23f92b9899a-19" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-19"></a><span class="hll">                <span class="c1"># first materialize the</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-20" name="rest_code_b615420c2cef4c14913ec23f92b9899a-20" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-20"></a><span class="hll">                <span class="c1"># right hand side</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-21" name="rest_code_b615420c2cef4c14913ec23f92b9899a-21" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-21"></a><span class="hll">                <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-22" name="rest_code_b615420c2cef4c14913ec23f92b9899a-22" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-22"></a><span class="hll">                <span class="c1"># then emit the store via</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-23" name="rest_code_b615420c2cef4c14913ec23f92b9899a-23" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-23"></a><span class="hll">                <span class="c1"># the general path below</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-24" name="rest_code_b615420c2cef4c14913ec23f92b9899a-24" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-24"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-25" name="rest_code_b615420c2cef4c14913ec23f92b9899a-25" href="toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-25"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
</pre></div>
<p>This is the general idea, and it is enough to pass <code class="docutils literal">test_materialize</code>. But of
course there are still a number of further problems that we now need to solve.</p>
</section><section id="version-3-don-t-materialize-twice"><h2>Version 3: Don't Materialize Twice<a href="#version-3-don-t-materialize-twice" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>The first problem is the fact that after we materialize a virtual object, it is
no longer virtual. So if it escapes a second time, it should <em>not</em> be
materialized a second time. A test for that case could simply repeat the
<code class="docutils literal">store</code> operation:</p>
<div class="code"><pre class="code python"><a id="rest_code_ec0c737e38534b24a97f90a407cac041-1" name="rest_code_ec0c737e38534b24a97f90a407cac041-1" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-1"></a><span class="k">def</span> <span class="nf">test_dont_materialize_twice</span><span class="p">():</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-2" name="rest_code_ec0c737e38534b24a97f90a407cac041-2" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-2"></a>    <span class="c1"># obj is again an empty virtual object,</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-3" name="rest_code_ec0c737e38534b24a97f90a407cac041-3" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-3"></a>    <span class="c1"># and we store it into var0 *twice*.</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-4" name="rest_code_ec0c737e38534b24a97f90a407cac041-4" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-4"></a>    <span class="c1"># this should only materialize it once</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-5" name="rest_code_ec0c737e38534b24a97f90a407cac041-5" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-5"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-6" name="rest_code_ec0c737e38534b24a97f90a407cac041-6" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-6"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-7" name="rest_code_ec0c737e38534b24a97f90a407cac041-7" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-7"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-8" name="rest_code_ec0c737e38534b24a97f90a407cac041-8" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-8"></a>    <span class="n">sto0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-9" name="rest_code_ec0c737e38534b24a97f90a407cac041-9" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-9"></a>    <span class="n">sto1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-10" name="rest_code_ec0c737e38534b24a97f90a407cac041-10" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-10"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-11" name="rest_code_ec0c737e38534b24a97f90a407cac041-11" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-11"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-12" name="rest_code_ec0c737e38534b24a97f90a407cac041-12" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-12"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-13" name="rest_code_ec0c737e38534b24a97f90a407cac041-13" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-13"></a><span class="s2">optvar1 = alloc()</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-14" name="rest_code_ec0c737e38534b24a97f90a407cac041-14" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-14"></a><span class="s2">optvar2 = store(optvar0, 0, optvar1)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-15" name="rest_code_ec0c737e38534b24a97f90a407cac041-15" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-15"></a><span class="s2">optvar3 = store(optvar0, 0, optvar1)"""</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-16" name="rest_code_ec0c737e38534b24a97f90a407cac041-16" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-16"></a>    <span class="c1"># fails so far: the operations that we get</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-17" name="rest_code_ec0c737e38534b24a97f90a407cac041-17" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-17"></a>    <span class="c1"># at the moment are:</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-18" name="rest_code_ec0c737e38534b24a97f90a407cac041-18" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-18"></a>    <span class="c1"># optvar0 = getarg(0)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-19" name="rest_code_ec0c737e38534b24a97f90a407cac041-19" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-19"></a>    <span class="c1"># optvar1 = alloc()</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-20" name="rest_code_ec0c737e38534b24a97f90a407cac041-20" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-20"></a>    <span class="c1"># optvar2 = store(optvar0, 0, optvar1)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-21" name="rest_code_ec0c737e38534b24a97f90a407cac041-21" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-21"></a>    <span class="c1"># optvar3 = alloc()</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-22" name="rest_code_ec0c737e38534b24a97f90a407cac041-22" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-22"></a>    <span class="c1"># optvar4 = store(optvar0, 0, optvar3)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-23" name="rest_code_ec0c737e38534b24a97f90a407cac041-23" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-23"></a>    <span class="c1"># ie the object is materialized twice,</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-24" name="rest_code_ec0c737e38534b24a97f90a407cac041-24" href="toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-24"></a>    <span class="c1"># which is incorrect</span>
</pre></div>
<p>We solve the problem by setting the <code class="docutils literal">.info</code> field of an object that we
materialize to <code class="docutils literal">None</code> to mark it as no longer being virtual.</p>
<div class="code"><pre class="code python"><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-1" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-1" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-1"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-2" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-2" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-2"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-3" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-3" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-3"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-4" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-4" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-4"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-5" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-5" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-5"></a><span class="hll">    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-6" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-6" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-6"></a><span class="hll">        <span class="k">return</span> <span class="c1"># already materialized</span>
</span><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-7" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-7" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-7"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-8" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-8" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-8"></a><span class="hll">    <span class="c1"># put the alloc operation back into the trace</span>
</span><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-9" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-9" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-9"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-10" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-10" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-10"></a><span class="hll">    <span class="c1"># but only once</span>
</span><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-11" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-11" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-11"></a><span class="hll">    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
</span><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-12" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-12" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-12"></a>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-13" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-13" href="toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-13"></a><span class="c1"># optimize_alloc_removal unchanged</span>
</pre></div>
<p>This fixes the problem, only one <code class="docutils literal">alloc</code> is created. This fix also allows
another test case to pass, one where we store a non-virtual into another
non-virtual, code which we cannot optimize at all:</p>
<div class="code"><pre class="code python"><a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-1" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-1" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-1"></a><span class="k">def</span> <span class="nf">test_materialize_non_virtuals</span><span class="p">():</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-2" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-2" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-2"></a>    <span class="c1"># in this example we store a non-virtual var1</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-3" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-3" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-3"></a>    <span class="c1"># into another non-virtual var0</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-4" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-4" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-4"></a>    <span class="c1"># this should just lead to no optimization at</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-5" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-5" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-5"></a>    <span class="c1"># all</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-6" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-6" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-6"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-7" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-7" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-7"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-8" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-8" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-8"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-9" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-9" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-9"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-10" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-10" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-10"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-11" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-11" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-11"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-12" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-12" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-12"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-13" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-13" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-13"></a><span class="s2">optvar1 = getarg(1)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-14" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-14" href="toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-14"></a><span class="s2">optvar2 = store(optvar0, 0, optvar1)"""</span>
</pre></div>
</section><section id="version-4-materialization-of-constants"><h2>Version 4: Materialization of Constants<a href="#version-4-materialization-of-constants" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>Another straightforward extension is to support materializing constants. A
constant is never virtual, so materializing it should do nothing.</p>
<div class="code"><pre class="code python"><a id="rest_code_27099929a51a4e33ab16e089d44a86d4-1" name="rest_code_27099929a51a4e33ab16e089d44a86d4-1" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-1"></a><span class="k">def</span> <span class="nf">test_materialization_constants</span><span class="p">():</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-2" name="rest_code_27099929a51a4e33ab16e089d44a86d4-2" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-2"></a>    <span class="c1"># in this example we store the constant 17</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-3" name="rest_code_27099929a51a4e33ab16e089d44a86d4-3" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-3"></a>    <span class="c1"># into the non-virtual var0</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-4" name="rest_code_27099929a51a4e33ab16e089d44a86d4-4" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-4"></a>    <span class="c1"># again, this will not be optimized</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-5" name="rest_code_27099929a51a4e33ab16e089d44a86d4-5" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-5"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-6" name="rest_code_27099929a51a4e33ab16e089d44a86d4-6" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-6"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-7" name="rest_code_27099929a51a4e33ab16e089d44a86d4-7" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-7"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-8" name="rest_code_27099929a51a4e33ab16e089d44a86d4-8" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-8"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-9" name="rest_code_27099929a51a4e33ab16e089d44a86d4-9" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-9"></a>    <span class="c1"># the previous line fails so far, triggering</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-10" name="rest_code_27099929a51a4e33ab16e089d44a86d4-10" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-10"></a>    <span class="c1"># the assert:</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-11" name="rest_code_27099929a51a4e33ab16e089d44a86d4-11" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-11"></a>    <span class="c1"># assert not isinstance(value, Constant)</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-12" name="rest_code_27099929a51a4e33ab16e089d44a86d4-12" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-12"></a>    <span class="c1"># in materialize</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-13" name="rest_code_27099929a51a4e33ab16e089d44a86d4-13" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-13"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-14" name="rest_code_27099929a51a4e33ab16e089d44a86d4-14" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-14"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-15" name="rest_code_27099929a51a4e33ab16e089d44a86d4-15" href="toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-15"></a><span class="s2">optvar1 = store(optvar0, 0, 17)"""</span>
</pre></div>
<p>To implement that case, we check for <code class="docutils literal">value</code> being a constant and return
early:</p>
<div class="code"><pre class="code python"><a id="rest_code_387b06762c224ef5805901bb1d205045-1" name="rest_code_387b06762c224ef5805901bb1d205045-1" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-1"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-2" name="rest_code_387b06762c224ef5805901bb1d205045-2" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-2"></a><span class="hll">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
</span><a id="rest_code_387b06762c224ef5805901bb1d205045-3" name="rest_code_387b06762c224ef5805901bb1d205045-3" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-3"></a><span class="hll">        <span class="k">return</span>
</span><a id="rest_code_387b06762c224ef5805901bb1d205045-4" name="rest_code_387b06762c224ef5805901bb1d205045-4" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-4"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-5" name="rest_code_387b06762c224ef5805901bb1d205045-5" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-5"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-6" name="rest_code_387b06762c224ef5805901bb1d205045-6" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-6"></a>    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-7" name="rest_code_387b06762c224ef5805901bb1d205045-7" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-7"></a>        <span class="k">return</span> <span class="c1"># already materialized</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-8" name="rest_code_387b06762c224ef5805901bb1d205045-8" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-8"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-9" name="rest_code_387b06762c224ef5805901bb1d205045-9" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-9"></a>    <span class="c1"># put the alloc operation back into the trace</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-10" name="rest_code_387b06762c224ef5805901bb1d205045-10" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-10"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-11" name="rest_code_387b06762c224ef5805901bb1d205045-11" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-11"></a>    <span class="c1"># but only once</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-12" name="rest_code_387b06762c224ef5805901bb1d205045-12" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-12"></a>    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-13" name="rest_code_387b06762c224ef5805901bb1d205045-13" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-13"></a>
<a id="rest_code_387b06762c224ef5805901bb1d205045-14" name="rest_code_387b06762c224ef5805901bb1d205045-14" href="toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-14"></a><span class="c1"># optimize_alloc_removal unchanged</span>
</pre></div>
</section><section id="version-5-materializing-fields"><h2>Version 5: Materializing Fields<a href="#version-5-materializing-fields" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>Now we need to solve a more difficult problem. So far, the virtual objects that
we have materialized have all been empty, meaning they didn't have any fields
written to at the point of materialization. Let's write a test for this:</p>
<div class="code"><pre class="code python"><a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-1" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-1" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-1"></a><span class="k">def</span> <span class="nf">test_materialize_fields</span><span class="p">():</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-2" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-2" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-3" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-3" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-4" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-4" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-4"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-5" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-5" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-5"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-6" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-6" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-6"></a>    <span class="n">contents0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-7" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-7" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-7"></a>    <span class="n">contents1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-8" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-8" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-8"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-9" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-9" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-9"></a>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-10" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-10" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-10"></a>    <span class="c1"># the virtual obj looks like this</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-11" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-11" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-11"></a>    <span class="c1">#  obj</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-12" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-12" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-12"></a>    <span class="c1"># ┌──────┬──────────┐</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-13" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-13" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-13"></a>    <span class="c1"># │ 0: 8 │ 1: var1  │</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-14" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-14" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-14"></a>    <span class="c1"># └──────┴──────────┘</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-15" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-15" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-15"></a>    <span class="c1"># then it needs to be materialized</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-16" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-16" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-16"></a>    <span class="c1"># this is the first example where a virtual</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-17" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-17" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-17"></a>    <span class="c1"># object that we want to materialize has any</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-18" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-18" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-18"></a>    <span class="c1"># content and is not just an empty object</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-19" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-19" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-19"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-20" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-20" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-20"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-21" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-21" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-21"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-22" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-22" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-22"></a><span class="s2">optvar1 = getarg(1)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-23" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-23" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-23"></a><span class="s2">optvar2 = alloc()</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-24" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-24" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-24"></a><span class="s2">optvar3 = store(optvar2, 0, 8)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-25" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-25" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-25"></a><span class="s2">optvar4 = store(optvar2, 1, optvar1)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-26" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-26" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-26"></a><span class="s2">optvar5 = store(optvar0, 0, optvar2)"""</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-27" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-27" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-27"></a>    <span class="c1"># fails so far! the operations we get</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-28" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-28" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-28"></a>    <span class="c1"># at the moment are:</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-29" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-29" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-29"></a>    <span class="c1"># optvar0 = getarg(0)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-30" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-30" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-30"></a>    <span class="c1"># optvar1 = getarg(1)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-31" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-31" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-31"></a>    <span class="c1"># optvar2 = alloc()</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-32" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-32" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-32"></a>    <span class="c1"># optvar3 = store(optvar0, 0, optvar2)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-33" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-33" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-33"></a>    <span class="c1"># which is wrong, because the store operations</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-34" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-34" href="toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-34"></a>    <span class="c1"># into optvar1 got lost</span>
</pre></div>
<p>To fix this problem, we need to re-create a <code class="docutils literal">store</code> operation for every
element of the <code class="docutils literal">.contents</code> dictionary of the virtual object we are
materializing. <a class="reference internal" href="toy-optimizer-allocation-removal.html#target-5">²</a></p>
<div class="code"><pre class="code python"><a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-1" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-1" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-1"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-2" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-2" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-2"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-3" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-3" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-3"></a>        <span class="k">return</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-4" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-4" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-4"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-5" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-5" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-5"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-6" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-6" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-6"></a>    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-7" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-7" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-7"></a>        <span class="k">return</span> <span class="c1"># already materialized</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-8" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-8" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-8"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-9" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-9" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-9"></a>    <span class="c1"># put the alloc operation back into the trace</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-10" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-10" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-10"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-11" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-11" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-11"></a><span class="hll">    <span class="c1"># put the content back</span>
</span><a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-12" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-12" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-12"></a><span class="hll">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-13" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-13" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-13"></a><span class="hll">        <span class="c1"># re-create store operation</span>
</span><a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-14" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-14" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-14"></a><span class="hll">        <span class="n">opt_bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span><a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-15" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-15" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-15"></a>    <span class="c1"># only materialize once</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-16" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-16" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-16"></a>    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-17" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-17" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-17"></a>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-18" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-18" href="toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-18"></a><span class="c1"># optimize_alloc_removal unchanged</span>
</pre></div>
<p>This is enough to pass the test.</p>
</section><section id="version-6-recursive-materialization"><h2>Version 6: Recursive Materialization<a href="#version-6-recursive-materialization" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>In the above example, the fields of the virtual objects contained
only constants or non-virtual objects. However, we could have a situation where
a whole tree of virtual objects is built, and then the root of the tree escapes.
This makes it necessary to escape the whole tree. Let's write a test for a small
tree of two virtual objects:</p>
<div class="code"><pre class="code python"><a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-1" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-1" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-1"></a><span class="k">def</span> <span class="nf">test_materialize_chained_objects</span><span class="p">():</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-2" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-2" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-3" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-3" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-4" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-4" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-4"></a>    <span class="n">obj0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-5" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-5" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-5"></a>    <span class="n">obj1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-6" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-6" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-6"></a>    <span class="n">contents</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj1</span><span class="p">)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-7" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-7" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-7"></a>    <span class="n">const</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-8" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-8" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-8"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj0</span><span class="p">)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-9" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-9" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-9"></a>    <span class="c1">#  obj0</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-10" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-10" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-10"></a>    <span class="c1"># ┌──────┐</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-11" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-11" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-11"></a>    <span class="c1"># │ 0: ╷ │</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-12" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-12" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-12"></a>    <span class="c1"># └────┼─┘</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-13" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-13" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-13"></a>    <span class="c1">#      │</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-14" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-14" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-14"></a>    <span class="c1">#      ▼</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-15" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-15" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-15"></a>    <span class="c1">#     obj1</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-16" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-16" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-16"></a>    <span class="c1">#   ┌─────────┐</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-17" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-17" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-17"></a>    <span class="c1">#   │ 0: 1337 │</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-18" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-18" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-18"></a>    <span class="c1">#   └─────────┘</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-19" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-19" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-19"></a>    <span class="c1"># now obj0 escapes</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-20" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-20" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-20"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-21" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-21" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-21"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-22" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-22" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-22"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-23" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-23" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-23"></a><span class="s2">optvar1 = alloc()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-24" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-24" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-24"></a><span class="s2">optvar2 = alloc()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-25" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-25" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-25"></a><span class="s2">optvar3 = store(optvar2, 0, 1337)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-26" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-26" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-26"></a><span class="s2">optvar4 = store(optvar1, 0, optvar2)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-27" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-27" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-27"></a><span class="s2">optvar5 = store(optvar0, 0, optvar1)"""</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-28" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-28" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-28"></a>    <span class="c1"># fails in an annoying way! the resulting</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-29" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-29" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-29"></a>    <span class="c1"># basic block is not in proper SSA form</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-30" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-30" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-30"></a>    <span class="c1"># so printing it fails. The optimized</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-31" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-31" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-31"></a>    <span class="c1"># block would look like this:</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-32" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-32" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-32"></a>    <span class="c1"># optvar0 = getarg(0)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-33" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-33" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-33"></a>    <span class="c1"># optvar1 = alloc()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-34" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-34" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-34"></a>    <span class="c1"># optvar3 = store(optvar1, 0, optvar2)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-35" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-35" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-35"></a>    <span class="c1"># optvar4 = store(optvar0, 0, optvar1)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-36" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-36" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-36"></a>    <span class="c1"># where optvar2 is an ``alloc`` Operation</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-37" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-37" href="toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-37"></a>    <span class="c1"># that is not itself in the output block</span>
</pre></div>
<p>To fix it, <code class="docutils literal">materialize</code> needs to call itself recursively for all the field
values of the virtual object:</p>
<div class="code"><pre class="code python"><a id="rest_code_27177a34a73544cc9837c917f98bbb95-1" name="rest_code_27177a34a73544cc9837c917f98bbb95-1" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-1"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-2" name="rest_code_27177a34a73544cc9837c917f98bbb95-2" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-2"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-3" name="rest_code_27177a34a73544cc9837c917f98bbb95-3" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-3"></a>        <span class="k">return</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-4" name="rest_code_27177a34a73544cc9837c917f98bbb95-4" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-4"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-5" name="rest_code_27177a34a73544cc9837c917f98bbb95-5" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-5"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-6" name="rest_code_27177a34a73544cc9837c917f98bbb95-6" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-6"></a>    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-7" name="rest_code_27177a34a73544cc9837c917f98bbb95-7" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-7"></a>        <span class="k">return</span> <span class="c1"># already materialized</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-8" name="rest_code_27177a34a73544cc9837c917f98bbb95-8" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-8"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-9" name="rest_code_27177a34a73544cc9837c917f98bbb95-9" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-9"></a>    <span class="c1"># put the alloc operation back into the trace</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-10" name="rest_code_27177a34a73544cc9837c917f98bbb95-10" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-10"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-11" name="rest_code_27177a34a73544cc9837c917f98bbb95-11" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-11"></a>    <span class="c1"># put the content back</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-12" name="rest_code_27177a34a73544cc9837c917f98bbb95-12" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-12"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-13" name="rest_code_27177a34a73544cc9837c917f98bbb95-13" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-13"></a><span class="hll">        <span class="c1"># materialize recursively</span>
</span><a id="rest_code_27177a34a73544cc9837c917f98bbb95-14" name="rest_code_27177a34a73544cc9837c917f98bbb95-14" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-14"></a><span class="hll">        <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span><a id="rest_code_27177a34a73544cc9837c917f98bbb95-15" name="rest_code_27177a34a73544cc9837c917f98bbb95-15" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-15"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-16" name="rest_code_27177a34a73544cc9837c917f98bbb95-16" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-16"></a>    <span class="c1"># only materialize once</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-17" name="rest_code_27177a34a73544cc9837c917f98bbb95-17" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-17"></a>    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-18" name="rest_code_27177a34a73544cc9837c917f98bbb95-18" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-18"></a>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-19" name="rest_code_27177a34a73544cc9837c917f98bbb95-19" href="toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-19"></a><span class="c1"># optimize_alloc_removal unchanged</span>
</pre></div>
<p>Getting there, the materialization logic is almost done. We need to fix a
subtle remaining problem though.</p>
</section><section id="version-7-dealing-with-object-cycles"><h2>Version 7: Dealing with Object Cycles<a href="#version-7-dealing-with-object-cycles" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>The bug we need to fix in this section is a bit tricky, and does not immediately
occur in a lot of programs. In
fact, in PyPy a variant of it was hiding out in our optimizer
until we found it much later (despite us being aware of the general problem and
correctly dealing with it in other cases).</p>
<p>The problem is this: a virtual object can (directly or indirectly) point to
itself, and we must carefully deal with that case to avoid infinite recursion in
<code class="docutils literal">materialize</code>. Here's the simplest test:</p>
<div class="code"><pre class="code python"><a id="rest_code_4a6b175045e848a28837f4e538cec11b-1" name="rest_code_4a6b175045e848a28837f4e538cec11b-1" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-1"></a><span class="k">def</span> <span class="nf">test_object_graph_cycles</span><span class="p">():</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-2" name="rest_code_4a6b175045e848a28837f4e538cec11b-2" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-3" name="rest_code_4a6b175045e848a28837f4e538cec11b-3" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-4" name="rest_code_4a6b175045e848a28837f4e538cec11b-4" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-4"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-5" name="rest_code_4a6b175045e848a28837f4e538cec11b-5" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-5"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-6" name="rest_code_4a6b175045e848a28837f4e538cec11b-6" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-6"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-7" name="rest_code_4a6b175045e848a28837f4e538cec11b-7" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-7"></a>    <span class="c1">#   ┌────────┐</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-8" name="rest_code_4a6b175045e848a28837f4e538cec11b-8" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-8"></a>    <span class="c1">#   ▼        │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-9" name="rest_code_4a6b175045e848a28837f4e538cec11b-9" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-9"></a>    <span class="c1">#  obj0      │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-10" name="rest_code_4a6b175045e848a28837f4e538cec11b-10" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-10"></a>    <span class="c1"># ┌──────┐   │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-11" name="rest_code_4a6b175045e848a28837f4e538cec11b-11" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-11"></a>    <span class="c1"># │ 0: ╷ │   │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-12" name="rest_code_4a6b175045e848a28837f4e538cec11b-12" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-12"></a>    <span class="c1"># └────┼─┘   │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-13" name="rest_code_4a6b175045e848a28837f4e538cec11b-13" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-13"></a>    <span class="c1">#      │     │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-14" name="rest_code_4a6b175045e848a28837f4e538cec11b-14" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-14"></a>    <span class="c1">#      └─────┘</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-15" name="rest_code_4a6b175045e848a28837f4e538cec11b-15" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-15"></a>    <span class="c1"># obj0 points to itself, and then it is</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-16" name="rest_code_4a6b175045e848a28837f4e538cec11b-16" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-16"></a>    <span class="c1"># escaped</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-17" name="rest_code_4a6b175045e848a28837f4e538cec11b-17" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-17"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-18" name="rest_code_4a6b175045e848a28837f4e538cec11b-18" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-18"></a>    <span class="c1"># the previous line fails with an</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-19" name="rest_code_4a6b175045e848a28837f4e538cec11b-19" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-19"></a>    <span class="c1"># InfiniteRecursionError</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-20" name="rest_code_4a6b175045e848a28837f4e538cec11b-20" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-20"></a>    <span class="c1"># materialize calls itself, infinitely</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-21" name="rest_code_4a6b175045e848a28837f4e538cec11b-21" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-21"></a>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-22" name="rest_code_4a6b175045e848a28837f4e538cec11b-22" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-22"></a>    <span class="c1"># what we want is instead this output:</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-23" name="rest_code_4a6b175045e848a28837f4e538cec11b-23" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-23"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-24" name="rest_code_4a6b175045e848a28837f4e538cec11b-24" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-24"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-25" name="rest_code_4a6b175045e848a28837f4e538cec11b-25" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-25"></a><span class="s2">optvar1 = alloc()</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-26" name="rest_code_4a6b175045e848a28837f4e538cec11b-26" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-26"></a><span class="s2">optvar2 = store(optvar1, 0, optvar1)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-27" name="rest_code_4a6b175045e848a28837f4e538cec11b-27" href="toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-27"></a><span class="s2">optvar3 = store(optvar0, 1, optvar1)"""</span>
</pre></div>
<p>The fix is not a big change, but a little bit subtle nevertheless.
We have to change the
order in which things are done in <code class="docutils literal">materialize</code>. Right after emitting the
<code class="docutils literal">alloc</code>, we set the <code class="docutils literal">.info</code> to <code class="docutils literal">None</code>, to mark the object as not virtual.
Only <em>afterwards</em> do we re-create the stores and call <code class="docutils literal">materialize</code> recursively.
If a recursive call reaches the same object, it's already marked as non-virtual,
so <code class="docutils literal">materialize</code> won't recurse further:</p>
<div class="code"><pre class="code python"><a id="rest_code_dddc53240ddd40529a69442d80c5471d-1" name="rest_code_dddc53240ddd40529a69442d80c5471d-1" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-1"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-2" name="rest_code_dddc53240ddd40529a69442d80c5471d-2" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-2"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-3" name="rest_code_dddc53240ddd40529a69442d80c5471d-3" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-3"></a>        <span class="k">return</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-4" name="rest_code_dddc53240ddd40529a69442d80c5471d-4" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-4"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-5" name="rest_code_dddc53240ddd40529a69442d80c5471d-5" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-5"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-6" name="rest_code_dddc53240ddd40529a69442d80c5471d-6" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-6"></a>    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-7" name="rest_code_dddc53240ddd40529a69442d80c5471d-7" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-7"></a>        <span class="k">return</span> <span class="c1"># already materialized</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-8" name="rest_code_dddc53240ddd40529a69442d80c5471d-8" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-8"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-9" name="rest_code_dddc53240ddd40529a69442d80c5471d-9" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-9"></a>    <span class="c1"># put the alloc operation back into the trace</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-10" name="rest_code_dddc53240ddd40529a69442d80c5471d-10" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-10"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-11" name="rest_code_dddc53240ddd40529a69442d80c5471d-11" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-11"></a><span class="hll">    <span class="c1"># only materialize once</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-12" name="rest_code_dddc53240ddd40529a69442d80c5471d-12" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-12"></a><span class="hll">    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-13" name="rest_code_dddc53240ddd40529a69442d80c5471d-13" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-13"></a><span class="hll">    <span class="c1"># put the content back</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-14" name="rest_code_dddc53240ddd40529a69442d80c5471d-14" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-14"></a><span class="hll">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-15" name="rest_code_dddc53240ddd40529a69442d80c5471d-15" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-15"></a><span class="hll">        <span class="c1"># materialize recursively</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-16" name="rest_code_dddc53240ddd40529a69442d80c5471d-16" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-16"></a><span class="hll">        <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-17" name="rest_code_dddc53240ddd40529a69442d80c5471d-17" href="toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-17"></a><span class="hll">        <span class="n">opt_bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></pre></div>
</section><section id="version-8-loading-from-non-virtual-objects"><h2>Version 8: Loading from non-virtual objects<a href="#version-8-loading-from-non-virtual-objects" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>Now materialize is done. We need to go back to <code class="docutils literal">optimize_alloc_removal</code> and
improve it further. The last time we changed it, we added a case analysis to the
code dealing with <code class="docutils literal">store</code>, distinguishing between storing to a virtual and to
a non-virtual object. We need to add an equivalent distinction to the <code class="docutils literal">load</code>
case, because right now loading from a non-virtual crashes.</p>
<div class="code"><pre class="code python"><a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-1" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-1" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-1"></a><span class="k">def</span> <span class="nf">test_load_non_virtual</span><span class="p">():</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-2" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-2" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-3" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-3" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-4" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-4" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-4"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-5" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-5" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-5"></a>    <span class="n">bb</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-6" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-6" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-6"></a>    <span class="c1"># the next line fails in the line</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-7" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-7" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-7"></a>    <span class="c1"># op.make_equal_to(info.load(field))</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-8" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-8" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-8"></a>    <span class="c1"># because info is None</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-9" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-9" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-9"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-10" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-10" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-10"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-11" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-11" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-11"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-12" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-12" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-12"></a><span class="s2">optvar1 = load(optvar0, 0)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-13" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-13" href="toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-13"></a><span class="s2">optvar2 = print(optvar1)"""</span>
</pre></div>
<p>To fix it, we split the <code class="docutils literal">load</code> code into two cases, leaving the virtual path
as before, and letting the <code class="docutils literal">load</code> from a non-virtual fall through to the
general code at the end of the function.</p>
<div class="code"><pre class="code python"><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-1" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-1" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-1"></a><span class="k">def</span> <span class="nf">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-2" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-2" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-3" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-3" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-3"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-4" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-4" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-4"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span><span class="p">:</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-5" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-5" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-5"></a>            <span class="n">op</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">VirtualObject</span><span class="p">()</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-6" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-6" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-6"></a>            <span class="k">continue</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-7" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-7" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-7"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"load"</span><span class="p">:</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-8" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-8" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-8"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-9" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-9" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-9"></a><span class="hll">            <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="c1"># virtual</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-10" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-10" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-10"></a><span class="hll">                <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-11" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-11" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-11"></a><span class="hll">                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-12" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-12" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-12"></a><span class="hll">                <span class="k">continue</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-13" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-13" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-13"></a><span class="hll">            <span class="c1"># otherwise not virtual, use the</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-14" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-14" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-14"></a><span class="hll">            <span class="c1"># general path below</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-15" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-15" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-15"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"store"</span><span class="p">:</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-16" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-16" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-16"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-17" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-17" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-17"></a>            <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="c1"># virtual</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-18" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-18" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-18"></a>                <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-19" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-19" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-19"></a>                <span class="n">info</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-20" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-20" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-20"></a>                <span class="k">continue</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-21" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-21" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-21"></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># not virtual</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-22" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-22" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-22"></a>                <span class="c1"># first materialize the</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-23" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-23" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-23"></a>                <span class="c1"># right hand side</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-24" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-24" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-24"></a>                <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-25" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-25" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-25"></a>                <span class="c1"># then emit the store via</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-26" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-26" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-26"></a>                <span class="c1"># the general path below</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-27" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-27" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-27"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-28" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-28" href="toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-28"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
</pre></div>
</section><section id="version-9-final-materialize-on-other-operations"><h2>Version 9 (Final): Materialize on Other Operations<a href="#version-9-final-materialize-on-other-operations" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>We're almost at the end now. There's one final generalization left to do. We
started with the heuristic that storing a virtual into a non-virtual would
escape it. This should be generalized. Every time we pass a virtual into any
operation where it is not the first argument of a <code class="docutils literal">load</code> and a <code class="docutils literal">store</code>
should also escape it (imagine passing the virtual to some function call).
Let's test this as usual with our <code class="docutils literal">print</code> operation:</p>
<div class="code"><pre class="code python"><a id="rest_code_9e2666b30d6345dc9df789b2327ad059-1" name="rest_code_9e2666b30d6345dc9df789b2327ad059-1" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-1"></a><span class="k">def</span> <span class="nf">test_materialize_on_other_ops</span><span class="p">():</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-2" name="rest_code_9e2666b30d6345dc9df789b2327ad059-2" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-2"></a>    <span class="c1"># materialize not just on store</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-3" name="rest_code_9e2666b30d6345dc9df789b2327ad059-3" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-3"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-4" name="rest_code_9e2666b30d6345dc9df789b2327ad059-4" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-4"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-5" name="rest_code_9e2666b30d6345dc9df789b2327ad059-5" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-5"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-6" name="rest_code_9e2666b30d6345dc9df789b2327ad059-6" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-6"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-7" name="rest_code_9e2666b30d6345dc9df789b2327ad059-7" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-7"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-8" name="rest_code_9e2666b30d6345dc9df789b2327ad059-8" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-8"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-9" name="rest_code_9e2666b30d6345dc9df789b2327ad059-9" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-9"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-10" name="rest_code_9e2666b30d6345dc9df789b2327ad059-10" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-10"></a><span class="s2">optvar1 = alloc()</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-11" name="rest_code_9e2666b30d6345dc9df789b2327ad059-11" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-11"></a><span class="s2">optvar2 = print(optvar1)"""</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-12" name="rest_code_9e2666b30d6345dc9df789b2327ad059-12" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-12"></a>    <span class="c1"># again, the resulting basic block is not in</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-13" name="rest_code_9e2666b30d6345dc9df789b2327ad059-13" href="toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-13"></a>    <span class="c1"># valid SSA form</span>
</pre></div>
<p>To fix this, we will take the call to <code class="docutils literal">materialize</code> out of the <code class="docutils literal">store</code> code
path and instead put it into the generic code path the end of the <code class="docutils literal">while</code>
loop:</p>
<div class="code"><pre class="code python"><a id="rest_code_b308a95053064308bea999d5bcf1d83e-1" name="rest_code_b308a95053064308bea999d5bcf1d83e-1" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-1"></a><span class="c1"># materialize is unchanged</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-2" name="rest_code_b308a95053064308bea999d5bcf1d83e-2" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-2"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-3" name="rest_code_b308a95053064308bea999d5bcf1d83e-3" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-3"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-4" name="rest_code_b308a95053064308bea999d5bcf1d83e-4" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-4"></a>        <span class="k">return</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-5" name="rest_code_b308a95053064308bea999d5bcf1d83e-5" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-5"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-6" name="rest_code_b308a95053064308bea999d5bcf1d83e-6" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-6"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-7" name="rest_code_b308a95053064308bea999d5bcf1d83e-7" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-7"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-8" name="rest_code_b308a95053064308bea999d5bcf1d83e-8" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-8"></a>        <span class="c1"># Already materialized</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-9" name="rest_code_b308a95053064308bea999d5bcf1d83e-9" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-9"></a>        <span class="k">return</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-10" name="rest_code_b308a95053064308bea999d5bcf1d83e-10" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-10"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-11" name="rest_code_b308a95053064308bea999d5bcf1d83e-11" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-11"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-12" name="rest_code_b308a95053064308bea999d5bcf1d83e-12" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-12"></a>    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-13" name="rest_code_b308a95053064308bea999d5bcf1d83e-13" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-13"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-14" name="rest_code_b308a95053064308bea999d5bcf1d83e-14" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-14"></a>        <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-15" name="rest_code_b308a95053064308bea999d5bcf1d83e-15" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-15"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-16" name="rest_code_b308a95053064308bea999d5bcf1d83e-16" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-16"></a>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-17" name="rest_code_b308a95053064308bea999d5bcf1d83e-17" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-17"></a><span class="k">def</span> <span class="nf">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-18" name="rest_code_b308a95053064308bea999d5bcf1d83e-18" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-18"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-19" name="rest_code_b308a95053064308bea999d5bcf1d83e-19" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-19"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-20" name="rest_code_b308a95053064308bea999d5bcf1d83e-20" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-20"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-21" name="rest_code_b308a95053064308bea999d5bcf1d83e-21" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-21"></a>            <span class="n">op</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">VirtualObject</span><span class="p">()</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-22" name="rest_code_b308a95053064308bea999d5bcf1d83e-22" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-22"></a>            <span class="k">continue</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-23" name="rest_code_b308a95053064308bea999d5bcf1d83e-23" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-23"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"load"</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-24" name="rest_code_b308a95053064308bea999d5bcf1d83e-24" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-24"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-25" name="rest_code_b308a95053064308bea999d5bcf1d83e-25" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-25"></a>            <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="c1"># virtual</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-26" name="rest_code_b308a95053064308bea999d5bcf1d83e-26" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-26"></a>                <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-27" name="rest_code_b308a95053064308bea999d5bcf1d83e-27" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-27"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-28" name="rest_code_b308a95053064308bea999d5bcf1d83e-28" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-28"></a>                <span class="k">continue</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-29" name="rest_code_b308a95053064308bea999d5bcf1d83e-29" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-29"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"store"</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-30" name="rest_code_b308a95053064308bea999d5bcf1d83e-30" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-30"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-31" name="rest_code_b308a95053064308bea999d5bcf1d83e-31" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-31"></a>            <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="c1"># virtual</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-32" name="rest_code_b308a95053064308bea999d5bcf1d83e-32" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-32"></a>                <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-33" name="rest_code_b308a95053064308bea999d5bcf1d83e-33" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-33"></a>                <span class="n">info</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-34" name="rest_code_b308a95053064308bea999d5bcf1d83e-34" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-34"></a>                <span class="k">continue</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-35" name="rest_code_b308a95053064308bea999d5bcf1d83e-35" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-35"></a><span class="hll">        <span class="c1"># materialize all the arguments of</span>
</span><a id="rest_code_b308a95053064308bea999d5bcf1d83e-36" name="rest_code_b308a95053064308bea999d5bcf1d83e-36" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-36"></a><span class="hll">        <span class="c1"># operations that are put into the</span>
</span><a id="rest_code_b308a95053064308bea999d5bcf1d83e-37" name="rest_code_b308a95053064308bea999d5bcf1d83e-37" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-37"></a><span class="hll">        <span class="c1"># output basic block</span>
</span><a id="rest_code_b308a95053064308bea999d5bcf1d83e-38" name="rest_code_b308a95053064308bea999d5bcf1d83e-38" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-38"></a><span class="hll">        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
</span><a id="rest_code_b308a95053064308bea999d5bcf1d83e-39" name="rest_code_b308a95053064308bea999d5bcf1d83e-39" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-39"></a><span class="hll">            <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">())</span>
</span><a id="rest_code_b308a95053064308bea999d5bcf1d83e-40" name="rest_code_b308a95053064308bea999d5bcf1d83e-40" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-40"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-41" name="rest_code_b308a95053064308bea999d5bcf1d83e-41" href="toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-41"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
</pre></div>
<p>That's it, we're done. It's not a lot of code, but actually quite a powerful
optimization. In addition to removing allocations for objects that are only used
briefly and in predictable ways, it also has another effect. If an object is
allocated, used in a number of operations and then escapes further down in the
block, the operations in between can often be optimized away. This is
demonstrated by the next test (which already passes):</p>
<div class="code"><pre class="code python"><a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-1" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-1" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-1"></a><span class="k">def</span> <span class="nf">test_sink_allocations</span><span class="p">():</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-2" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-2" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-3" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-3" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-4" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-4" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-4"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-5" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-5" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-5"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-6" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-6" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-6"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">456</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-7" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-7" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-7"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-8" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-8" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-8"></a>    <span class="n">var5</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-9" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-9" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-9"></a>    <span class="n">var6</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var4</span><span class="p">,</span> <span class="n">var5</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-10" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-10" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-10"></a>    <span class="n">var7</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var6</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-11" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-11" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-11"></a>    <span class="n">var8</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-12" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-12" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-12"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-13" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-13" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-13"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-14" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-14" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-14"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-15" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-15" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-15"></a><span class="s2">optvar1 = add(123, 456)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-16" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-16" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-16"></a><span class="s2">optvar2 = alloc()</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-17" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-17" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-17"></a><span class="s2">optvar3 = store(optvar2, 0, optvar1)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-18" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-18" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-18"></a><span class="s2">optvar4 = store(optvar2, 1, 456)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-19" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-19" href="toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-19"></a><span class="s2">optvar5 = store(optvar0, 1, optvar2)"""</span>
</pre></div>
<p>Note that the addition is not optimized away, because the code from this blog
post does not contain constant folding and the other optimizations from
the last one. Combining them would not be too hard though.</p>
</section><section id="conclusion"><h2>Conclusion<a href="#conclusion" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>That's it! The core idea of PyPy's allocation removal optimization in one or
two screens of code. The real implementation has a number of refinements,
but the core ideas are all here.</p>
<p>I'm not going to show any benchmark numbers or anything like that here, if you
are interested in numbers you could look at the evaluation Section 6.
"Implementation and Evaluation" of the <a class="reference external" href="https://www3.hhu.de/stups/downloads/pdf/BoCuFiLePeRi2011.pdf">paper</a> that describes the work.</p>
<p>There's a complementary optimization that improves <code class="docutils literal">load</code> and <code class="docutils literal">store</code>
operations for objects that are <em>not</em> virtual. I'll probably not write that
down as another post, but <a class="reference external" href="https://bernsteinbear.com/">Max Bernstein</a> and I developed that together on a
<a class="reference external" href="twitch.tv/pypyproject">PyPy Twitch channel</a> channel a few weeks ago, here's the recording:</p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/w-UHg0yOPSE" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></section><section id="footnotes"><h2>Footnotes<a href="#footnotes" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p id="target-4">¹ This is how PyPy uses the terminology, not really used consistently by other
projects. The term "escape" is fairly standard throughout the <a class="reference external" href="https://en.wikipedia.org/wiki/Escape_analysis">escape
analysis</a> literature. The term "virtual" was used originally in <a class="reference external" href="https://dl.acm.org/doi/abs/10.1145/1014007.1014010">Armin Rigo's
Psyco</a> but is e.g. also used by the paper <a class="reference external" href="https://www.ssw.uni-linz.ac.at/Research/Papers/Stadler14/Stadler2014-CGO-PEA.pdf">Partial Escape Analysis and Scalar
Replacement for Java</a>.</p>
<p id="target-5">² The order in which we put the <cite>store</cite> operations back is relying on
dictionary iteration order, which is insertion order. That's not a bad
ordering, we could also be explicit and sort the fields in some order (ideally
the order in which the object lays them out in memory).</p>
</section>
</div>
      <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/toy-optimizer.html" rel="tag">toy-optimizer</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../07/ddorf-sprint-sep-2022.html" rel="prev" title="Düsseldorf HPy/PyPy/GraalPy sprint September 19-23rd 2022">Previous post</a>
            </li>
            <li class="next">
                <a href="blog-15-years.html" rel="next" title="The PyPy Blog Turns 15 Years">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                      <div data-title="Allocation Removal in the Toy Optimizer" id="utterances-thread"></div>
        <script src="https://utteranc.es/client.js" repo="pypy/pypy.org" issue-term="title" label="Comments" theme="github-light" crossorigin="anonymous"></script></section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2024/08/portaone.html" class="listtitle">Guest Post: How PortaOne uses PyPy for high-performance processing, connecting over 1B of phone calls every month</a>
      </li>
      <li>
        <a href="/posts/2024/08/pypy-v7317-release.html" class="listtitle">PyPy v7.3.17 release</a>
      </li>
      <li>
        <a href="/posts/2024/08/conda-forge-proposes-dropping-support-for-pypy.html" class="listtitle">Conda-forge proposes sunsetting support for PyPy</a>
      </li>
      <li>
        <a href="/posts/2024/08/toy-knownbits.html" class="listtitle">A Knownbits Abstract Domain for the Toy Optimizer, Correctly</a>
      </li>
      <li>
        <a href="/posts/2024/07/toy-abstract-interpretation.html" class="listtitle">Abstract interpretation in the Toy Optimizer</a>
      </li>
      <li>
        <a href="/posts/2024/07/mining-jit-traces-missing-optimizations-z3.html" class="listtitle">Mining JIT traces for missing optimizations with Z3</a>
      </li>
      <li>
        <a href="/posts/2024/07/finding-simple-rewrite-rules-jit-z3.html" class="listtitle">Finding Simple Rewrite Rules for the JIT with Z3</a>
      </li>
      <li>
        <a href="/posts/2024/05/vmprof-firefox-converter.html" class="listtitle">Profiling PyPy using the Firefox profiler user interface</a>
      </li>
      <li>
        <a href="/posts/2024/04/pypy-v7316-release.html" class="listtitle">PyPy v7.3.16 release</a>
      </li>
      <li>
        <a href="/posts/2024/03/fixing-bug-incremental-gc.html" class="listtitle">Fixing a Bug in PyPy's Incremental GC</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (11)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (1)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (1)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (22)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (4)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (62)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (4)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (3)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2024 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2024-08-30T08:28
  </div>
  <div style="margin-left: auto">
  <a href="../../../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>