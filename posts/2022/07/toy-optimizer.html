<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Implementing a Toy Optimizer | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2022/07/toy-optimizer.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../../assets/css/tipuesearch.css">
<meta name="author" content="Carl Friedrich Bolz-Tereick">
<link rel="prev" href="../04/how-is-pypy-tested.html" title="How is PyPy Tested?" type="text/html">
<link rel="next" href="m1-support-for-pypy.html" title="M1 support for PyPy" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Implementing a Toy Optimizer">
<meta property="og:url" content="https://www.pypy.org/posts/2022/07/toy-optimizer.html">
<meta property="og:description" content="In this blog post I want to show the complete code (in Python3) of how a very
simple optimizer for sequences of operations can work. These algorithms could
be part of a (really simple) compiler, or a ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-07-19T12:00:00Z">
<meta property="article:tag" content="toy-optimizer">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog/">Index</a> </li>  
                    <li> <a href="../../../categories/">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://twitter.com/pypyproject">Twitter</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../../../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../../../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><article class="post-rest h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Implementing a Toy Optimizer</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2022-07-19T12:00:00Z" itemprop="datePublished" title="2022-07-19 12:00">2022-07-19 12:00</time></a>
            </p>
            
                <p class="commentline">            <a href="toy-optimizer.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>In this blog post I want to show the complete code (in Python3) of how a very
simple optimizer for sequences of operations can work. These algorithms could
be part of a (really simple) compiler, or a JIT. The architecture of the code in
this blog post is very similar to that of the trace optimizer of the PyPy JIT:
After a trace is produced, is is optimized before being sent to the machine code
backend that produces binary instructions for the CPU architecture that PyPy is
running on.</p>
<p>To get started, the first thing we need to do is define how our operations are
stored. The
format that a compiler uses to store the program while it is being optimized
is usually called its <a class="reference external" href="https://en.wikipedia.org/wiki/Intermediate_representation">intermediate representation</a> (IR). Many production
compilers use IRs that are in the <a class="reference external" href="https://en.wikipedia.org/wiki/Static_single-assignment_form">Static Single-Assignment Form</a> (SSA), and
we will also use that. SSA form has the property that every variable is
assigned to exactly once, and every variable is defined before it is used. This
simplifies many things.</p>
<p>Let's make this concrete. If our input program is a complex expressions, such
as <code class="docutils literal">a * (b + 17) + (b + 17)</code> the intermediate representation of that (or at
least its text representation) would maybe be something like:</p>
<pre class="literal-block">var1 = add(b, 17)
var2 = mul(a, var1)
var3 = add(b, 17)
var4 = add(var2, var3)</pre>
<p>This sequence of instructions is inefficient. The operation <code class="docutils literal">add(b, 17)</code> is
computed twice and we can save time by removing the second one and only
computing it once. In this post I want to show an optimizer that can do this
(and some related) optimizations.</p>
<p>Looking at the IR we notice that the input expression has been linearized
into a sequence of operations, and all the intermedia results have been given
unique variable names. The value that every variable is assigned is computed
by the right hand side, which is some operation consisting of an operand and an
arbitrary number of arguments. The arguments of an operation are either
themselves variables or constants.</p>
<p>I will not at all talk about the process of translating the input program
into the IR. Instead, I will assume we have some component that does this
translation already. The tests in this blog post will construct small
snippets of IR by hand. I also won't talk about what happens after the
optimization (usually the optimized IR is translated into machine code).</p>
<section id="implementing-the-intermediate-representation"><h2>Implementing the Intermediate Representation<a href="#implementing-the-intermediate-representation" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>Let's start modelling the intermediate representation with Python classes.
First we define a base class of all values that can be used as arguments in
operations, and let's also add a class that represents constants:</p>
<div class="code"><pre class="code python"><a id="rest_code_43fa72b7696748e29a198375c3bb2215-1" name="rest_code_43fa72b7696748e29a198375c3bb2215-1" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-1"></a><span class="kn">import</span> <span class="nn">pytest</span>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-2" name="rest_code_43fa72b7696748e29a198375c3bb2215-2" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-2"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-3" name="rest_code_43fa72b7696748e29a198375c3bb2215-3" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-3"></a>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-4" name="rest_code_43fa72b7696748e29a198375c3bb2215-4" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-4"></a><span class="k">class</span> <span class="nc">Value</span><span class="p">:</span>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-5" name="rest_code_43fa72b7696748e29a198375c3bb2215-5" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-5"></a>    <span class="k">pass</span>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-6" name="rest_code_43fa72b7696748e29a198375c3bb2215-6" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-6"></a>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-7" name="rest_code_43fa72b7696748e29a198375c3bb2215-7" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-7"></a><span class="k">class</span> <span class="nc">Constant</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-8" name="rest_code_43fa72b7696748e29a198375c3bb2215-8" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-8"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-9" name="rest_code_43fa72b7696748e29a198375c3bb2215-9" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-10" name="rest_code_43fa72b7696748e29a198375c3bb2215-10" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-10"></a>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-11" name="rest_code_43fa72b7696748e29a198375c3bb2215-11" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-11"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_43fa72b7696748e29a198375c3bb2215-12" name="rest_code_43fa72b7696748e29a198375c3bb2215-12" href="toy-optimizer.html#rest_code_43fa72b7696748e29a198375c3bb2215-12"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Constant(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)"</span>
</pre></div>
<p>One consequence of the fact that every variable is assigned to only once is
that variables are in a one-to-one correspondence with the right-hand-side of
their unique assignments. That means that we don't need a class that represents
variables at all. Instead, it's sufficient to have a class that represents an
operation (the right-hand side), and that by definition is the same as the variable (left-hand side) that it defines:</p>
<div class="code"><pre class="code python"><a id="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-1" name="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-1" href="toy-optimizer.html#rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-1"></a><span class="k">class</span> <span class="nc">Operation</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-2" name="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-2" href="toy-optimizer.html#rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Value</span><span class="p">]):</span>
<a id="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-3" name="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-3" href="toy-optimizer.html#rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-4" name="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-4" href="toy-optimizer.html#rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
<a id="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-5" name="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-5" href="toy-optimizer.html#rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-5"></a>
<a id="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-6" name="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-6" href="toy-optimizer.html#rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-6"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-7" name="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-7" href="toy-optimizer.html#rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-7"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Operation(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-8" name="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-8" href="toy-optimizer.html#rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-8"></a>
<a id="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-9" name="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-9" href="toy-optimizer.html#rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-9"></a>    <span class="k">def</span> <span class="nf">arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-10" name="rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-10" href="toy-optimizer.html#rest_code_eb13cf09b2754be09629d1d0ac4e6f1d-10"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></div>
<p>Now we can instantiate these two classes to represent the example sequence of
operations above:</p>
<div class="code"><pre class="code python"><a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-1" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-1" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-1"></a><span class="k">def</span> <span class="nf">test_construct_example</span><span class="p">():</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-2" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-2" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-2"></a>    <span class="c1"># first we need something to represent</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-3" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-3" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-3"></a>    <span class="c1"># "a" and "b". In our limited view, we don't</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-4" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-4" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-4"></a>    <span class="c1"># know where they come from, so we will define</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-5" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-5" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-5"></a>    <span class="c1"># them with a pseudo-operation called "getarg"</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-6" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-6" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-6"></a>    <span class="c1"># which takes a number n as an argument and</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-7" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-7" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-7"></a>    <span class="c1"># returns the n-th input argument. The proper</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-8" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-8" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-8"></a>    <span class="c1"># SSA way to do this would be phi-nodes.</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-9" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-9" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-9"></a>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-10" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-10" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-10"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"getarg"</span><span class="p">,</span> <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-11" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-11" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-11"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"getarg"</span><span class="p">,</span> <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-12" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-12" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-12"></a>    <span class="c1"># var1 = add(b, 17)</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-13" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-13" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-13"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)])</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-14" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-14" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-14"></a>    <span class="c1"># var2 = mul(a, var1)</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-15" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-15" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-15"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"mul"</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">var1</span><span class="p">])</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-16" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-16" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-16"></a>    <span class="c1"># var3 = add(b, 17)</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-17" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-17" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-17"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)])</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-18" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-18" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-18"></a>    <span class="c1"># var4 = add(var2, var3)</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-19" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-19" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-19"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="p">[</span><span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">])</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-20" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-20" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-20"></a>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-21" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-21" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-21"></a>    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">,</span> <span class="n">var4</span><span class="p">]</span>
<a id="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-22" name="rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-22" href="toy-optimizer.html#rest_code_36f7fc0fe2fb433bb1fc9d368644ad4f-22"></a>    <span class="c1"># nothing to test really, it shouldn't crash</span>
</pre></div>
<p>Usually, complicated programs are represented as a <a class="reference external" href="https://en.wikipedia.org/wiki/Control-flow_graph">control flow graph</a> in a
compiler, which represents all the possible paths that control can take while
executing the program. Every node in the control flow graph is a <a class="reference external" href="https://en.wikipedia.org/wiki/Basic_block">basic
block</a>. A basic block is a linear sequence of operations with no control flow
inside of it.</p>
<p>When optimizing a program, a compiler usually looks at the whole control flow
graph of a function. However, that is still too complicated! So let's
simplify further and look at only at optimizations we can do when looking at
a single basic block and its sequence of instructions (they are called local
optimizations).</p>
<p>Let's define a class representing basic blocks and let's also add some
convenience functions for constructing sequences of operations, because the
code in <code class="docutils literal">test_construct_example</code> is a bit annoying.</p>
<div class="code"><pre class="code python"><a id="rest_code_cbfaeb4179f140bf919dce1d33148822-1" name="rest_code_cbfaeb4179f140bf919dce1d33148822-1" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-1"></a><span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-2" name="rest_code_cbfaeb4179f140bf919dce1d33148822-2" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-2"></a>    <span class="k">def</span> <span class="nf">opbuilder</span><span class="p">(</span><span class="n">opname</span><span class="p">):</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-3" name="rest_code_cbfaeb4179f140bf919dce1d33148822-3" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-3"></a>        <span class="k">def</span> <span class="nf">wraparg</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-4" name="rest_code_cbfaeb4179f140bf919dce1d33148822-4" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-4"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-5" name="rest_code_cbfaeb4179f140bf919dce1d33148822-5" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-5"></a>                <span class="n">arg</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-6" name="rest_code_cbfaeb4179f140bf919dce1d33148822-6" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-6"></a>            <span class="k">return</span> <span class="n">arg</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-7" name="rest_code_cbfaeb4179f140bf919dce1d33148822-7" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-7"></a>        <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-8" name="rest_code_cbfaeb4179f140bf919dce1d33148822-8" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-8"></a>            <span class="c1"># construct an Operation, wrap the</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-9" name="rest_code_cbfaeb4179f140bf919dce1d33148822-9" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-9"></a>            <span class="c1"># arguments in Constants if necessary</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-10" name="rest_code_cbfaeb4179f140bf919dce1d33148822-10" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-10"></a>            <span class="n">op</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="n">opname</span><span class="p">,</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-11" name="rest_code_cbfaeb4179f140bf919dce1d33148822-11" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-11"></a>                <span class="p">[</span><span class="n">wraparg</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-12" name="rest_code_cbfaeb4179f140bf919dce1d33148822-12" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-12"></a>            <span class="c1"># add it to self, the basic block</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-13" name="rest_code_cbfaeb4179f140bf919dce1d33148822-13" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-14" name="rest_code_cbfaeb4179f140bf919dce1d33148822-14" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-14"></a>            <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-15" name="rest_code_cbfaeb4179f140bf919dce1d33148822-15" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-15"></a>        <span class="k">return</span> <span class="n">build</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-16" name="rest_code_cbfaeb4179f140bf919dce1d33148822-16" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-16"></a>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-17" name="rest_code_cbfaeb4179f140bf919dce1d33148822-17" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-17"></a>    <span class="c1"># a bunch of operations we support</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-18" name="rest_code_cbfaeb4179f140bf919dce1d33148822-18" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-18"></a>    <span class="n">add</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"add"</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-19" name="rest_code_cbfaeb4179f140bf919dce1d33148822-19" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-19"></a>    <span class="n">mul</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"mul"</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-20" name="rest_code_cbfaeb4179f140bf919dce1d33148822-20" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-20"></a>    <span class="n">getarg</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"getarg"</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-21" name="rest_code_cbfaeb4179f140bf919dce1d33148822-21" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-21"></a>    <span class="n">dummy</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"dummy"</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-22" name="rest_code_cbfaeb4179f140bf919dce1d33148822-22" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-22"></a>    <span class="n">lshift</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"lshift"</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-23" name="rest_code_cbfaeb4179f140bf919dce1d33148822-23" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-23"></a>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-24" name="rest_code_cbfaeb4179f140bf919dce1d33148822-24" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-24"></a><span class="k">def</span> <span class="nf">test_convencience_block_construction</span><span class="p">():</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-25" name="rest_code_cbfaeb4179f140bf919dce1d33148822-25" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-25"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-26" name="rest_code_cbfaeb4179f140bf919dce1d33148822-26" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-26"></a>    <span class="c1"># a again with getarg, the following line</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-27" name="rest_code_cbfaeb4179f140bf919dce1d33148822-27" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-27"></a>    <span class="c1"># defines the Operation instance and</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-28" name="rest_code_cbfaeb4179f140bf919dce1d33148822-28" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-28"></a>    <span class="c1"># immediately adds it to the basic block bb</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-29" name="rest_code_cbfaeb4179f140bf919dce1d33148822-29" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-29"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-30" name="rest_code_cbfaeb4179f140bf919dce1d33148822-30" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-30"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-31" name="rest_code_cbfaeb4179f140bf919dce1d33148822-31" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-31"></a>    <span class="k">assert</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"getarg"</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-32" name="rest_code_cbfaeb4179f140bf919dce1d33148822-32" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-32"></a>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-33" name="rest_code_cbfaeb4179f140bf919dce1d33148822-33" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-33"></a>    <span class="c1"># it's a Constant</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-34" name="rest_code_cbfaeb4179f140bf919dce1d33148822-34" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-34"></a>    <span class="k">assert</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-35" name="rest_code_cbfaeb4179f140bf919dce1d33148822-35" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-35"></a>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-36" name="rest_code_cbfaeb4179f140bf919dce1d33148822-36" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-36"></a>    <span class="c1"># b with getarg</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-37" name="rest_code_cbfaeb4179f140bf919dce1d33148822-37" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-37"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-38" name="rest_code_cbfaeb4179f140bf919dce1d33148822-38" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-38"></a>    <span class="c1"># var1 = add(b, 17)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-39" name="rest_code_cbfaeb4179f140bf919dce1d33148822-39" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-39"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-40" name="rest_code_cbfaeb4179f140bf919dce1d33148822-40" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-40"></a>    <span class="c1"># var2 = mul(a, var1)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-41" name="rest_code_cbfaeb4179f140bf919dce1d33148822-41" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-41"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-42" name="rest_code_cbfaeb4179f140bf919dce1d33148822-42" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-42"></a>    <span class="c1"># var3 = add(b, 17)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-43" name="rest_code_cbfaeb4179f140bf919dce1d33148822-43" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-43"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-44" name="rest_code_cbfaeb4179f140bf919dce1d33148822-44" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-44"></a>    <span class="c1"># var4 = add(var2, var3)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-45" name="rest_code_cbfaeb4179f140bf919dce1d33148822-45" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-45"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">)</span>
<a id="rest_code_cbfaeb4179f140bf919dce1d33148822-46" name="rest_code_cbfaeb4179f140bf919dce1d33148822-46" href="toy-optimizer.html#rest_code_cbfaeb4179f140bf919dce1d33148822-46"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
</pre></div>
<p>That's a good bit of infrastructure to make the tests easy to write. One
thing we are lacking though is a way to print the basic blocks into a nicely
readable textual representation. Because in the current form, the <code class="docutils literal">repr</code> of a
Block is very annoying, the output of pretty-printing <code class="docutils literal">bb</code> in the test above
looks like this:</p>
<div class="code"><pre class="code python"><a id="rest_code_51778a3ebc444b6985c332963813ea50-1" name="rest_code_51778a3ebc444b6985c332963813ea50-1" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-1"></a><span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span> <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-2" name="rest_code_51778a3ebc444b6985c332963813ea50-2" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-2"></a> <span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span> <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-3" name="rest_code_51778a3ebc444b6985c332963813ea50-3" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-3"></a> <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-4" name="rest_code_51778a3ebc444b6985c332963813ea50-4" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-4"></a>           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-5" name="rest_code_51778a3ebc444b6985c332963813ea50-5" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-5"></a>                      <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-6" name="rest_code_51778a3ebc444b6985c332963813ea50-6" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-6"></a>                 <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-7" name="rest_code_51778a3ebc444b6985c332963813ea50-7" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-7"></a> <span class="n">Operation</span><span class="p">(</span><span class="s1">'mul'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-8" name="rest_code_51778a3ebc444b6985c332963813ea50-8" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-8"></a>           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-9" name="rest_code_51778a3ebc444b6985c332963813ea50-9" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-9"></a>                      <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-10" name="rest_code_51778a3ebc444b6985c332963813ea50-10" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-10"></a>                 <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-11" name="rest_code_51778a3ebc444b6985c332963813ea50-11" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-11"></a>                           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-12" name="rest_code_51778a3ebc444b6985c332963813ea50-12" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-12"></a>                                      <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-13" name="rest_code_51778a3ebc444b6985c332963813ea50-13" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-13"></a>                            <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)])]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-14" name="rest_code_51778a3ebc444b6985c332963813ea50-14" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-14"></a> <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-15" name="rest_code_51778a3ebc444b6985c332963813ea50-15" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-15"></a>           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-16" name="rest_code_51778a3ebc444b6985c332963813ea50-16" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-16"></a>                      <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-17" name="rest_code_51778a3ebc444b6985c332963813ea50-17" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-17"></a>            <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-18" name="rest_code_51778a3ebc444b6985c332963813ea50-18" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-18"></a> <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-19" name="rest_code_51778a3ebc444b6985c332963813ea50-19" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-19"></a>           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'mul'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-20" name="rest_code_51778a3ebc444b6985c332963813ea50-20" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-20"></a>                       <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-21" name="rest_code_51778a3ebc444b6985c332963813ea50-21" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-21"></a>                                  <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-22" name="rest_code_51778a3ebc444b6985c332963813ea50-22" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-22"></a>                             <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-23" name="rest_code_51778a3ebc444b6985c332963813ea50-23" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-23"></a>                                       <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-24" name="rest_code_51778a3ebc444b6985c332963813ea50-24" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-24"></a>                                                  <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-25" name="rest_code_51778a3ebc444b6985c332963813ea50-25" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-25"></a>                                        <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)])]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-26" name="rest_code_51778a3ebc444b6985c332963813ea50-26" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-26"></a>                 <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-27" name="rest_code_51778a3ebc444b6985c332963813ea50-27" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-27"></a>                           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-28" name="rest_code_51778a3ebc444b6985c332963813ea50-28" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-28"></a>                                           <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_51778a3ebc444b6985c332963813ea50-29" name="rest_code_51778a3ebc444b6985c332963813ea50-29" href="toy-optimizer.html#rest_code_51778a3ebc444b6985c332963813ea50-29"></a>                                 <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)])])]</span>
</pre></div>
<p>It's impossible to see what is going on here, because the <code class="docutils literal">Operations</code> in the
basic block appear several times, once as elements of the list but then also as
arguments to operations further down in the list. So we need some code that
turns things back into a readable textual representation, so we have a chance
to debug.</p>
<div class="code"><pre class="code python"><a id="rest_code_fc33e910c81344d982b2e748d21e2e92-1" name="rest_code_fc33e910c81344d982b2e748d21e2e92-1" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-1"></a><span class="k">def</span> <span class="nf">bb_to_str</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">,</span> <span class="n">varprefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"var"</span><span class="p">):</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-2" name="rest_code_fc33e910c81344d982b2e748d21e2e92-2" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-2"></a>    <span class="c1"># the implementation is not too important,</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-3" name="rest_code_fc33e910c81344d982b2e748d21e2e92-3" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-3"></a>    <span class="c1"># look at the test below to see what the</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-4" name="rest_code_fc33e910c81344d982b2e748d21e2e92-4" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-4"></a>    <span class="c1"># result looks like</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-5" name="rest_code_fc33e910c81344d982b2e748d21e2e92-5" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-5"></a>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-6" name="rest_code_fc33e910c81344d982b2e748d21e2e92-6" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-6"></a>    <span class="k">def</span> <span class="nf">arg_to_str</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-7" name="rest_code_fc33e910c81344d982b2e748d21e2e92-7" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-7"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-8" name="rest_code_fc33e910c81344d982b2e748d21e2e92-8" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-8"></a>            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-9" name="rest_code_fc33e910c81344d982b2e748d21e2e92-9" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-9"></a>        <span class="k">else</span><span class="p">:</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-10" name="rest_code_fc33e910c81344d982b2e748d21e2e92-10" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-10"></a>            <span class="c1"># the key must exist, otherwise it's</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-11" name="rest_code_fc33e910c81344d982b2e748d21e2e92-11" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-11"></a>            <span class="c1"># not a valid SSA basic block:</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-12" name="rest_code_fc33e910c81344d982b2e748d21e2e92-12" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-12"></a>            <span class="c1"># the variable must be defined before</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-13" name="rest_code_fc33e910c81344d982b2e748d21e2e92-13" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-13"></a>            <span class="c1"># its first use</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-14" name="rest_code_fc33e910c81344d982b2e748d21e2e92-14" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-14"></a>            <span class="k">return</span> <span class="n">varnames</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-15" name="rest_code_fc33e910c81344d982b2e748d21e2e92-15" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-15"></a>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-16" name="rest_code_fc33e910c81344d982b2e748d21e2e92-16" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-16"></a>    <span class="n">varnames</span> <span class="o">=</span> <span class="p">{}</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-17" name="rest_code_fc33e910c81344d982b2e748d21e2e92-17" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-17"></a>    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-18" name="rest_code_fc33e910c81344d982b2e748d21e2e92-18" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-18"></a>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-19" name="rest_code_fc33e910c81344d982b2e748d21e2e92-19" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-19"></a>        <span class="c1"># give the operation a name used while</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-20" name="rest_code_fc33e910c81344d982b2e748d21e2e92-20" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-20"></a>        <span class="c1"># printing:</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-21" name="rest_code_fc33e910c81344d982b2e748d21e2e92-21" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-21"></a>        <span class="n">var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">varprefix</span><span class="si">}{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-22" name="rest_code_fc33e910c81344d982b2e748d21e2e92-22" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-22"></a>        <span class="n">varnames</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-23" name="rest_code_fc33e910c81344d982b2e748d21e2e92-23" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-23"></a>        <span class="n">arguments</span> <span class="o">=</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-24" name="rest_code_fc33e910c81344d982b2e748d21e2e92-24" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-24"></a>            <span class="n">arg_to_str</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-25" name="rest_code_fc33e910c81344d982b2e748d21e2e92-25" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-25"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-26" name="rest_code_fc33e910c81344d982b2e748d21e2e92-26" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-26"></a>        <span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-27" name="rest_code_fc33e910c81344d982b2e748d21e2e92-27" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-27"></a>        <span class="n">strop</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">arguments</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-28" name="rest_code_fc33e910c81344d982b2e748d21e2e92-28" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-28"></a>        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strop</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-29" name="rest_code_fc33e910c81344d982b2e748d21e2e92-29" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-29"></a>    <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-30" name="rest_code_fc33e910c81344d982b2e748d21e2e92-30" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-30"></a>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-31" name="rest_code_fc33e910c81344d982b2e748d21e2e92-31" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-31"></a><span class="k">def</span> <span class="nf">test_basicblock_to_str</span><span class="p">():</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-32" name="rest_code_fc33e910c81344d982b2e748d21e2e92-32" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-32"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-33" name="rest_code_fc33e910c81344d982b2e748d21e2e92-33" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-33"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-34" name="rest_code_fc33e910c81344d982b2e748d21e2e92-34" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-34"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-35" name="rest_code_fc33e910c81344d982b2e748d21e2e92-35" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-35"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-36" name="rest_code_fc33e910c81344d982b2e748d21e2e92-36" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-36"></a>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-37" name="rest_code_fc33e910c81344d982b2e748d21e2e92-37" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-37"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-38" name="rest_code_fc33e910c81344d982b2e748d21e2e92-38" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-38"></a><span class="s2">var0 = getarg(0)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-39" name="rest_code_fc33e910c81344d982b2e748d21e2e92-39" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-39"></a><span class="s2">var1 = add(5, 4)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-40" name="rest_code_fc33e910c81344d982b2e748d21e2e92-40" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-40"></a><span class="s2">var2 = add(var1, var0)"""</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-41" name="rest_code_fc33e910c81344d982b2e748d21e2e92-41" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-41"></a>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-42" name="rest_code_fc33e910c81344d982b2e748d21e2e92-42" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-42"></a>    <span class="c1"># with a different prefix for the invented</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-43" name="rest_code_fc33e910c81344d982b2e748d21e2e92-43" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-43"></a>    <span class="c1"># variable names:</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-44" name="rest_code_fc33e910c81344d982b2e748d21e2e92-44" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-44"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="s2">"x"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-45" name="rest_code_fc33e910c81344d982b2e748d21e2e92-45" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-45"></a><span class="s2">x0 = getarg(0)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-46" name="rest_code_fc33e910c81344d982b2e748d21e2e92-46" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-46"></a><span class="s2">x1 = add(5, 4)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-47" name="rest_code_fc33e910c81344d982b2e748d21e2e92-47" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-47"></a><span class="s2">x2 = add(x1, x0)"""</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-48" name="rest_code_fc33e910c81344d982b2e748d21e2e92-48" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-48"></a>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-49" name="rest_code_fc33e910c81344d982b2e748d21e2e92-49" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-49"></a>    <span class="c1"># and our running example:</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-50" name="rest_code_fc33e910c81344d982b2e748d21e2e92-50" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-50"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-51" name="rest_code_fc33e910c81344d982b2e748d21e2e92-51" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-51"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-52" name="rest_code_fc33e910c81344d982b2e748d21e2e92-52" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-52"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-53" name="rest_code_fc33e910c81344d982b2e748d21e2e92-53" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-53"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-54" name="rest_code_fc33e910c81344d982b2e748d21e2e92-54" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-54"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-55" name="rest_code_fc33e910c81344d982b2e748d21e2e92-55" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-55"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-56" name="rest_code_fc33e910c81344d982b2e748d21e2e92-56" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-56"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-57" name="rest_code_fc33e910c81344d982b2e748d21e2e92-57" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-57"></a>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-58" name="rest_code_fc33e910c81344d982b2e748d21e2e92-58" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-58"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="s2">"v"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-59" name="rest_code_fc33e910c81344d982b2e748d21e2e92-59" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-59"></a><span class="s2">v0 = getarg(0)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-60" name="rest_code_fc33e910c81344d982b2e748d21e2e92-60" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-60"></a><span class="s2">v1 = getarg(1)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-61" name="rest_code_fc33e910c81344d982b2e748d21e2e92-61" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-61"></a><span class="s2">v2 = add(v1, 17)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-62" name="rest_code_fc33e910c81344d982b2e748d21e2e92-62" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-62"></a><span class="s2">v3 = mul(v0, v2)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-63" name="rest_code_fc33e910c81344d982b2e748d21e2e92-63" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-63"></a><span class="s2">v4 = add(v1, 17)</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-64" name="rest_code_fc33e910c81344d982b2e748d21e2e92-64" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-64"></a><span class="s2">v5 = add(v3, v4)"""</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-65" name="rest_code_fc33e910c81344d982b2e748d21e2e92-65" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-65"></a>    <span class="c1"># Note the re-numbering of the variables! We</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-66" name="rest_code_fc33e910c81344d982b2e748d21e2e92-66" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-66"></a>    <span class="c1"># don't attach names to Operations at all, so</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-67" name="rest_code_fc33e910c81344d982b2e748d21e2e92-67" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-67"></a>    <span class="c1"># the printing will just number them in</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-68" name="rest_code_fc33e910c81344d982b2e748d21e2e92-68" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-68"></a>    <span class="c1"># sequence, can sometimes be a source of</span>
<a id="rest_code_fc33e910c81344d982b2e748d21e2e92-69" name="rest_code_fc33e910c81344d982b2e748d21e2e92-69" href="toy-optimizer.html#rest_code_fc33e910c81344d982b2e748d21e2e92-69"></a>    <span class="c1"># confusion.</span>
</pre></div>
<p>This is much better. Now we're done with the basic infrastructure, we can
define sequences of operations and print them in a readable way. Next we need a
central data structure that is used when actually optimizing basic blocks.</p>
</section><section id="storing-equivalences-between-operations-using-a-union-find-data-structure"><h2>Storing Equivalences between Operations Using a Union-Find Data Structure<a href="#storing-equivalences-between-operations-using-a-union-find-data-structure" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>When optimizing a sequence of operations, we want to make it less costly to
execute. For that we typically want to remove operations (and sometimes
replace operations with less expensive ones). We can remove operations if
they do redundant computation, like case of the duplicate <code class="docutils literal">add(v1, 17)</code> in
the example. So what we want to do is to turn the running input sequence:</p>
<pre class="literal-block">v0 = getarg(0)
v1 = getarg(1)
v2 = add(v1, 17)
v3 = mul(v0, v2)
v4 = add(v1, 17)
v5 = add(v3, v4)</pre>
<p>Into the following optimized output sequence:</p>
<pre class="literal-block">optvar0 = getarg(0)
optvar1 = getarg(1)
optvar2 = add(optvar1, 17)
optvar3 = mul(optvar0, optvar2)
optvar4 = add(optvar3, optvar2)</pre>
<p>We left out the second <code class="docutils literal">add</code> (which defines <code class="docutils literal">v4</code>), and then replaced the
usage of <code class="docutils literal">v4</code> with <code class="docutils literal">v2</code> in the final operation that defines <code class="docutils literal">v5</code>.</p>
<p>What we effectively did was discover that <code class="docutils literal">v2</code> and <code class="docutils literal">v4</code> are equivalent and then
replaced <code class="docutils literal">v4</code> with <code class="docutils literal">v2</code>. In general, we might discover more such equivalences,
and we need a data structure to store them. A good data structure to store
these equivalences is <a class="reference external" href="https://en.wikipedia.org/wiki/Disjoint-set_data_structure">Union Find</a> (also called Disjoint-set data structure),
which stores a collection of disjoint sets. Disjoint means, that no operation
can appear in more than one set. The sets in our concrete case are the sets of
operations that compute the same result.</p>
<p>When we start out, every operation is in its own singleton set, with no other
member. As we discover more equivalences, we will unify sets into larger sets
of operations that all compute the same result. So one operation the data
structure supports is <code class="docutils literal">union</code>, to unify two sets, we'll call that
<code class="docutils literal">make_equal_to</code> in the code below.</p>
<p>The other operation the data structure supports is <code class="docutils literal">find</code>, which takes an
operation and returns a "representative" of the set of all equivalent
operations. Two operations are in the same set, if the representative that
find returns for them is the same.</p>
<p>The exact details of how the data structure works are only sort of important
(even though it's very cool, I promise!). It's OK to skip over the
implementation. We will add the data structure right into our <code class="docutils literal">Value</code>,
<code class="docutils literal">Constant</code> and <code class="docutils literal">Operation</code> classes:</p>
<div class="code"><pre class="code python"><a id="rest_code_088f232f978d40339957375401ddf78b-1" name="rest_code_088f232f978d40339957375401ddf78b-1" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-1"></a><span class="k">class</span> <span class="nc">Value</span><span class="p">:</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-2" name="rest_code_088f232f978d40339957375401ddf78b-2" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-2"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-3" name="rest_code_088f232f978d40339957375401ddf78b-3" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-3"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"abstract"</span><span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-4" name="rest_code_088f232f978d40339957375401ddf78b-4" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-4"></a>    <span class="k">def</span> <span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-5" name="rest_code_088f232f978d40339957375401ddf78b-5" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-5"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"abstract"</span><span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-6" name="rest_code_088f232f978d40339957375401ddf78b-6" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-6"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-7" name="rest_code_088f232f978d40339957375401ddf78b-7" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-7"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-8" name="rest_code_088f232f978d40339957375401ddf78b-8" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-8"></a><span class="k">class</span> <span class="nc">Operation</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-9" name="rest_code_088f232f978d40339957375401ddf78b-9" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-9"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Value</span><span class="p">]):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-10" name="rest_code_088f232f978d40339957375401ddf78b-10" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-11" name="rest_code_088f232f978d40339957375401ddf78b-11" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-12" name="rest_code_088f232f978d40339957375401ddf78b-12" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-13" name="rest_code_088f232f978d40339957375401ddf78b-13" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-13"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-14" name="rest_code_088f232f978d40339957375401ddf78b-14" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-14"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-15" name="rest_code_088f232f978d40339957375401ddf78b-15" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-15"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-16" name="rest_code_088f232f978d40339957375401ddf78b-16" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-16"></a>            <span class="sa">f</span><span class="s2">"Operation(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">,"</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-17" name="rest_code_088f232f978d40339957375401ddf78b-17" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-17"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-18" name="rest_code_088f232f978d40339957375401ddf78b-18" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-18"></a>        <span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-19" name="rest_code_088f232f978d40339957375401ddf78b-19" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-19"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-20" name="rest_code_088f232f978d40339957375401ddf78b-20" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-20"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-21" name="rest_code_088f232f978d40339957375401ddf78b-21" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-21"></a>        <span class="c1"># returns the "representative" value of</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-22" name="rest_code_088f232f978d40339957375401ddf78b-22" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-22"></a>        <span class="c1"># self, in the union-find sense</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-23" name="rest_code_088f232f978d40339957375401ddf78b-23" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-23"></a>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-24" name="rest_code_088f232f978d40339957375401ddf78b-24" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-24"></a>        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">Operation</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-25" name="rest_code_088f232f978d40339957375401ddf78b-25" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-25"></a>            <span class="c1"># could do path compression here too</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-26" name="rest_code_088f232f978d40339957375401ddf78b-26" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-26"></a>            <span class="c1"># but not essential</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-27" name="rest_code_088f232f978d40339957375401ddf78b-27" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-27"></a>            <span class="nb">next</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">forwarded</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-28" name="rest_code_088f232f978d40339957375401ddf78b-28" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-28"></a>            <span class="k">if</span> <span class="nb">next</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-29" name="rest_code_088f232f978d40339957375401ddf78b-29" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-29"></a>                <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-30" name="rest_code_088f232f978d40339957375401ddf78b-30" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-30"></a>            <span class="n">op</span> <span class="o">=</span> <span class="nb">next</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-31" name="rest_code_088f232f978d40339957375401ddf78b-31" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-31"></a>        <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-32" name="rest_code_088f232f978d40339957375401ddf78b-32" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-32"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-33" name="rest_code_088f232f978d40339957375401ddf78b-33" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-33"></a>    <span class="k">def</span> <span class="nf">arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-34" name="rest_code_088f232f978d40339957375401ddf78b-34" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-34"></a>        <span class="c1"># change to above: return the</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-35" name="rest_code_088f232f978d40339957375401ddf78b-35" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-35"></a>        <span class="c1"># representative of argument 'index'</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-36" name="rest_code_088f232f978d40339957375401ddf78b-36" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-36"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-37" name="rest_code_088f232f978d40339957375401ddf78b-37" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-37"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-38" name="rest_code_088f232f978d40339957375401ddf78b-38" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-38"></a>    <span class="k">def</span> <span class="nf">make_equal_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-39" name="rest_code_088f232f978d40339957375401ddf78b-39" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-39"></a>        <span class="c1"># this is "union" in the union-find sense,</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-40" name="rest_code_088f232f978d40339957375401ddf78b-40" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-40"></a>        <span class="c1"># but the direction is important! The</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-41" name="rest_code_088f232f978d40339957375401ddf78b-41" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-41"></a>        <span class="c1"># representative of the union of Operations</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-42" name="rest_code_088f232f978d40339957375401ddf78b-42" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-42"></a>        <span class="c1"># must be either a Constant or an operation</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-43" name="rest_code_088f232f978d40339957375401ddf78b-43" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-43"></a>        <span class="c1"># that we know for sure is not optimized</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-44" name="rest_code_088f232f978d40339957375401ddf78b-44" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-44"></a>        <span class="c1"># away.</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-45" name="rest_code_088f232f978d40339957375401ddf78b-45" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-45"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-46" name="rest_code_088f232f978d40339957375401ddf78b-46" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">_set_forwarded</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-47" name="rest_code_088f232f978d40339957375401ddf78b-47" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-47"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-48" name="rest_code_088f232f978d40339957375401ddf78b-48" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-48"></a>    <span class="k">def</span> <span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-49" name="rest_code_088f232f978d40339957375401ddf78b-49" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-50" name="rest_code_088f232f978d40339957375401ddf78b-50" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-50"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-51" name="rest_code_088f232f978d40339957375401ddf78b-51" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-51"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-52" name="rest_code_088f232f978d40339957375401ddf78b-52" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-52"></a><span class="k">class</span> <span class="nc">Constant</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-53" name="rest_code_088f232f978d40339957375401ddf78b-53" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-53"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-54" name="rest_code_088f232f978d40339957375401ddf78b-54" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-55" name="rest_code_088f232f978d40339957375401ddf78b-55" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-55"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-56" name="rest_code_088f232f978d40339957375401ddf78b-56" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-56"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-57" name="rest_code_088f232f978d40339957375401ddf78b-57" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-57"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Constant(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-58" name="rest_code_088f232f978d40339957375401ddf78b-58" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-58"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-59" name="rest_code_088f232f978d40339957375401ddf78b-59" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-59"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-60" name="rest_code_088f232f978d40339957375401ddf78b-60" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-60"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-61" name="rest_code_088f232f978d40339957375401ddf78b-61" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-61"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-62" name="rest_code_088f232f978d40339957375401ddf78b-62" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-62"></a>    <span class="k">def</span> <span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-63" name="rest_code_088f232f978d40339957375401ddf78b-63" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-63"></a>        <span class="c1"># if we found out that an Operation is</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-64" name="rest_code_088f232f978d40339957375401ddf78b-64" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-64"></a>        <span class="c1"># equal to a constant, it's a compiler bug</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-65" name="rest_code_088f232f978d40339957375401ddf78b-65" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-65"></a>        <span class="c1"># to find out that it's equal to another</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-66" name="rest_code_088f232f978d40339957375401ddf78b-66" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-66"></a>        <span class="c1"># constant</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-67" name="rest_code_088f232f978d40339957375401ddf78b-67" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-67"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> \
<a id="rest_code_088f232f978d40339957375401ddf78b-68" name="rest_code_088f232f978d40339957375401ddf78b-68" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-68"></a>            <span class="n">value</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-69" name="rest_code_088f232f978d40339957375401ddf78b-69" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-69"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-70" name="rest_code_088f232f978d40339957375401ddf78b-70" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-70"></a><span class="k">def</span> <span class="nf">test_union_find</span><span class="p">():</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-71" name="rest_code_088f232f978d40339957375401ddf78b-71" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-71"></a>    <span class="c1"># construct three operation, and unify them</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-72" name="rest_code_088f232f978d40339957375401ddf78b-72" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-72"></a>    <span class="c1"># step by step</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-73" name="rest_code_088f232f978d40339957375401ddf78b-73" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-73"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-74" name="rest_code_088f232f978d40339957375401ddf78b-74" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-74"></a>    <span class="n">a1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">dummy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-75" name="rest_code_088f232f978d40339957375401ddf78b-75" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-75"></a>    <span class="n">a2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">dummy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-76" name="rest_code_088f232f978d40339957375401ddf78b-76" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-76"></a>    <span class="n">a3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">dummy</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-77" name="rest_code_088f232f978d40339957375401ddf78b-77" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-77"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-78" name="rest_code_088f232f978d40339957375401ddf78b-78" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-78"></a>    <span class="c1"># at the beginning, every op is its own</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-79" name="rest_code_088f232f978d40339957375401ddf78b-79" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-79"></a>    <span class="c1"># representative, that means every</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-80" name="rest_code_088f232f978d40339957375401ddf78b-80" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-80"></a>    <span class="c1"># operation is in a singleton set</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-81" name="rest_code_088f232f978d40339957375401ddf78b-81" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-81"></a>    <span class="c1"># {a1} {a2} {a3}</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-82" name="rest_code_088f232f978d40339957375401ddf78b-82" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-82"></a>    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-83" name="rest_code_088f232f978d40339957375401ddf78b-83" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-83"></a>    <span class="k">assert</span> <span class="n">a2</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a2</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-84" name="rest_code_088f232f978d40339957375401ddf78b-84" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-84"></a>    <span class="k">assert</span> <span class="n">a3</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a3</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-85" name="rest_code_088f232f978d40339957375401ddf78b-85" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-85"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-86" name="rest_code_088f232f978d40339957375401ddf78b-86" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-86"></a>    <span class="c1"># now we unify a2 and a1, then the sets are</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-87" name="rest_code_088f232f978d40339957375401ddf78b-87" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-87"></a>    <span class="c1"># {a1, a2} {a3}</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-88" name="rest_code_088f232f978d40339957375401ddf78b-88" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-88"></a>    <span class="n">a2</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-89" name="rest_code_088f232f978d40339957375401ddf78b-89" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-89"></a>    <span class="c1"># they both return a1 as the representative</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-90" name="rest_code_088f232f978d40339957375401ddf78b-90" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-90"></a>    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-91" name="rest_code_088f232f978d40339957375401ddf78b-91" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-91"></a>    <span class="k">assert</span> <span class="n">a2</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-92" name="rest_code_088f232f978d40339957375401ddf78b-92" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-92"></a>    <span class="c1"># a3 is still different</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-93" name="rest_code_088f232f978d40339957375401ddf78b-93" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-93"></a>    <span class="k">assert</span> <span class="n">a3</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a3</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-94" name="rest_code_088f232f978d40339957375401ddf78b-94" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-94"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-95" name="rest_code_088f232f978d40339957375401ddf78b-95" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-95"></a>    <span class="c1"># now they are all in the same set {a1, a2, a3}</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-96" name="rest_code_088f232f978d40339957375401ddf78b-96" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-96"></a>    <span class="n">a3</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-97" name="rest_code_088f232f978d40339957375401ddf78b-97" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-97"></a>    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-98" name="rest_code_088f232f978d40339957375401ddf78b-98" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-98"></a>    <span class="k">assert</span> <span class="n">a2</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-99" name="rest_code_088f232f978d40339957375401ddf78b-99" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-99"></a>    <span class="k">assert</span> <span class="n">a3</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-100" name="rest_code_088f232f978d40339957375401ddf78b-100" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-100"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-101" name="rest_code_088f232f978d40339957375401ddf78b-101" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-101"></a>    <span class="c1"># now they are still all the same, and we</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-102" name="rest_code_088f232f978d40339957375401ddf78b-102" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-102"></a>    <span class="c1"># also learned that they are the same as the</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-103" name="rest_code_088f232f978d40339957375401ddf78b-103" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-103"></a>    <span class="c1"># constant 6</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-104" name="rest_code_088f232f978d40339957375401ddf78b-104" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-104"></a>    <span class="c1"># the single remaining set then is</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-105" name="rest_code_088f232f978d40339957375401ddf78b-105" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-105"></a>    <span class="c1"># {6, a1, a2, a3}</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-106" name="rest_code_088f232f978d40339957375401ddf78b-106" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-106"></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-107" name="rest_code_088f232f978d40339957375401ddf78b-107" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-107"></a>    <span class="n">a2</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-108" name="rest_code_088f232f978d40339957375401ddf78b-108" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-108"></a>    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">c</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-109" name="rest_code_088f232f978d40339957375401ddf78b-109" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-109"></a>    <span class="k">assert</span> <span class="n">a2</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">c</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-110" name="rest_code_088f232f978d40339957375401ddf78b-110" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-110"></a>    <span class="k">assert</span> <span class="n">a3</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">c</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-111" name="rest_code_088f232f978d40339957375401ddf78b-111" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-111"></a>
<a id="rest_code_088f232f978d40339957375401ddf78b-112" name="rest_code_088f232f978d40339957375401ddf78b-112" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-112"></a>    <span class="c1"># union with the same constant again is fine</span>
<a id="rest_code_088f232f978d40339957375401ddf78b-113" name="rest_code_088f232f978d40339957375401ddf78b-113" href="toy-optimizer.html#rest_code_088f232f978d40339957375401ddf78b-113"></a>    <span class="n">a2</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</section><section id="constant-folding"><h2>Constant Folding<a href="#constant-folding" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>Now comes the first actual optimization, a simple <a class="reference external" href="https://en.wikipedia.org/wiki/Constant_folding">constant folding</a> pass. It
will remove operations where all the arguments are constants and replace them
with the constant result.</p>
<p>Every pass has the same structure: we go over all operations in the basic
block in order and decide for each operation whether it can be removed. For the
constant folding pass, we can remove all the operations with constant
arguments (but we'll implement only the <code class="docutils literal">add</code> case here).</p>
<p>I will show a buggy version of the <a class="reference external" href="https://en.wikipedia.org/wiki/Constant_folding">constant folding</a> pass first. It has a
problem that is related to why we need the union-find data structure. We will
fix it a bit further down.</p>
<div class="code"><pre class="code python"><a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-1" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-1" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-1"></a><span class="k">def</span> <span class="nf">constfold_buggy</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-2" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-2" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-3" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-3" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-3"></a>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-4" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-4" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-4"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-5" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-5" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-5"></a>        <span class="c1"># basic idea: go over the list and do</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-6" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-6" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-6"></a>        <span class="c1"># constant folding of add where possible</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-7" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-7" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-7"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-8" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-8" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-8"></a>            <span class="n">arg0</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-9" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-9" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-9"></a>            <span class="n">arg1</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-10" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-10" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-10"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> \
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-11" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-11" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-11"></a>                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-12" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-12" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-12"></a>                <span class="c1"># can constant-fold! that means we</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-13" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-13" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-13"></a>                <span class="c1"># learned a new equality, namely</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-14" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-14" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-14"></a>                <span class="c1"># that op is equal to a specific</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-15" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-15" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-15"></a>                <span class="c1"># constant</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-16" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-16" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-16"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">arg1</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-17" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-17" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-17"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-18" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-18" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-18"></a>                <span class="c1"># don't need to have the operation</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-19" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-19" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-19"></a>                <span class="c1"># in the optimized basic block</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-20" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-20" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-20"></a>                <span class="k">continue</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-21" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-21" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-21"></a>        <span class="c1"># otherwise the operation is not</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-22" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-22" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-22"></a>        <span class="c1"># constant-foldable and we put into the</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-23" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-23" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-23"></a>        <span class="c1"># output list</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-24" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-24" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-24"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-25" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-25" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-25"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-26" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-26" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-26"></a>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-27" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-27" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-27"></a>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-28" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-28" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-28"></a><span class="k">def</span> <span class="nf">test_constfold_simple</span><span class="p">():</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-29" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-29" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-29"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-30" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-30" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-30"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-31" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-31" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-31"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-32" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-32" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-32"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-33" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-33" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-33"></a>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-34" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-34" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-34"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">constfold_buggy</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-35" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-35" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-35"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-36" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-36" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-36"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-37" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-37" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-37"></a><span class="s2">optvar1 = add(9, optvar0)"""</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-38" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-38" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-38"></a>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-39" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-39" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-39"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">xfail</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-40" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-40" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-40"></a><span class="k">def</span> <span class="nf">test_constfold_buggy_limitation</span><span class="p">():</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-41" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-41" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-41"></a>    <span class="c1"># this test fails! it shows the problem with</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-42" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-42" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-42"></a>    <span class="c1"># the above simple constfold_buggy pass</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-43" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-43" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-43"></a>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-44" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-44" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-44"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-45" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-45" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-45"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-46" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-46" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-46"></a>    <span class="c1"># this is folded</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-47" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-47" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-47"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-48" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-48" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-48"></a>    <span class="c1"># we want this folded too, but it doesn't work</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-49" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-49" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-49"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-50" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-50" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-50"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-51" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-51" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-51"></a>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-52" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-52" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-52"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">constfold_buggy</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-53" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-53" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-53"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-54" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-54" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-54"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_2fbc230c80ac47f9a66385fab72870cb-55" name="rest_code_2fbc230c80ac47f9a66385fab72870cb-55" href="toy-optimizer.html#rest_code_2fbc230c80ac47f9a66385fab72870cb-55"></a><span class="s2">optvar1 = add(19, optvar0)"""</span>
</pre></div>
<p>Why does the test fail? The <code class="docutils literal">opt_bb</code> printed output looks like this:</p>
<pre class="literal-block">optvar0 = getarg(0)
optvar1 = add(9, 10)
optvar2 = add(optvar1, optvar0)</pre>
<p>The problem is that when we optimize the second addition in <cite>constfold_buggy</cite>,
the argument of that operation is an <em>Operation</em> not a <code class="docutils literal">Constant</code>, so
constant-folding is not applied to the second add. However, we have already
learned that the argument <code class="docutils literal">var1</code> to the operation <code class="docutils literal">var2</code> is equal to
<code class="docutils literal">Constant(9)</code>. This information is stored in the union-find data structure.
So what we are missing are suitable find calls in the constant folding pass, to
make use of the previously learned equalities.</p>
<p>Here's the fixed version:</p>
<div class="code"><pre class="code python"><a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-1" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-1" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-1"></a><span class="k">def</span> <span class="nf">constfold</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-2" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-2" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-3" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-3" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-3"></a>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-4" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-4" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-4"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-5" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-5" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-5"></a>        <span class="c1"># basic idea: go over the list and do</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-6" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-6" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-6"></a>        <span class="c1"># constant folding of add where possible</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-7" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-7" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-7"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-8" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-8" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-8"></a>            <span class="c1"># &gt;&gt;&gt; changed</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-9" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-9" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-9"></a><span class="hll">            <span class="n">arg0</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># uses .find()</span>
</span><a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-10" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-10" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-10"></a><span class="hll">            <span class="n">arg1</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># uses .find()</span>
</span><a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-11" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-11" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-11"></a>            <span class="c1"># &lt;&lt;&lt; end changes</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-12" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-12" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-12"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> \
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-13" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-13" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-13"></a>                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-14" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-14" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-14"></a>                <span class="c1"># can constant-fold! that means we</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-15" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-15" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-15"></a>                <span class="c1"># learned a new equality, namely</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-16" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-16" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-16"></a>                <span class="c1"># that op is equal to a specific</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-17" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-17" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-17"></a>                <span class="c1"># constant</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-18" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-18" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-18"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">arg1</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-19" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-19" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-19"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-20" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-20" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-20"></a>                <span class="c1"># don't need to have the operation</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-21" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-21" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-21"></a>                <span class="c1"># in the optimized basic block</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-22" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-22" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-22"></a>                <span class="k">continue</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-23" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-23" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-23"></a>        <span class="c1"># otherwise the operation is not</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-24" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-24" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-24"></a>        <span class="c1"># constant-foldable and we put into the</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-25" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-25" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-25"></a>        <span class="c1"># output list</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-26" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-26" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-26"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-27" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-27" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-27"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-28" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-28" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-28"></a>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-29" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-29" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-29"></a>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-30" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-30" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-30"></a><span class="k">def</span> <span class="nf">test_constfold_two_ops</span><span class="p">():</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-31" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-31" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-31"></a>    <span class="c1"># now it works!</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-32" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-32" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-32"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-33" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-33" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-33"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-34" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-34" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-34"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-35" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-35" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-35"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-36" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-36" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-36"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-37" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-37" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-37"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">constfold</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-38" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-38" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-38"></a>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-39" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-39" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-39"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-40" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-40" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-40"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_dface4e4cc9545798a6c1de2c5a079e9-41" name="rest_code_dface4e4cc9545798a6c1de2c5a079e9-41" href="toy-optimizer.html#rest_code_dface4e4cc9545798a6c1de2c5a079e9-41"></a><span class="s2">optvar1 = add(19, optvar0)"""</span>
</pre></div>
</section><section id="common-subexpression-elimination"><h2>Common Subexpression Elimination<a href="#common-subexpression-elimination" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal">constfold</code> pass only discovers equalities between <code class="docutils literal">Operations</code> and
<code class="docutils literal">Constants</code>. Let's do a second pass that also discovers equalities between
<code class="docutils literal">Operations</code> and other <code class="docutils literal">Operations</code>.</p>
<p>A simple optimization that does that has this property <a class="reference external" href="https://en.wikipedia.org/wiki/Common_subexpression_elimination">common subexpression
elimination</a> (CSE), which will finally optimize away the problem in the
introductory example code that we had above.</p>
<div class="code"><pre class="code python"><a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-1" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-1" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-1"></a><span class="k">def</span> <span class="nf">cse</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-2" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-2" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-2"></a>    <span class="c1"># structure is the same, loop over the input,</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-3" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-3" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-3"></a>    <span class="c1"># add some but not all operations to the</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-4" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-4" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-4"></a>    <span class="c1"># output</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-5" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-5" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-5"></a>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-6" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-6" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-6"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-7" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-7" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-7"></a>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-8" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-8" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-8"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-9" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-9" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-9"></a>        <span class="c1"># only do CSE for add here, but it</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-10" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-10" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-10"></a>        <span class="c1"># generalizes</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-11" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-11" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-11"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-12" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-12" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-12"></a>            <span class="n">arg0</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-13" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-13" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-13"></a>            <span class="n">arg1</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-14" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-14" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-14"></a>            <span class="c1"># Check whether we have emitted the</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-15" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-15" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-15"></a>            <span class="c1"># same operation already</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-16" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-16" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-16"></a>            <span class="n">prev_op</span> <span class="o">=</span> <span class="n">find_prev_add_op</span><span class="p">(</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-17" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-17" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-17"></a>                <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">opt_bb</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-18" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-18" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-18"></a>            <span class="k">if</span> <span class="n">prev_op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-19" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-19" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-19"></a>                <span class="c1"># if yes, we can optimize op away</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-20" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-20" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-20"></a>                <span class="c1"># and replace it with the earlier</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-21" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-21" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-21"></a>                <span class="c1"># result, which is an Operation</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-22" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-22" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-22"></a>                <span class="c1"># that was already emitted to</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-23" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-23" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-23"></a>                <span class="c1"># opt_bb</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-24" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-24" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-24"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">prev_op</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-25" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-25" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-25"></a>                <span class="k">continue</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-26" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-26" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-26"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-27" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-27" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-27"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-28" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-28" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-28"></a>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-29" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-29" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-29"></a>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-30" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-30" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-30"></a><span class="k">def</span> <span class="nf">eq_value</span><span class="p">(</span><span class="n">val0</span><span class="p">,</span> <span class="n">val1</span><span class="p">):</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-31" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-31" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-31"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val0</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> \
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-32" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-32" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-32"></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-33" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-33" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-33"></a>        <span class="c1"># constants compare by their value</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-34" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-34" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-34"></a>        <span class="k">return</span> <span class="n">val0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">val1</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-35" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-35" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-35"></a>    <span class="c1"># everything else by identity</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-36" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-36" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-36"></a>    <span class="k">return</span> <span class="n">val0</span> <span class="ow">is</span> <span class="n">val1</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-37" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-37" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-37"></a>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-38" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-38" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-38"></a>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-39" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-39" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-39"></a><span class="k">def</span> <span class="nf">find_prev_add_op</span><span class="p">(</span><span class="n">arg0</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="n">arg1</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-40" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-40" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-40"></a>        <span class="n">opt_bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Operation</span><span class="p">]:</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-41" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-41" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-41"></a>    <span class="c1"># Really naive and quadratic implementation.</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-42" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-42" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-42"></a>    <span class="c1"># What we do is walk over the already emitted</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-43" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-43" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-43"></a>    <span class="c1"># operations and see whether we emitted an add</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-44" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-44" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-44"></a>    <span class="c1"># with the current arguments already. A real</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-45" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-45" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-45"></a>    <span class="c1"># implementation might use a hashmap of some</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-46" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-46" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-46"></a>    <span class="c1"># kind, or at least only look at a limited</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-47" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-47" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-47"></a>    <span class="c1"># window of instructions.</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-48" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-48" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-48"></a>    <span class="k">for</span> <span class="n">opt_op</span> <span class="ow">in</span> <span class="n">opt_bb</span><span class="p">:</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-49" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-49" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-49"></a>        <span class="k">if</span> <span class="n">opt_op</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-50" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-50" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-50"></a>            <span class="k">continue</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-51" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-51" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-51"></a>        <span class="c1"># It's important to call arg here,</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-52" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-52" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-52"></a>        <span class="c1"># for the same reason why we</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-53" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-53" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-53"></a>        <span class="c1"># needed it in constfold: we need to</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-54" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-54" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-54"></a>        <span class="c1"># make sure .find() is called</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-55" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-55" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-55"></a>        <span class="k">if</span> <span class="n">eq_value</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">opt_op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="ow">and</span> \
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-56" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-56" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-56"></a>                <span class="n">eq_value</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">opt_op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-57" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-57" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-57"></a>            <span class="k">return</span> <span class="n">opt_op</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-58" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-58" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-58"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-59" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-59" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-59"></a>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-60" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-60" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-60"></a>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-61" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-61" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-61"></a><span class="k">def</span> <span class="nf">test_cse</span><span class="p">():</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-62" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-62" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-62"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-63" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-63" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-63"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-64" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-64" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-64"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-65" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-65" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-65"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-66" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-66" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-66"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-67" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-67" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-67"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-68" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-68" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-68"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-69" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-69" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-69"></a>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-70" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-70" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-70"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">cse</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-71" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-71" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-71"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-72" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-72" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-72"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-73" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-73" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-73"></a><span class="s2">optvar1 = getarg(1)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-74" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-74" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-74"></a><span class="s2">optvar2 = add(optvar1, 17)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-75" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-75" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-75"></a><span class="s2">optvar3 = mul(optvar0, optvar2)</span>
<a id="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-76" name="rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-76" href="toy-optimizer.html#rest_code_c64a800882de49eaa5c8a6ae4e0ef0f3-76"></a><span class="s2">optvar4 = add(optvar3, optvar2)"""</span>
</pre></div>
</section><section id="strength-reduction"><h2>Strength Reduction<a href="#strength-reduction" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>Now we have one pass that replaces <code class="docutils literal">Operations</code> with <code class="docutils literal">Constants</code> and one that
replaces <code class="docutils literal">Operations</code> with previously existing <code class="docutils literal">Operations</code>. Let's now do one
final pass that replaces <code class="docutils literal">Operations</code> by newly invented <code class="docutils literal">Operations</code>, a simple
<a class="reference external" href="https://en.wikipedia.org/wiki/Strength_reduction">strength reduction</a>. This one will be simple.</p>
<div class="code"><pre class="code python"><a id="rest_code_e71c9328853e457084e96c7badfb80b0-1" name="rest_code_e71c9328853e457084e96c7badfb80b0-1" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-1"></a><span class="k">def</span> <span class="nf">strength_reduce</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-2" name="rest_code_e71c9328853e457084e96c7badfb80b0-2" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-3" name="rest_code_e71c9328853e457084e96c7badfb80b0-3" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-3"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-4" name="rest_code_e71c9328853e457084e96c7badfb80b0-4" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-4"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-5" name="rest_code_e71c9328853e457084e96c7badfb80b0-5" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-5"></a>            <span class="n">arg0</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-6" name="rest_code_e71c9328853e457084e96c7badfb80b0-6" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-6"></a>            <span class="n">arg1</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-7" name="rest_code_e71c9328853e457084e96c7badfb80b0-7" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-7"></a>            <span class="k">if</span> <span class="n">arg0</span> <span class="ow">is</span> <span class="n">arg1</span><span class="p">:</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-8" name="rest_code_e71c9328853e457084e96c7badfb80b0-8" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-8"></a>                <span class="c1"># x + x turns into x &lt;&lt; 1</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-9" name="rest_code_e71c9328853e457084e96c7badfb80b0-9" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-9"></a>                <span class="n">newop</span> <span class="o">=</span> <span class="n">opt_bb</span><span class="o">.</span><span class="n">lshift</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-10" name="rest_code_e71c9328853e457084e96c7badfb80b0-10" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-10"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">newop</span><span class="p">)</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-11" name="rest_code_e71c9328853e457084e96c7badfb80b0-11" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-11"></a>                <span class="k">continue</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-12" name="rest_code_e71c9328853e457084e96c7badfb80b0-12" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-12"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-13" name="rest_code_e71c9328853e457084e96c7badfb80b0-13" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-13"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-14" name="rest_code_e71c9328853e457084e96c7badfb80b0-14" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-14"></a>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-15" name="rest_code_e71c9328853e457084e96c7badfb80b0-15" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-15"></a><span class="k">def</span> <span class="nf">test_strength_reduce</span><span class="p">():</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-16" name="rest_code_e71c9328853e457084e96c7badfb80b0-16" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-16"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-17" name="rest_code_e71c9328853e457084e96c7badfb80b0-17" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-17"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-18" name="rest_code_e71c9328853e457084e96c7badfb80b0-18" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-18"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-19" name="rest_code_e71c9328853e457084e96c7badfb80b0-19" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-19"></a>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-20" name="rest_code_e71c9328853e457084e96c7badfb80b0-20" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-20"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">strength_reduce</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-21" name="rest_code_e71c9328853e457084e96c7badfb80b0-21" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-21"></a>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-22" name="rest_code_e71c9328853e457084e96c7badfb80b0-22" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-22"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-23" name="rest_code_e71c9328853e457084e96c7badfb80b0-23" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-23"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_e71c9328853e457084e96c7badfb80b0-24" name="rest_code_e71c9328853e457084e96c7badfb80b0-24" href="toy-optimizer.html#rest_code_e71c9328853e457084e96c7badfb80b0-24"></a><span class="s2">optvar1 = lshift(optvar0, 1)"""</span>
</pre></div>
</section><section id="putting-things-together"><h2>Putting Things Together<a href="#putting-things-together" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>Let's combine the passes into one single pass, so that we are going over all
the operations only exactly once, instead of having to look at every operation
once for all the different passes.</p>
<div class="code"><pre class="code python"><a id="rest_code_8715cae7134f4c85be02dab9898a017c-1" name="rest_code_8715cae7134f4c85be02dab9898a017c-1" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-1"></a><span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-2" name="rest_code_8715cae7134f4c85be02dab9898a017c-2" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-3" name="rest_code_8715cae7134f4c85be02dab9898a017c-3" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-3"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-4" name="rest_code_8715cae7134f4c85be02dab9898a017c-4" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-4"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-5" name="rest_code_8715cae7134f4c85be02dab9898a017c-5" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-5"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-6" name="rest_code_8715cae7134f4c85be02dab9898a017c-6" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-6"></a>            <span class="n">arg0</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-7" name="rest_code_8715cae7134f4c85be02dab9898a017c-7" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-7"></a>            <span class="n">arg1</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-8" name="rest_code_8715cae7134f4c85be02dab9898a017c-8" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-8"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-9" name="rest_code_8715cae7134f4c85be02dab9898a017c-9" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-9"></a>            <span class="c1"># constant folding</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-10" name="rest_code_8715cae7134f4c85be02dab9898a017c-10" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-10"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> \
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-11" name="rest_code_8715cae7134f4c85be02dab9898a017c-11" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-11"></a>                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-12" name="rest_code_8715cae7134f4c85be02dab9898a017c-12" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-12"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">arg1</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-13" name="rest_code_8715cae7134f4c85be02dab9898a017c-13" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-13"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-14" name="rest_code_8715cae7134f4c85be02dab9898a017c-14" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-14"></a>                <span class="k">continue</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-15" name="rest_code_8715cae7134f4c85be02dab9898a017c-15" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-15"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-16" name="rest_code_8715cae7134f4c85be02dab9898a017c-16" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-16"></a>            <span class="c1"># cse</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-17" name="rest_code_8715cae7134f4c85be02dab9898a017c-17" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-17"></a>            <span class="n">prev_op</span> <span class="o">=</span> <span class="n">find_prev_add_op</span><span class="p">(</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-18" name="rest_code_8715cae7134f4c85be02dab9898a017c-18" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-18"></a>                <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">opt_bb</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-19" name="rest_code_8715cae7134f4c85be02dab9898a017c-19" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-19"></a>            <span class="k">if</span> <span class="n">prev_op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-20" name="rest_code_8715cae7134f4c85be02dab9898a017c-20" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-20"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">prev_op</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-21" name="rest_code_8715cae7134f4c85be02dab9898a017c-21" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-21"></a>                <span class="k">continue</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-22" name="rest_code_8715cae7134f4c85be02dab9898a017c-22" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-22"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-23" name="rest_code_8715cae7134f4c85be02dab9898a017c-23" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-23"></a>            <span class="c1"># strength reduce:</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-24" name="rest_code_8715cae7134f4c85be02dab9898a017c-24" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-24"></a>            <span class="c1"># x + x turns into x &lt;&lt; 1</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-25" name="rest_code_8715cae7134f4c85be02dab9898a017c-25" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-25"></a>            <span class="k">if</span> <span class="n">arg0</span> <span class="ow">is</span> <span class="n">arg1</span><span class="p">:</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-26" name="rest_code_8715cae7134f4c85be02dab9898a017c-26" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-26"></a>                <span class="n">newop</span> <span class="o">=</span> <span class="n">opt_bb</span><span class="o">.</span><span class="n">lshift</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-27" name="rest_code_8715cae7134f4c85be02dab9898a017c-27" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-27"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">newop</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-28" name="rest_code_8715cae7134f4c85be02dab9898a017c-28" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-28"></a>                <span class="k">continue</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-29" name="rest_code_8715cae7134f4c85be02dab9898a017c-29" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-29"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-30" name="rest_code_8715cae7134f4c85be02dab9898a017c-30" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-30"></a>            <span class="c1"># and while we are at it, let's do some</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-31" name="rest_code_8715cae7134f4c85be02dab9898a017c-31" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-31"></a>            <span class="c1"># arithmetic simplification:</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-32" name="rest_code_8715cae7134f4c85be02dab9898a017c-32" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-32"></a>            <span class="c1"># a + 0 =&gt; a</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-33" name="rest_code_8715cae7134f4c85be02dab9898a017c-33" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-33"></a>            <span class="k">if</span> <span class="n">eq_value</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-34" name="rest_code_8715cae7134f4c85be02dab9898a017c-34" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-34"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-35" name="rest_code_8715cae7134f4c85be02dab9898a017c-35" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-35"></a>                <span class="k">continue</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-36" name="rest_code_8715cae7134f4c85be02dab9898a017c-36" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-36"></a>            <span class="k">if</span> <span class="n">eq_value</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-37" name="rest_code_8715cae7134f4c85be02dab9898a017c-37" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-37"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">arg0</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-38" name="rest_code_8715cae7134f4c85be02dab9898a017c-38" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-38"></a>                <span class="k">continue</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-39" name="rest_code_8715cae7134f4c85be02dab9898a017c-39" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-39"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-40" name="rest_code_8715cae7134f4c85be02dab9898a017c-40" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-40"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-41" name="rest_code_8715cae7134f4c85be02dab9898a017c-41" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-41"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-42" name="rest_code_8715cae7134f4c85be02dab9898a017c-42" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-42"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-43" name="rest_code_8715cae7134f4c85be02dab9898a017c-43" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-43"></a><span class="k">def</span> <span class="nf">test_single_pass</span><span class="p">():</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-44" name="rest_code_8715cae7134f4c85be02dab9898a017c-44" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-44"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-45" name="rest_code_8715cae7134f4c85be02dab9898a017c-45" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-45"></a>    <span class="c1"># constant folding</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-46" name="rest_code_8715cae7134f4c85be02dab9898a017c-46" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-46"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-47" name="rest_code_8715cae7134f4c85be02dab9898a017c-47" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-47"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-48" name="rest_code_8715cae7134f4c85be02dab9898a017c-48" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-48"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-49" name="rest_code_8715cae7134f4c85be02dab9898a017c-49" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-49"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-50" name="rest_code_8715cae7134f4c85be02dab9898a017c-50" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-50"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-51" name="rest_code_8715cae7134f4c85be02dab9898a017c-51" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-51"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-52" name="rest_code_8715cae7134f4c85be02dab9898a017c-52" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-52"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-53" name="rest_code_8715cae7134f4c85be02dab9898a017c-53" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-53"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-54" name="rest_code_8715cae7134f4c85be02dab9898a017c-54" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-54"></a><span class="s2">optvar1 = add(19, optvar0)"""</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-55" name="rest_code_8715cae7134f4c85be02dab9898a017c-55" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-55"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-56" name="rest_code_8715cae7134f4c85be02dab9898a017c-56" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-56"></a>    <span class="c1"># cse + strength reduction</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-57" name="rest_code_8715cae7134f4c85be02dab9898a017c-57" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-57"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-58" name="rest_code_8715cae7134f4c85be02dab9898a017c-58" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-58"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-59" name="rest_code_8715cae7134f4c85be02dab9898a017c-59" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-59"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-60" name="rest_code_8715cae7134f4c85be02dab9898a017c-60" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-60"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-61" name="rest_code_8715cae7134f4c85be02dab9898a017c-61" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-61"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span> <span class="c1"># the same as var3</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-62" name="rest_code_8715cae7134f4c85be02dab9898a017c-62" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-62"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-63" name="rest_code_8715cae7134f4c85be02dab9898a017c-63" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-63"></a>    <span class="n">var5</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># the same as var4</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-64" name="rest_code_8715cae7134f4c85be02dab9898a017c-64" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-64"></a>    <span class="n">var6</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var4</span><span class="p">,</span> <span class="n">var5</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-65" name="rest_code_8715cae7134f4c85be02dab9898a017c-65" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-65"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-66" name="rest_code_8715cae7134f4c85be02dab9898a017c-66" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-66"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-67" name="rest_code_8715cae7134f4c85be02dab9898a017c-67" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-67"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-68" name="rest_code_8715cae7134f4c85be02dab9898a017c-68" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-68"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-69" name="rest_code_8715cae7134f4c85be02dab9898a017c-69" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-69"></a><span class="s2">optvar1 = getarg(1)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-70" name="rest_code_8715cae7134f4c85be02dab9898a017c-70" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-70"></a><span class="s2">optvar2 = add(optvar0, optvar1)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-71" name="rest_code_8715cae7134f4c85be02dab9898a017c-71" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-71"></a><span class="s2">optvar3 = add(optvar2, 2)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-72" name="rest_code_8715cae7134f4c85be02dab9898a017c-72" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-72"></a><span class="s2">optvar4 = lshift(optvar3, 1)"""</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-73" name="rest_code_8715cae7134f4c85be02dab9898a017c-73" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-73"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-74" name="rest_code_8715cae7134f4c85be02dab9898a017c-74" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-74"></a>    <span class="c1"># removing + 0</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-75" name="rest_code_8715cae7134f4c85be02dab9898a017c-75" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-75"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-76" name="rest_code_8715cae7134f4c85be02dab9898a017c-76" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-76"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-77" name="rest_code_8715cae7134f4c85be02dab9898a017c-77" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-77"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-78" name="rest_code_8715cae7134f4c85be02dab9898a017c-78" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-78"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-79" name="rest_code_8715cae7134f4c85be02dab9898a017c-79" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-79"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var2</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-80" name="rest_code_8715cae7134f4c85be02dab9898a017c-80" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-80"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-81" name="rest_code_8715cae7134f4c85be02dab9898a017c-81" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-81"></a>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-82" name="rest_code_8715cae7134f4c85be02dab9898a017c-82" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-82"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-83" name="rest_code_8715cae7134f4c85be02dab9898a017c-83" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-83"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-84" name="rest_code_8715cae7134f4c85be02dab9898a017c-84" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-84"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_8715cae7134f4c85be02dab9898a017c-85" name="rest_code_8715cae7134f4c85be02dab9898a017c-85" href="toy-optimizer.html#rest_code_8715cae7134f4c85be02dab9898a017c-85"></a><span class="s2">optvar1 = lshift(optvar0, 1)"""</span>
</pre></div>
</section><section id="conclusion"><h2>Conclusion<a href="#conclusion" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>That's it for now. Why is this architecture cool? From a software engineering
point of view, sticking everything into a single function like in <code class="docutils literal">optimize</code>
above is obviously not great, and if you wanted to do this for real you would
try to split the cases into different functions that are individually
digestible, or even use a DSL that makes the pattern matching much more
readable. But the advantage of the architecture is that it's quite efficient,
it makes it possible to pack a lot of good optimizations into a single pass
over a basic block.</p>
<p>Of course this works even better if you are in a tracing context, where
everything is put into a trace, which is basically one incredibly long basic
block. In a JIT context it's also quite important that the
optimizer itself runs quickly.</p>
<p>Various other optimizations are possible in this model. There is a
<a class="reference external" href="../10/toy-optimizer-allocation-removal.html">follow-up post</a> that show how to implement what is arguably PyPy's <a class="reference external" href="https://www.pypy.org/posts/2010/09/escape-analysis-in-pypys-jit-1780048403046080197.html">most
important optimization</a>.</p>
</section><section id="some-further-pointers"><h2>Some Further Pointers<a href="#some-further-pointers" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>This post is only a short introduction and is taking some shortcuts, I wanted to
also give some (non-exhaustive) pointers to more general literature about the
touched topics.</p>
<p>The approach to CSE described here is usually can be seen as <a class="reference external" href="https://en.wikipedia.org/wiki/Value_numbering">value
numbering</a>, it's normally really implemented with a hashmap though. Here's a
<a class="reference external" href="https://www.cs.tufts.edu/~nr/cs257/archive/keith-cooper/value-numbering.pdf">paper</a> that describes various styles of implementing that, even beyond a
single basic block. The paper also partly takes the perspective of discovering
equivalence classes of operations that compute the same result.</p>
<p>A technique that leans even more fully into finding equivalences between
operations is using e-graphs and then applying <a class="reference external" href="https://en.wikipedia.org/wiki/E-graph#Equality_saturation">equality saturation</a> (this is
significantly more advanced that what I described here though). A cool modern
project that applies this technique is <a class="reference external" href="https://egraphs-good.github.io/">egg</a>.</p>
<p>If you squint a bit, you can generally view a constant folding pass as a very
simple form of <a class="reference external" href="https://en.wikipedia.org/wiki/Partial_evaluation">Partial Evaluation</a>: every operation that has constant
arguments is constant-folded away, and the remaining ones are "residualized",
i.e. put into the output program. This point of view is not super important for
the current post, but will become important in the next one.</p>
<p><strong>Acknowledgements:</strong> Thanks to <a class="reference external" href="https://thorstenball.com/">Thorsten Ball</a> for <a class="reference external" href="https://twitter.com/cfbolz/status/1547231548017106944">getting me</a> to write
this and for his enthusiastic feedback. I also got great feedback from <a class="reference external" href="https://bernsteinbear.com/">Max
Bernstein</a>, Matti Picus and Per Vognsen. A conversation with <a class="reference external" href="https://pengwu.substack.com/">Peng Wu</a> that
we had many many years ago and that stuck with me made me keep thinking about
various ways to view compiler optimizations.</p>
</section>
</div>
      <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/toy-optimizer.html" rel="tag">toy-optimizer</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../04/how-is-pypy-tested.html" rel="prev" title="How is PyPy Tested?">Previous post</a>
            </li>
            <li class="next">
                <a href="m1-support-for-pypy.html" rel="next" title="M1 support for PyPy">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                      <div data-title="Implementing a Toy Optimizer" id="utterances-thread"></div>
        <script src="https://utteranc.es/client.js" repo="pypy/pypy.org" issue-term="title" label="Comments" theme="github-light" crossorigin="anonymous"></script></section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2024/08/portaone.html" class="listtitle">Guest Post: How PortaOne uses PyPy for high-performance processing, connecting over 1B of phone calls every month</a>
      </li>
      <li>
        <a href="/posts/2024/08/pypy-v7317-release.html" class="listtitle">PyPy v7.3.17 release</a>
      </li>
      <li>
        <a href="/posts/2024/08/conda-forge-proposes-dropping-support-for-pypy.html" class="listtitle">Conda-forge proposes sunsetting support for PyPy</a>
      </li>
      <li>
        <a href="/posts/2024/08/toy-knownbits.html" class="listtitle">A Knownbits Abstract Domain for the Toy Optimizer, Correctly</a>
      </li>
      <li>
        <a href="/posts/2024/07/toy-abstract-interpretation.html" class="listtitle">Abstract interpretation in the Toy Optimizer</a>
      </li>
      <li>
        <a href="/posts/2024/07/mining-jit-traces-missing-optimizations-z3.html" class="listtitle">Mining JIT traces for missing optimizations with Z3</a>
      </li>
      <li>
        <a href="/posts/2024/07/finding-simple-rewrite-rules-jit-z3.html" class="listtitle">Finding Simple Rewrite Rules for the JIT with Z3</a>
      </li>
      <li>
        <a href="/posts/2024/05/vmprof-firefox-converter.html" class="listtitle">Profiling PyPy using the Firefox profiler user interface</a>
      </li>
      <li>
        <a href="/posts/2024/04/pypy-v7316-release.html" class="listtitle">PyPy v7.3.16 release</a>
      </li>
      <li>
        <a href="/posts/2024/03/fixing-bug-incremental-gc.html" class="listtitle">Fixing a Bug in PyPy's Incremental GC</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (11)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (1)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (1)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (22)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (4)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (62)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (4)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (3)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2024 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2024-08-30T08:28
  </div>
  <div style="margin-left: auto">
  <a href="../../../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>