<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="A Faster Python">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PyPy (old posts, page 43) | PyPy</title>
<link href="../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://www.pypy.org/blog/index-43.html">
<link rel="icon" href="../favicon2.ico" sizes="16x16">
<link rel="icon" href="../favicon32x32.ico" sizes="32x32">
<link rel="prev" href="index-44.html" type="text/html">
<link rel="next" href="index-42.html" type="text/html">
<!--[if lt IE 9]><script src="../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../assets/css/tipuesearch.css">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../index.html">
                    <image id="toplogo" src="../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../compat.html">Compatibility</a> </li>  
                    <li> <a href="../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href=".">Index</a> </li>  
                    <li> <a href="../categories/">Tags</a> </li>  
                    <li> <a href="../archive.html">Archive by year</a> </li>  
                    <li> <a href="../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://twitter.com/pypyproject">Twitter</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><div class="post">
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2023/06/pypy-v7312-release.html" class="u-url">PyPy v7.3.12 release</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/mattip.html">mattip</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2023/06/pypy-v7312-release.html" rel="bookmark">
            <time class="published dt-published" datetime="2023-06-16T04:22:08Z" itemprop="datePublished" title="2023-06-16 04:22">2023-06-16 04:22</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-12-release-of-python-2-7-3-9-and-3-10"><h2>PyPy v7.3.12: release of python 2.7, 3.9, and 3.10.</h2>
<p>The PyPy team is proud to release version 7.3.12 of PyPy.
This release includes a new string-to-int algorithm (also appearing in CPython
3.12) that is faster than the older one; support for symlinks in Windows; and
our first Python3.10 version.</p>
<p>The release includes three different interpreters:</p>
<blockquote>
<ul class="simple">
<li><p>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.18+ (the <code class="docutils literal">+</code> is for
backported security updates)</p></li>
<li><p>PyPy3.9, which is an interpreter supporting the syntax and the features of
Python 3.9, including the stdlib for CPython 3.9.17.</p></li>
<li><p>PyPy3.10, which is an interpreter supporting the syntax and the features of
Python 3.10, including the stdlib for CPython 3.10.12. This is our first
release of 3.10, but based on past experience we are quite confident in
its compatibility with upstream. Of course, we recommend testing your code
with this new version before putting it into production. Note it does
require at least cython 0.29.35 or cython 3.0.0b3</p></li>
</ul>
</blockquote>
<p>The interpreters are based on much the same codebase, thus the multiple
release. This is a micro release, all APIs are compatible with the other 7.3
releases. It follows after 7.3.11 release on Dec 29, 2022</p>
<p>We recommend updating. You can find links to download the v7.3.12 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
<a class="reference external" href="https://www.pypy.org/pypy-sponsors.html">direct consulting</a> work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">blog</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: bug fixes,
<a class="reference external" href="../posts/2023/06/index.html">PyPy</a> and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, or general <a class="reference external" href="../posts/2023/06/project-ideas.html">help</a> with making
RPython's JIT even better. Since the previous release, we have accepted
contributions from one new contributor, thanks for pitching in, and welcome
to the project!</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a <a class="reference external" href="https://hpyproject.org/">HPy</a> / <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> / <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> version of your library that would be performant
on PyPy. In any case, both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.9 and
3.10. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>We provide binary builds for:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS 64 bits, Windows 64 bits)</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux (<code class="docutils literal">aarch64</code>).</p></li>
<li><p>Apple <strong>M1 arm64</strong> machines (<code class="docutils literal">macos_arm64</code>).</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
</ul>
</blockquote>
<p>PyPy support Windows 32-bit, Linux PPC64 big- and little-endian, and Linux ARM
32 bit, but does not release binaries. Please reach out to us if you wish to
sponsor binary releases for those platforms. Downstream packagers provide
binary builds for debian, Fedora, conda, OpenBSD, FreeBSD, Gentoo, and more.</p>
</section><section id="what-else-is-new"><h3>What else is new?</h3>
<p>For more information about the 7.3.12 release, see the <a class="reference external" href="https://doc.pypy.org/en/latest/release-v7.3.12.html#changelog">full changelog</a>.</p>
<p>Please update, and continue to help us make pypy better.</p>
<p>Cheers,
The PyPy Team</p>
</section></section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2023/05/rpython-used-to-speed-up-risc-v-simulation-over-15x.html" class="u-url">RPython-based emulator speeds up RISC-V simulation over 15x</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2023/05/rpython-used-to-speed-up-risc-v-simulation-over-15x.html" rel="bookmark">
            <time class="published dt-published" datetime="2023-05-16T11:22:35Z" itemprop="datePublished" title="2023-05-16 11:22">2023-05-16 11:22</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <p>In cooperation with <a class="reference external" href="https://riscv.org/">RISC-V International</a>, who funded a part of this project,
we recently created a workflow to
use RPython to take a <a class="reference external" href="https://github.com/riscv/sail-riscv#riscv-sail-model">Sail RISC-V</a> model and automatically create a RISC-V ISA
emulator from it, which we call <a class="reference external" href="https://docs.pydrofoil.org">Pydrofoil</a>. The simulator sped up booting a
linux emulator from 35 minutes (using the standard Sail-generated emulator in
C) to 2 minutes, a speedup of 17.5x. More details about the process are in the
<a class="reference external" href="https://riscv.org/blog/2023/05/how-to-speed-up-the-emulating-process-with-pydrofoil-carl-friedrich/">RISC-V blog post</a>.</p>
<p>A few take-aways from the project:</p>
<ul class="simple">
<li><p>While PyPy has shown it can speed up generic python code <a class="reference external" href="https://speed.pypy.org">about 4x</a>, the
technology behind PyPy can really shine in other areas.</p></li>
<li><p>RPython is malleable and can be molded to many tasks, the RPython meta-JIT is
very flexible.</p></li>
<li><p>A JIT is well-suited for the problem of emulation, because it can
perform dynamic binary translation.</p></li>
</ul>
<p>PyPy can solve real world performance problems, even somewhat unusual ones.
Please <a class="reference external" href="https://www.pypy.org/pypy-sponsors.html">get in touch</a> and let us know how we can help you solve yours!</p>
    </div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2023/01/string-concatenation-quadratic.html" class="u-url">Repeated string concatenation is quadratic in PyPy (and CPython)</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2023/01/string-concatenation-quadratic.html" rel="bookmark">
            <time class="published dt-published" datetime="2023-01-04T09:00:00Z" itemprop="datePublished" title="2023-01-04 09:00">2023-01-04 09:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <p>This is a super brief blog post responding to an <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3885">issue</a> that we got on the PyPy
issue tracker. I am moving my response to the blog (with permission of the
submitter) to have a post to point to, since it's a problem that comes up with
some regularity. It's also documented on our page of <a class="reference external" href="https://doc.pypy.org/en/latest/cpython_differences.html?highlight=join#performance-differences">differences between PyPy
and CPython</a> but I thought an additional blog post might be good.</p>
<p>The issue pointed out that a small program that operates on strings is much
slower on PyPy compared to CPython. The program is a solution for 2016's
Advent of Code <a class="reference external" href="https://adventofcode.com/2016/day/16">Day 16</a> and looks like this:</p>
<div class="code"><pre class="code python"><a id="rest_code_c170003db8f24dbbbe95b21725032042-1" name="rest_code_c170003db8f24dbbbe95b21725032042-1" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-1"></a><span class="k">def</span> <span class="nf">dragon</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-2" name="rest_code_c170003db8f24dbbbe95b21725032042-2" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-2"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'0'</span><span class="p">,</span><span class="s1">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'1'</span><span class="p">,</span><span class="s1">'0'</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'r'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">)</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-3" name="rest_code_c170003db8f24dbbbe95b21725032042-3" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-3"></a>    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="s1">'0'</span><span class="o">+</span><span class="n">b</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-4" name="rest_code_c170003db8f24dbbbe95b21725032042-4" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-4"></a>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-5" name="rest_code_c170003db8f24dbbbe95b21725032042-5" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-5"></a><span class="k">def</span> <span class="nf">diffstr</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-6" name="rest_code_c170003db8f24dbbbe95b21725032042-6" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-6"></a>    <span class="n">b</span> <span class="o">=</span> <span class="s2">""</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-7" name="rest_code_c170003db8f24dbbbe95b21725032042-7" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-7"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-8" name="rest_code_c170003db8f24dbbbe95b21725032042-8" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-8"></a>        <span class="n">b</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'0'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">][</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-9" name="rest_code_c170003db8f24dbbbe95b21725032042-9" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-9"></a>    <span class="k">return</span> <span class="n">b</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-10" name="rest_code_c170003db8f24dbbbe95b21725032042-10" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-10"></a>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-11" name="rest_code_c170003db8f24dbbbe95b21725032042-11" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-11"></a><span class="k">def</span> <span class="nf">iterdiff</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-12" name="rest_code_c170003db8f24dbbbe95b21725032042-12" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-12"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-13" name="rest_code_c170003db8f24dbbbe95b21725032042-13" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-13"></a>    <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-14" name="rest_code_c170003db8f24dbbbe95b21725032042-14" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-14"></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">diffstr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-15" name="rest_code_c170003db8f24dbbbe95b21725032042-15" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-15"></a>    <span class="k">return</span> <span class="n">b</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-16" name="rest_code_c170003db8f24dbbbe95b21725032042-16" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-16"></a>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-17" name="rest_code_c170003db8f24dbbbe95b21725032042-17" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-17"></a><span class="n">size</span> <span class="o">=</span> <span class="mi">35651584</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-18" name="rest_code_c170003db8f24dbbbe95b21725032042-18" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-18"></a><span class="n">initstate</span> <span class="o">=</span> <span class="s1">'10010000000110000'</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-19" name="rest_code_c170003db8f24dbbbe95b21725032042-19" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-19"></a><span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">initstate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">):</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-20" name="rest_code_c170003db8f24dbbbe95b21725032042-20" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-20"></a>    <span class="n">initstate</span> <span class="o">=</span> <span class="n">dragon</span><span class="p">(</span><span class="n">initstate</span><span class="p">)</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-21" name="rest_code_c170003db8f24dbbbe95b21725032042-21" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-21"></a><span class="n">initstate</span> <span class="o">=</span> <span class="n">initstate</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
<a id="rest_code_c170003db8f24dbbbe95b21725032042-22" name="rest_code_c170003db8f24dbbbe95b21725032042-22" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_c170003db8f24dbbbe95b21725032042-22"></a><span class="nb">print</span><span class="p">(</span><span class="n">iterdiff</span><span class="p">(</span><span class="n">initstate</span><span class="p">))</span>
</pre></div>
<p>The submitter pointed out, that the program is fast on CPython (~8s on my
laptop) and slow (didn't finish) on PyPy.</p>
<p>The reason for the performance difference is that <code class="docutils literal">+=</code> on strings in a loop
has quadratic complexity in PyPy, which is what <code class="docutils literal">diffstr</code> does. To see the
quadraticness, consider that to add a character at the end of the string, the
beginning of the string needs to be copied into a new chunk of memory. If the
loop runs <code class="docutils literal">n</code> times, that means there are</p>
<p><code class="docutils literal">1 + 2 + 3 + ... + n = n * (n + 1) // 2</code></p>
<p>character copies.</p>
<p>Repeated string concatenations are in principle also quadratic in CPython, but
CPython has an <a class="reference external" href="https://docs.python.org/2/whatsnew/2.4.html#optimizations">optimization</a> that makes them sometimes not quadratic, which is
what makes this program not too slow in CPython.</p>
<p>In order to fix the problem on PyPy it's best to use a list for the string
parts, which has the right amortized O(1) complexity for <code class="docutils literal">.append</code> calls, and
then use <code class="docutils literal">str.join</code> after the loop:</p>
<div class="code"><pre class="code python"><a id="rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-1" name="rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-1" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-1"></a><span class="k">def</span> <span class="nf">diffstr</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<a id="rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-2" name="rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-2" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-2"></a>    <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
<a id="rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-3" name="rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-3" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-3"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>
<a id="rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-4" name="rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-4" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-4"></a>        <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">'0'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">][</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
<a id="rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-5" name="rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-5" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_df9e1a6b32cc4a0f8ad856e06423c75c-5"></a>    <span class="k">return</span> <span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
<p>With this change the program becomes a little bit faster on CPython for me, and
on PyPy it stops being quadratic and runs in ~3.5s.</p>
<p>In general, it's best not to rely on the presence of this optimization in
CPython either. Sometimes, a small innocent looking changes will break CPython's
optimization. E.g. this useless change makes CPython also take ages:</p>
<div class="code"><pre class="code python"><a id="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-1" name="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-1" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_7b13218b68b84ef1b8cd76ea9e86242f-1"></a><span class="k">def</span> <span class="nf">diffstr</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<a id="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-2" name="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-2" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_7b13218b68b84ef1b8cd76ea9e86242f-2"></a>    <span class="n">b</span> <span class="o">=</span> <span class="s2">""</span>
<a id="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-3" name="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-3" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_7b13218b68b84ef1b8cd76ea9e86242f-3"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="mi">2</span><span class="p">):</span>
<a id="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-4" name="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-4" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_7b13218b68b84ef1b8cd76ea9e86242f-4"></a>        <span class="n">b</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'0'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">][</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
<a id="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-5" name="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-5" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_7b13218b68b84ef1b8cd76ea9e86242f-5"></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">b</span>
<a id="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-6" name="rest_code_7b13218b68b84ef1b8cd76ea9e86242f-6" href="../posts/2023/01/string-concatenation-quadratic.html#rest_code_7b13218b68b84ef1b8cd76ea9e86242f-6"></a>    <span class="k">return</span> <span class="n">b</span>
</pre></div>
<p>The reason why this change breaks the optimization in CPython is that it only
triggers if the reference count of <code class="docutils literal">b</code> is 1, in which case it uses <code class="docutils literal">realloc</code>
on the string. The change is unrealistic of course, but you could imagine a
related that keeps an extra reference to <code class="docutils literal">b</code> for a sensible reason.</p>
<p>Another situation in which the optimization doesn't work is discussed in this
<a class="reference external" href="https://stackoverflow.com/a/44487738">StackOverflow question</a> with an answer by Tim Peters.</p>
<p>It's unlikely that PyPy will fix this. We had a prototype how to do it, but it
seems very little "production" code uses <cite>+=</cite> on strings in a loop, and the fix
makes the strings implementation quite a bit more complex.</p>
<p>So, in summary, don't use repeated concatenations in a loop!</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/12/pypy-v7311-release.html" class="u-url">PyPy v7.3.11 release</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/12/pypy-v7311-release.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-12-29T13:22:08Z" itemprop="datePublished" title="2022-12-29 13:22">2022-12-29 13:22</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-11-release-of-python-2-7-3-8-and-3-9"><h2>PyPy v7.3.11: release of python 2.7, 3.8, and 3.9</h2>
<p>The PyPy team is proud to release version 7.3.11 of PyPy. As could be expected,
the first release of macOS arm64 impacted the macOS x86-64 build, so this is
a bug release to restore the ability of macOS users to run PyPy on
<code class="docutils literal">macOS &lt; 11.0</code>. It also incorporates the latest CPython stdlib updates
released the day after 7.3.10 went out, and a few more bug fixes. The release
includes three different interpreters:</p>
<blockquote>
<ul class="simple">
<li><p>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.18+ (the <code class="docutils literal">+</code> is for
backported security updates)</p></li>
<li><p>PyPy3.8, which is an interpreter supporting the syntax and the features of
Python 3.8, including the stdlib for CPython 3.8.16. Note we intend to drop
support for this version in an upcoming release as soon as we release
Pyython 3.10.</p></li>
<li><p>PyPy3.9, which is an interpreter supporting the syntax and the features of
Python 3.9, including the stdlib for CPython 3.9.16.</p></li>
</ul>
</blockquote>
<p>The interpreters are based on much the same codebase, thus the multiple
release. This is a micro release, all APIs are compatible with the other 7.3
releases and follows quickly on the heals of the 7.3.10 release on Dec 6.</p>
<p>We recommend updating. You can find links to download the v7.3.11 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
<a class="reference external" href="https://www.pypy.org/pypy-sponsors.html">direct consulting</a> work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">blog</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: bug fixes,
<a class="reference external" href="../posts/2022/12/index.html">PyPy</a> and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, or general <a class="reference external" href="../posts/2022/12/project-ideas.html">help</a> with making
RPython's JIT even better. Since the previous release, we have accepted
contributions from one new contributor, thanks for pitching in, and welcome
to the project!</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a <a class="reference external" href="https://hpyproject.org/">HPy</a> / <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> / <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> version of your library that would be performant
on PyPy.
In any case, both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.8 and
3.9. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>We provide binary builds for:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS 64 bits, Windows 64 bits)</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux (<code class="docutils literal">aarch64</code>).</p></li>
<li><p>Apple <strong>M1 arm64</strong> machines (<code class="docutils literal">macos_arm64</code>).</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
</ul>
</blockquote>
<p>PyPy support Windows 32-bit, Linux PPC64 big- and little-endian, and Linux ARM
32 bit, but does not release binaries. Please reach out to us if you wish to
sponsor binary releases for those platforms. Downstream packagers provide
binary builds for debian, Fedora, conda, OpenBSD, FreeBSD, Gentoo, and more.</p>
</section><section id="what-else-is-new"><h3>What else is new?</h3>
<p>For more information about the 7.3.11 release, see the <a class="reference external" href="https://doc.pypy.org/en/latest/release-v7.3.11.html#changelog">full changelog</a>.</p>
<p>Please update, and continue to help us make pypy better.</p>
<p>Cheers,
The PyPy Team</p>
</section></section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html" class="u-url">Finding JIT Optimizer Bugs using SMT Solvers and Fuzzing</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-12-11T18:00:00Z" itemprop="datePublished" title="2022-12-11 18:00">2022-12-11 18:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <p>In this blog post I want to describe a recent bug finding technique that I've
added to the PyPy JIT testing infrastructure. This technique uses the Z3
theorem prover to find bugs in the optimizer of PyPy's JIT, in particular its
integer operation optimizations. The approach is
based on things I have learned from <a class="reference external" href="https://www.cs.utah.edu/~regehr/">John Regehr's</a> <a class="reference external" href="https://blog.regehr.org/">blog</a> (<a class="reference external" href="https://blog.regehr.org/archives/1122">this post</a> is a
good first one to read), <a class="reference external" href="https://twitter.com/johnregehr/">Twitter</a>, and on
his (et al) paper <a class="reference external" href="https://www.cs.utah.edu/~regehr/alive2-pldi21.pdf">Alive2: Bounded Translation Validation for LLVM</a>. The work
was triggered by a recent miscompilation bug my current bachelor student Nico
Rittinghaus found.</p>
<section id="background-python-integers-in-the-pypy-jit"><h2>Background: Python Integers in the PyPy JIT</h2>
<p>The optimizer of PyPy's JITs operates on traces, which are linear sequences of
instructions with guards. The instructions in the traces operate on different
machine-level data types, machine integers, doubles, pointers, bools, etc. In
this post we'll be mostly concerned with machine integers.</p>
<p>To given some wider context I'll explain a bit how Python ints in the user code
relate to the types that are used in traces when the PyPy Python implementation
is used.
When PyPy turns a regular Python 3 function into a trace, there is a lot of work
happening in the JIT frontend to try to observe and infer the types that the
Python function concretely uses at runtime. The traces are generated under these
typing assumptions. Therefore, code that uses <code class="docutils literal">ints</code> in the Python code can
typically be translated into traces that operate on machine integers. In order
to make sure that the Python integer semantics are upheld, many of the
operations in the traces need to check that the integer results of some
operations still fit into a machine integer. If that is not the case (a rare
situation for most programs), the trace is left via a guard, execution falls
back to the interpreter, and there a big integer representation is chosen for
the too big value (the big integer representation is done via a pointer and
some storage on the heap).</p>
<p>All of this machinery is not going to be too relevant for the rest of the
post. For the post it's important to know that trace instructions operate on
machine integers and other low-level types, and some of the operations can
optionally check whether the
results still fit into a machine integer. These trace operations are improved by
the optimizer, which tries to transform the trace into one that behaves the
same, but is less costly to execute.</p>
</section><section id="background-bounds-analysis-in-pypy-s-jit"><h2>Background: Bounds Analysis in PyPy's JIT</h2>
<p>The optimizer of PyPy's JIT has an analysis based on <a class="reference external" href="https://en.wikipedia.org/wiki/Abstract_interpretation">abstract interpretation</a>
that tries to find out whether the integer values stored in a variable are
actually not using the full 64 bit (or 32 bit) range, but instead fit into some
smaller range. This means that for every integer variable <code class="docutils literal">x</code> in a trace, the
JIT compiler tracks upper and lower bounds of the runtime value of that
variable: a range <code class="docutils literal">[a, b]</code> such that for every concrete runtime value <code class="docutils literal">v</code>
that gets stored in variable <code class="docutils literal">x</code>, <code class="docutils literal">a &lt;= v &lt;= b</code> must be true.
<code class="docutils literal">a</code> and <code class="docutils literal">b</code> start out
as the most general <code class="docutils literal">MININT</code> and <code class="docutils literal">MAXINT</code>, but sometimes there is extra
information that makes it possible to improve these known bounds, and that is
often useful to optimize the code.</p>
<p>A typical example is that the JIT knows that the length of a string is
non-negative, so for this kind of code: <code class="docutils literal">x = len(s)</code> where <code class="docutils literal">s</code> is a string,
<code class="docutils literal">x</code> gets a range <code class="docutils literal">[0, MAXINT]</code> assigned. With this information we could for
example remove a check <code class="docutils literal">x + 10 &lt; 0</code> completely, because it can never be true.</p>
<p>The bounds information is useful for optimization, but the analysis of the
bounds is also a source of bugs in the JIT, because the reasoning is often
subtle and easy to get wrong in corner cases. We already use a number of testing
techniques to try to make sure that it is correct. A simple one is
<a class="reference external" href="https://hypothesis.works/articles/what-is-property-based-testing/">property-based testing</a> using <a class="reference external" href="https://github.com/HypothesisWorks/hypothesis">Hypothesis</a> on the operations on bounds. Even
though Hypothesis is fantastic, it unfortunately does not catch
absolutely all the bugs even if we'd like it too, as we'll see in the next
section.</p>
</section><section id="motivation-a-jit-miscompilation"><h2>Motivation: A JIT Miscompilation</h2>
<p>I am currently supervising a Bachelor thesis by Nico Rittinghaus, who is
extending the integer analysis in the JIT. He'll probably write a separate blog
post about that soon. In the process of his work, the current bounds analysis
code got a lot of scrutiny, and we found out that one of the unit tests of the
bounds analysis was actually incorrect, and the example code in that unit test
was optimized incorrectly. This case of incorrect optimization is not a big deal
for regular Python code, because it involved a "wrapping integer addition
operation", i.e. one where overflowing results just wrap around to negative
values. All the additions and other arithmetic operations that the PyPy Python
frontend generates actually have
overflow checks (to be able to switch to a big integer representation if
needed).
However, it's still possible to trigger the problem with the
<code class="docutils literal">__pypy__.intop.int_add</code> API which is a function that exposes wraparound
arithmetic on Python ints.</p>
<p><a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3832">Here's the miscompilation</a>. The JIT optimizes the following function:</p>
<div class="code"><pre class="code python"><a id="rest_code_624f854e490e4367a5446bbc422fcfab-1" name="rest_code_624f854e490e4367a5446bbc422fcfab-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_624f854e490e4367a5446bbc422fcfab-1"></a><span class="kn">import</span> <span class="nn">__pypy__</span>
<a id="rest_code_624f854e490e4367a5446bbc422fcfab-2" name="rest_code_624f854e490e4367a5446bbc422fcfab-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_624f854e490e4367a5446bbc422fcfab-2"></a>
<a id="rest_code_624f854e490e4367a5446bbc422fcfab-3" name="rest_code_624f854e490e4367a5446bbc422fcfab-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_624f854e490e4367a5446bbc422fcfab-3"></a><span class="k">def</span> <span class="nf">wrong</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="rest_code_624f854e490e4367a5446bbc422fcfab-4" name="rest_code_624f854e490e4367a5446bbc422fcfab-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_624f854e490e4367a5446bbc422fcfab-4"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">__pypy__</span><span class="o">.</span><span class="n">intop</span><span class="o">.</span><span class="n">int_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="rest_code_624f854e490e4367a5446bbc422fcfab-5" name="rest_code_624f854e490e4367a5446bbc422fcfab-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_624f854e490e4367a5446bbc422fcfab-5"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
<a id="rest_code_624f854e490e4367a5446bbc422fcfab-6" name="rest_code_624f854e490e4367a5446bbc422fcfab-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_624f854e490e4367a5446bbc422fcfab-6"></a>        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
<a id="rest_code_624f854e490e4367a5446bbc422fcfab-7" name="rest_code_624f854e490e4367a5446bbc422fcfab-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_624f854e490e4367a5446bbc422fcfab-7"></a>            <span class="k">return</span> <span class="mi">0</span>
<a id="rest_code_624f854e490e4367a5446bbc422fcfab-8" name="rest_code_624f854e490e4367a5446bbc422fcfab-8" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_624f854e490e4367a5446bbc422fcfab-8"></a>        <span class="k">return</span> <span class="mi">1</span>
<a id="rest_code_624f854e490e4367a5446bbc422fcfab-9" name="rest_code_624f854e490e4367a5446bbc422fcfab-9" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_624f854e490e4367a5446bbc422fcfab-9"></a>    <span class="k">return</span> <span class="mi">2</span>
</pre></div>
<p>Into the following code:</p>
<div class="code"><pre class="code python"><a id="rest_code_85ad103b2e314f549801bab35002f2d7-1" name="rest_code_85ad103b2e314f549801bab35002f2d7-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_85ad103b2e314f549801bab35002f2d7-1"></a><span class="kn">import</span> <span class="nn">__pypy__</span>
<a id="rest_code_85ad103b2e314f549801bab35002f2d7-2" name="rest_code_85ad103b2e314f549801bab35002f2d7-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_85ad103b2e314f549801bab35002f2d7-2"></a>
<a id="rest_code_85ad103b2e314f549801bab35002f2d7-3" name="rest_code_85ad103b2e314f549801bab35002f2d7-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_85ad103b2e314f549801bab35002f2d7-3"></a><span class="k">def</span> <span class="nf">wrong</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="rest_code_85ad103b2e314f549801bab35002f2d7-4" name="rest_code_85ad103b2e314f549801bab35002f2d7-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_85ad103b2e314f549801bab35002f2d7-4"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">__pypy__</span><span class="o">.</span><span class="n">intop</span><span class="o">.</span><span class="n">int_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="rest_code_85ad103b2e314f549801bab35002f2d7-5" name="rest_code_85ad103b2e314f549801bab35002f2d7-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_85ad103b2e314f549801bab35002f2d7-5"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
<a id="rest_code_85ad103b2e314f549801bab35002f2d7-6" name="rest_code_85ad103b2e314f549801bab35002f2d7-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_85ad103b2e314f549801bab35002f2d7-6"></a>        <span class="k">return</span> <span class="mi">0</span>
<a id="rest_code_85ad103b2e314f549801bab35002f2d7-7" name="rest_code_85ad103b2e314f549801bab35002f2d7-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_85ad103b2e314f549801bab35002f2d7-7"></a>    <span class="k">return</span> <span class="mi">2</span>
</pre></div>
<p>Basically the faulty reasoning of the JIT looks like this: if <code class="docutils literal">int_add(x, 10) &lt; 15</code>
then it must follow that <code class="docutils literal">x &lt; 5</code>, which is stronger than <code class="docutils literal">x &lt; 6</code>, so the
second <code class="docutils literal">if</code> is always true. This sounds good, but is actually wrong
if the addition <code class="docutils literal">+ 10</code> wrapped around. So if <code class="docutils literal">x == MAXINT</code>, then
<code class="docutils literal">int_add(x, 10) == MININT + 9 &lt; 15</code>. But <code class="docutils literal">MAXINT &lt; 5</code> is not
correct.</p>
<p>Note how the same reasoning with overflow-checking addition is correct! If <code class="docutils literal">x +
10 &lt; 15</code> and the <code class="docutils literal">+</code> didn't overflow, then indeed <code class="docutils literal">x &lt; 6</code>. And if your
mind bends starting to think about all this, you understand some of the
difficulty of getting the JIT correct in this area.</p>
</section><section id="how-could-we-have-avoided-this-bug"><h2>How could we have avoided this bug?</h2>
<p>One <a class="reference external" href="https://twitter.com/cfbolz/status/1482649144099586051">exercise I try to do after finding bugs</a> is to reflect on ways that the
bug could have been avoided. I think this is particularly important in the JIT,
where bugs are potentially really annoying to find and can cause very strange
behaviour in basically arbitrary Python code.</p>
<p>It's easy to always answer this question with "try to think more carefully
when working", but that approach cannot be relied on in complicated situations,
because humans don't concentrate perfectly for long stretches of time.</p>
<p>A situation-specific problem I identified was the bad design of the range analysis API.
A range is not just represented by two numbers, instead it's two numbers
and two bools that are supposed to represent that some operation did or did not
underflow/overflow. The meaning of these bools was quite hard to grasp and easy
to get wrong, so probably they should never have been introduced in the first
place (and my bugfix indeed removed them).</p>
<p>But in the rest of this blog post I want to talk about another, systematic
approach that can be applied to the problem of mis-optimizations of integer
operations, and that is done by applying an SMT solver to the problem.</p>
<p>An SMT solver (<a class="reference external" href="https://en.wikipedia.org/wiki/Satisfiability_modulo_theories">Satisfyability Modulo Theories</a>) is a tool that can be used to
find out whether mathematical formulas are "satisfiable", i.e. whether
some chosen set of inputs exists that will make the formulas evaluate to true. SMT solvers are
commonly used in a wide range of CS applications including program correctness
proofs, program synthesis, etc. The most widely known one is probably <a class="reference external" href="https://github.com/Z3Prover">Z3</a> by
Microsoft Research which has the nice advantage of coming with an easy-to-use
Python binding.</p>
<p>Going into this I basically knew next to nothing about SMT solvers (despite
having been embedded in a formal methods research group for years!) so it was an
interesting new world to learn about.</p>
<p>As briefly mentioned in the introduction, the approach I took followed a similar
(but <em>much</em> more properly executed) one applied to LLVM operations, called
<a class="reference external" href="https://github.com/AliveToolkit/alive2/">Alive2</a>. Krister Waldfridsson has done <a class="reference external" href="https://kristerw.github.io/2022/09/13/translation-validation/">similar work for GCC recently</a>,
described on his blog.</p>
</section><section id="z3-proof-of-concept"><h2>Z3 Proof of Concept</h2>
<p>The first thing I did was to try to get Z3 find the above bug, by encoding the
input program into an SMT formula by hand and trying to get Z3 to prove the condition
that the JIT thinks is always true. The Z3 code for this looks as follows:</p>
<div class="code"><pre class="code python"><a id="rest_code_9b5b113b0f734e43bd9b890fddac1400-1" name="rest_code_9b5b113b0f734e43bd9b890fddac1400-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_9b5b113b0f734e43bd9b890fddac1400-1"></a><span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="n">BitVec</span><span class="p">,</span> <span class="n">Implies</span><span class="p">,</span> <span class="n">prove</span>
<a id="rest_code_9b5b113b0f734e43bd9b890fddac1400-2" name="rest_code_9b5b113b0f734e43bd9b890fddac1400-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_9b5b113b0f734e43bd9b890fddac1400-2"></a><span class="n">x</span> <span class="o">=</span> <span class="n">BitVec</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<a id="rest_code_9b5b113b0f734e43bd9b890fddac1400-3" name="rest_code_9b5b113b0f734e43bd9b890fddac1400-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_9b5b113b0f734e43bd9b890fddac1400-3"></a><span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">10</span>
<a id="rest_code_9b5b113b0f734e43bd9b890fddac1400-4" name="rest_code_9b5b113b0f734e43bd9b890fddac1400-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_9b5b113b0f734e43bd9b890fddac1400-4"></a><span class="n">cond1</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">15</span>
<a id="rest_code_9b5b113b0f734e43bd9b890fddac1400-5" name="rest_code_9b5b113b0f734e43bd9b890fddac1400-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_9b5b113b0f734e43bd9b890fddac1400-5"></a><span class="n">cond2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">6</span>
<a id="rest_code_9b5b113b0f734e43bd9b890fddac1400-6" name="rest_code_9b5b113b0f734e43bd9b890fddac1400-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_9b5b113b0f734e43bd9b890fddac1400-6"></a><span class="n">prove</span><span class="p">(</span><span class="n">Implies</span><span class="p">(</span><span class="n">cond1</span><span class="p">,</span> <span class="n">cond2</span><span class="p">))</span>
</pre></div>
<p>Here, <code class="docutils literal">x</code> is defined to be a bit vector variable of width 64, which is a
datatype that can be used to represent bounded machine integers. Addition on
bit vectors performs wraparound arithmetic, like the <code class="docutils literal">__pypy__.intop.int_add</code>
call in the original code. The JIT optimized the second condition away, so
essentially it was convinced that the first condition implies the second one.
The above snippet tries to get Z3 to confirm this.</p>
<p>When run, the above program prints:</p>
<pre class="literal-block">counterexample
[x = 9223372036854775803]</pre>
<p>Which shows the bug. As a small side-note, I thought it was cool that the
process of "proving" something in Z3 basically means trying to find an example
for the negation of the formula. If no counterexample can be found for the
negation, the original formula is true. If the original formula turns out to be
false (like here) we get a nice example that shows the problem to go with it.</p>
<p>It's not realistic to hand-translate all the hundreds of
unit-tests into Z3 formulas and then ask Z3 to prove the optimizations. Instead,
we want to have a program that does this for us.</p>
</section><section id="smt-checking-of-the-jit-optimizer"><h2>SMT Checking of the JIT Optimizer</h2>
<p>What we want from this program is the following: given an unoptimized trace and
its optimized version, we want to use Z3 to check whether the optimized trace
behaves identically to the unoptimized one. One question is what "behaves
identically" means. What we care about is the outputs of the trace being the
same values, no matter how they are computed. Also, for every guard we want to
make sure that it fails in identical ways in the optimized and unoptimized
versions. A guard is only allowed to be optimized away if it can never fail.
The code that comes after a guard can assume that the guard has not failed,
because otherwise execution would have left the trace. All of this should be
true regardless for the values of the input variables of the trace.</p>
<p>So in order to check that the two traces are behaving identically, we do the
following:</p>
<ul class="simple">
<li><p>We create Z3 variables for every input variable. We use the same input
variables both for the unoptimized as well as the optimized trace.</p></li>
<li><p>We align the two traces at the corresponding guards. Thankfully the optimizer
keeps track of which optimized guard corresponds to which unoptimized input
guard.</p></li>
<li><p>All the operations before a guard are translated into Z3 formulas, for both
versions of the trace.</p></li>
<li><p>For two corresponding guards, we ask Z3 to prove that the guard conditions are
identical.</p></li>
<li><p>For a guard that was optimized away we ask Z3 to prove that the condition is
always true.</p></li>
<li><p>After a guard, we tell Z3 that from now on it can assume that the guard
condition is true.</p></li>
<li><p>We repeat this, guard for guard, until we reach the end of the trace. There,
we ask Z3 to prove that the output variables in the unoptimized trace and the
optimized trace are identical (every trace can return one or many values).</p></li>
</ul>
<p>I implemented this, it's <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/blob/branch/default/rpython/jit/metainterp/optimizeopt/test/test_z3checktests.py">not a lot of code</a>, basically a couple of hundred lines
of (somewhat hacky) Python code. So far I only support integer
operations. Here are some parts of the code to give you a flavor of what this
looks like.</p>
<p>This is the code that translates operations into Z3 formulas:</p>
<div class="code"><pre class="code python"><a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-1" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-1"></a><span class="k">def</span> <span class="nf">add_to_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-2" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-2"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-3" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-3"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">'v'</span><span class="p">:</span> <span class="c1"># is it an operation with a result</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-4" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-4"></a>            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newvar</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-5" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-5"></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># or does it return void</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-6" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-6"></a>            <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-7" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-7"></a>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-8" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-8" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-8"></a>       <span class="c1"># ...</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-9" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-9" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-9"></a>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-10" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-10" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-10"></a>        <span class="c1"># convert arguments</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-11" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-11" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-11"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">numargs</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-12" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-12" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-12"></a>            <span class="n">arg0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertarg</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-13" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-13" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-13"></a>        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">numargs</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-14" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-14" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-14"></a>            <span class="n">arg0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertarg</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-15" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-15" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-15"></a>            <span class="n">arg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertarg</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-16" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-16" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-16"></a>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-17" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-17" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-17"></a>        <span class="c1"># compute results</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-18" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-18" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-18"></a>        <span class="k">if</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_add"</span><span class="p">:</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-19" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-19" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-19"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">arg0</span> <span class="o">+</span> <span class="n">arg1</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-20" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-20" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-20"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_sub"</span><span class="p">:</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-21" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-21" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-21"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">arg0</span> <span class="o">-</span> <span class="n">arg1</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-22" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-22" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-22"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_mul"</span><span class="p">:</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-23" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-23" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-23"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">arg0</span> <span class="o">*</span> <span class="n">arg1</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-24" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-24" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-24"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_and"</span><span class="p">:</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-25" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-25" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-25"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">arg0</span> <span class="o">&amp;</span> <span class="n">arg1</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-26" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-26" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-26"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_or"</span><span class="p">:</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-27" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-27" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-27"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">arg0</span> <span class="o">|</span> <span class="n">arg1</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-28" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-28" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-28"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_xor"</span><span class="p">:</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-29" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-29" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-29"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">arg0</span> <span class="o">^</span> <span class="n">arg1</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-30" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-30" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-30"></a>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-31" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-31" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-31"></a>        <span class="c1"># ...  more operations, some shown below</span>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-32" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-32" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-32"></a>
<a id="rest_code_3b3ae8b967b943caaffe9781dfa5d298-33" name="rest_code_3b3ae8b967b943caaffe9781dfa5d298-33" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_3b3ae8b967b943caaffe9781dfa5d298-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">expr</span><span class="p">)</span>
</pre></div>
<p>New Z3 variables are defined by the helper function <code class="docutils literal">newvar</code>, which adds the
operation to a dictionary <code class="docutils literal">box_to_z3</code> mapping boxes (=variables) to Z3
variables. Due to the <a class="reference external" href="https://en.wikipedia.org/wiki/Static_single-assignment_form">SSA</a> property that traces have, a variable must be defined
before its first use.</p>
<p>Here's what <code class="docutils literal">newvar</code> looks like (<code class="docutils literal">LONG_BIT</code> is a constant that is either
<code class="docutils literal">64</code> or <code class="docutils literal">32</code>, depending on the target architecture):</p>
<div class="code"><pre class="code python"><a id="rest_code_b07ef9de6d0b4628b7890e7d185e7638-1" name="rest_code_b07ef9de6d0b4628b7890e7d185e7638-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_b07ef9de6d0b4628b7890e7d185e7638-1"></a><span class="k">def</span> <span class="nf">newvar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="rest_code_b07ef9de6d0b4628b7890e7d185e7638-2" name="rest_code_b07ef9de6d0b4628b7890e7d185e7638-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_b07ef9de6d0b4628b7890e7d185e7638-2"></a>    <span class="c1"># ... some logic around making the string representation</span>
<a id="rest_code_b07ef9de6d0b4628b7890e7d185e7638-3" name="rest_code_b07ef9de6d0b4628b7890e7d185e7638-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_b07ef9de6d0b4628b7890e7d185e7638-3"></a>    <span class="c1"># somewhat nicer omitted</span>
<a id="rest_code_b07ef9de6d0b4628b7890e7d185e7638-4" name="rest_code_b07ef9de6d0b4628b7890e7d185e7638-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_b07ef9de6d0b4628b7890e7d185e7638-4"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">BitVec</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">LONG_BIT</span><span class="p">)</span>
<a id="rest_code_b07ef9de6d0b4628b7890e7d185e7638-5" name="rest_code_b07ef9de6d0b4628b7890e7d185e7638-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_b07ef9de6d0b4628b7890e7d185e7638-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">box_to_z3</span><span class="p">[</span><span class="n">box</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
<a id="rest_code_b07ef9de6d0b4628b7890e7d185e7638-6" name="rest_code_b07ef9de6d0b4628b7890e7d185e7638-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_b07ef9de6d0b4628b7890e7d185e7638-6"></a>    <span class="k">return</span> <span class="n">result</span>
</pre></div>
<p>The <code class="docutils literal">convert</code> method turns an operation argument (either a constant or a
variable) into a Z3 formula (either a constant bit vector or an already defined
Z3 variable). <code class="docutils literal">convertarg</code> is a helper function that takes an operation, reads
its nth argument and converts it.</p>
<div class="code"><pre class="code python"><a id="rest_code_37152c2e2e3644358b0d3e061b80ae34-1" name="rest_code_37152c2e2e3644358b0d3e061b80ae34-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_37152c2e2e3644358b0d3e061b80ae34-1"></a><span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
<a id="rest_code_37152c2e2e3644358b0d3e061b80ae34-2" name="rest_code_37152c2e2e3644358b0d3e061b80ae34-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_37152c2e2e3644358b0d3e061b80ae34-2"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">ConstInt</span><span class="p">):</span>
<a id="rest_code_37152c2e2e3644358b0d3e061b80ae34-3" name="rest_code_37152c2e2e3644358b0d3e061b80ae34-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_37152c2e2e3644358b0d3e061b80ae34-3"></a>        <span class="k">return</span> <span class="n">z3</span><span class="o">.</span><span class="n">BitVecVal</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">getint</span><span class="p">(),</span> <span class="n">LONG_BIT</span><span class="p">)</span>
<a id="rest_code_37152c2e2e3644358b0d3e061b80ae34-4" name="rest_code_37152c2e2e3644358b0d3e061b80ae34-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_37152c2e2e3644358b0d3e061b80ae34-4"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_to_z3</span><span class="p">[</span><span class="n">box</span><span class="p">]</span>
<a id="rest_code_37152c2e2e3644358b0d3e061b80ae34-5" name="rest_code_37152c2e2e3644358b0d3e061b80ae34-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_37152c2e2e3644358b0d3e061b80ae34-5"></a>
<a id="rest_code_37152c2e2e3644358b0d3e061b80ae34-6" name="rest_code_37152c2e2e3644358b0d3e061b80ae34-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_37152c2e2e3644358b0d3e061b80ae34-6"></a><span class="k">def</span> <span class="nf">convertarg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<a id="rest_code_37152c2e2e3644358b0d3e061b80ae34-7" name="rest_code_37152c2e2e3644358b0d3e061b80ae34-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_37152c2e2e3644358b0d3e061b80ae34-7"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
</pre></div>
<p>The lookup of variables in <code class="docutils literal">box_to_z3</code> that <code class="docutils literal">convert</code> does cannot fail,
because the variable must have been defined before use.</p>
<p>Comparisons return the bit vector 0 or bit vector 1, we use a helper function
<code class="docutils literal">cond</code> to turn the Z3 truth value of the comparison into a bit vector:</p>
<div class="code"><pre class="code python"><a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-1" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-1"></a><span class="k">def</span> <span class="nf">cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z3expr</span><span class="p">):</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-2" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-2"></a>    <span class="k">return</span> <span class="n">z3</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">z3expr</span><span class="p">,</span> <span class="n">TRUEBV</span><span class="p">,</span> <span class="n">FALSEBV</span><span class="p">)</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-3" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-3"></a>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-4" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-4"></a>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-5" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-5"></a><span class="k">def</span> <span class="nf">add_to_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-6" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-6"></a>        <span class="c1"># ... start as above</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-7" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-7"></a>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-8" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-8" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-8"></a>        <span class="c1"># more cases</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-9" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-9" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-9"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_eq"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-10" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-10" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-10"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">arg0</span> <span class="o">==</span> <span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-11" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-11" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-11"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_ne"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-12" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-12" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-12"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">arg0</span> <span class="o">!=</span> <span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-13" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-13" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-13"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_lt"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-14" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-14" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-14"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">arg0</span> <span class="o">&lt;</span> <span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-15" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-15" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-15"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_le"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-16" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-16" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-16"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">arg0</span> <span class="o">&lt;=</span> <span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-17" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-17" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-17"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_gt"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-18" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-18" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-18"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">arg0</span> <span class="o">&gt;</span> <span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-19" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-19" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-19"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_ge"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-20" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-20" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-20"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">arg0</span> <span class="o">&gt;=</span> <span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-21" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-21" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-21"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_is_true"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-22" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-22" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-22"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">arg0</span> <span class="o">!=</span> <span class="n">FALSEBV</span><span class="p">)</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-23" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-23" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-23"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"uint_lt"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-24" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-24" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-24"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">ULT</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">))</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-25" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-25" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-25"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"uint_le"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-26" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-26" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-26"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">ULE</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">))</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-27" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-27" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-27"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"uint_gt"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-28" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-28" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-28"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">UGT</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">))</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-29" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-29" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-29"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"uint_ge"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-30" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-30" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-30"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">UGE</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">))</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-31" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-31" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-31"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_is_zero"</span><span class="p">:</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-32" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-32" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-32"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">arg0</span> <span class="o">==</span> <span class="n">FALSEBV</span><span class="p">)</span>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-33" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-33" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-33"></a>
<a id="rest_code_89659c3864984b52a4f7cb8982a9fed4-34" name="rest_code_89659c3864984b52a4f7cb8982a9fed4-34" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_89659c3864984b52a4f7cb8982a9fed4-34"></a>        <span class="c1"># ... rest as above</span>
</pre></div>
<p>So basically for every trace operation that operates on integers I had to give a
translation into Z3 formulas, which is mostly straightforward.</p>
<p>Guard operations get converted into a Z3 boolean by their own helper function,
which looks like this:</p>
<div class="code"><pre class="code python"><a id="rest_code_0ce7f1ff6b5c44839d42d661352e808e-1" name="rest_code_0ce7f1ff6b5c44839d42d661352e808e-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_0ce7f1ff6b5c44839d42d661352e808e-1"></a><span class="k">def</span> <span class="nf">guard_to_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guard</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<a id="rest_code_0ce7f1ff6b5c44839d42d661352e808e-2" name="rest_code_0ce7f1ff6b5c44839d42d661352e808e-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_0ce7f1ff6b5c44839d42d661352e808e-2"></a>    <span class="n">opname</span> <span class="o">=</span> <span class="n">guard</span><span class="o">.</span><span class="n">getopname</span><span class="p">()</span>
<a id="rest_code_0ce7f1ff6b5c44839d42d661352e808e-3" name="rest_code_0ce7f1ff6b5c44839d42d661352e808e-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_0ce7f1ff6b5c44839d42d661352e808e-3"></a>    <span class="k">if</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"guard_true"</span><span class="p">:</span>
<a id="rest_code_0ce7f1ff6b5c44839d42d661352e808e-4" name="rest_code_0ce7f1ff6b5c44839d42d661352e808e-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_0ce7f1ff6b5c44839d42d661352e808e-4"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertarg</span><span class="p">(</span><span class="n">guard</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUEBV</span>
<a id="rest_code_0ce7f1ff6b5c44839d42d661352e808e-5" name="rest_code_0ce7f1ff6b5c44839d42d661352e808e-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_0ce7f1ff6b5c44839d42d661352e808e-5"></a>    <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"guard_false"</span><span class="p">:</span>
<a id="rest_code_0ce7f1ff6b5c44839d42d661352e808e-6" name="rest_code_0ce7f1ff6b5c44839d42d661352e808e-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_0ce7f1ff6b5c44839d42d661352e808e-6"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertarg</span><span class="p">(</span><span class="n">guard</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSEBV</span>
<a id="rest_code_0ce7f1ff6b5c44839d42d661352e808e-7" name="rest_code_0ce7f1ff6b5c44839d42d661352e808e-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_0ce7f1ff6b5c44839d42d661352e808e-7"></a>    <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"guard_value"</span><span class="p">:</span>
<a id="rest_code_0ce7f1ff6b5c44839d42d661352e808e-8" name="rest_code_0ce7f1ff6b5c44839d42d661352e808e-8" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_0ce7f1ff6b5c44839d42d661352e808e-8"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertarg</span><span class="p">(</span><span class="n">guard</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertarg</span><span class="p">(</span><span class="n">guard</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="rest_code_0ce7f1ff6b5c44839d42d661352e808e-9" name="rest_code_0ce7f1ff6b5c44839d42d661352e808e-9" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_0ce7f1ff6b5c44839d42d661352e808e-9"></a>
<a id="rest_code_0ce7f1ff6b5c44839d42d661352e808e-10" name="rest_code_0ce7f1ff6b5c44839d42d661352e808e-10" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_0ce7f1ff6b5c44839d42d661352e808e-10"></a>    <span class="c1"># ... some more exist, shown below</span>
</pre></div>
<p>Some operations are a bit trickier. An important example in the context of
this blog post are integer operations that check for overflow. The overflow
operations return a result, but also a boolean whether the operation overflowed
or not.</p>
<div class="code"><pre class="code python"><a id="rest_code_61111b0c7307431ba148ef0074d18328-1" name="rest_code_61111b0c7307431ba148ef0074d18328-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-1"></a><span class="k">def</span> <span class="nf">add_to_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-2" name="rest_code_61111b0c7307431ba148ef0074d18328-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-2"></a>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-3" name="rest_code_61111b0c7307431ba148ef0074d18328-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-3"></a>        <span class="c1"># ... more cases</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-4" name="rest_code_61111b0c7307431ba148ef0074d18328-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-4"></a>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-5" name="rest_code_61111b0c7307431ba148ef0074d18328-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-5"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_add_ovf"</span><span class="p">:</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-6" name="rest_code_61111b0c7307431ba148ef0074d18328-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-6"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">arg0</span> <span class="o">+</span> <span class="n">arg1</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-7" name="rest_code_61111b0c7307431ba148ef0074d18328-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-7"></a>            <span class="n">m</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">SignExt</span><span class="p">(</span><span class="n">LONG_BIT</span><span class="p">,</span> <span class="n">arg0</span><span class="p">)</span> <span class="o">+</span> <span class="n">z3</span><span class="o">.</span><span class="n">SignExt</span><span class="p">(</span><span class="n">LONG_BIT</span><span class="p">,</span> <span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-8" name="rest_code_61111b0c7307431ba148ef0074d18328-8" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-8"></a>            <span class="n">state</span><span class="o">.</span><span class="n">no_ovf</span> <span class="o">=</span> <span class="n">m</span> <span class="o">==</span> <span class="n">z3</span><span class="o">.</span><span class="n">SignExt</span><span class="p">(</span><span class="n">LONG_BIT</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-9" name="rest_code_61111b0c7307431ba148ef0074d18328-9" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-9"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_sub_ovf"</span><span class="p">:</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-10" name="rest_code_61111b0c7307431ba148ef0074d18328-10" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-10"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">arg0</span> <span class="o">-</span> <span class="n">arg1</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-11" name="rest_code_61111b0c7307431ba148ef0074d18328-11" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-11"></a>            <span class="n">m</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">SignExt</span><span class="p">(</span><span class="n">LONG_BIT</span><span class="p">,</span> <span class="n">arg0</span><span class="p">)</span> <span class="o">-</span> <span class="n">z3</span><span class="o">.</span><span class="n">SignExt</span><span class="p">(</span><span class="n">LONG_BIT</span><span class="p">,</span> <span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-12" name="rest_code_61111b0c7307431ba148ef0074d18328-12" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-12"></a>            <span class="n">state</span><span class="o">.</span><span class="n">no_ovf</span> <span class="o">=</span> <span class="n">m</span> <span class="o">==</span> <span class="n">z3</span><span class="o">.</span><span class="n">SignExt</span><span class="p">(</span><span class="n">LONG_BIT</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-13" name="rest_code_61111b0c7307431ba148ef0074d18328-13" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-13"></a>        <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"int_mul_ovf"</span><span class="p">:</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-14" name="rest_code_61111b0c7307431ba148ef0074d18328-14" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-14"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">arg0</span> <span class="o">*</span> <span class="n">arg1</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-15" name="rest_code_61111b0c7307431ba148ef0074d18328-15" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-15"></a>            <span class="n">m</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">SignExt</span><span class="p">(</span><span class="n">LONG_BIT</span><span class="p">,</span> <span class="n">arg0</span><span class="p">)</span> <span class="o">*</span> <span class="n">z3</span><span class="o">.</span><span class="n">SignExt</span><span class="p">(</span><span class="n">LONG_BIT</span><span class="p">,</span> <span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-16" name="rest_code_61111b0c7307431ba148ef0074d18328-16" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-16"></a>            <span class="n">state</span><span class="o">.</span><span class="n">no_ovf</span> <span class="o">=</span> <span class="n">m</span> <span class="o">==</span> <span class="n">z3</span><span class="o">.</span><span class="n">SignExt</span><span class="p">(</span><span class="n">LONG_BIT</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-17" name="rest_code_61111b0c7307431ba148ef0074d18328-17" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-17"></a>
<a id="rest_code_61111b0c7307431ba148ef0074d18328-18" name="rest_code_61111b0c7307431ba148ef0074d18328-18" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_61111b0c7307431ba148ef0074d18328-18"></a>        <span class="c1"># ...</span>
</pre></div>
<p>The boolean is computed by comparing the result of the bit vector operation with
the result of converting the input bit vectors into an abstract (arbitrary
precision) integer and the result back to bit vectors. Let's go through the
addition case step by step, the other cases work analogously.</p>
<p>The addition in the first <code class="docutils literal">elif</code> that computes <code class="docutils literal">expr</code> is an addition on bit
vectors, therefore it is performing wraparound arithmetic.
<code class="docutils literal">z3.SignExt(LONG_BIT, arg0)</code> sign-extends <code class="docutils literal">arg0</code> from a bit vector of
<code class="docutils literal">LONG_BIT</code> bits to an abstract, arbitrary precision integer. The addition in
the second line is therefore an addition between abstract integers, so it will
never overflow and just compute the correct result as an integer.</p>
<p>The condition to check for overflow is now: if the results of the two different
ways to do the addition are the same, then overflow did not occur. So in order
to compute <code class="docutils literal">state.no_ovf</code> in the addition case the
code converts the result of the bit vector wraparound addition to
an abstract integer (using <code class="docutils literal">SignExt</code> again), and then compares that to the integer
result.</p>
<p>This boolean can then be checked by the guard operations <code class="docutils literal">guard_no_overflow</code>
and <code class="docutils literal">guard_overflow</code>.</p>
<div class="code"><pre class="code python"><a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-1" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-1"></a><span class="k">def</span> <span class="nf">guard_to_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guard</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-2" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-2"></a>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-3" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-3"></a>    <span class="c1"># ... more cases</span>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-4" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-4"></a>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-5" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-5"></a>    <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"guard_no_overflow"</span><span class="p">:</span>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-6" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-6"></a>        <span class="k">assert</span> <span class="n">state</span><span class="o">.</span><span class="n">no_ovf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-7" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-7"></a>        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">no_ovf</span>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-8" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-8" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-8"></a>    <span class="k">elif</span> <span class="n">opname</span> <span class="o">==</span> <span class="s2">"guard_overflow"</span><span class="p">:</span>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-9" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-9" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-9"></a>        <span class="k">assert</span> <span class="n">state</span><span class="o">.</span><span class="n">no_ovf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-10" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-10" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-10"></a>        <span class="k">return</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">no_ovf</span><span class="p">)</span>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-11" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-11" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-11"></a>
<a id="rest_code_4cb8b43f209747a7a35c9b09132f5823-12" name="rest_code_4cb8b43f209747a7a35c9b09132f5823-12" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_4cb8b43f209747a7a35c9b09132f5823-12"></a>    <span class="c1"># ... more cases</span>
</pre></div>
</section><section id="finding-the-bug-again"><h2>Finding the Bug, Again</h2>
<p>Let's actually make all of this more concrete by applying it to the trace of our
original bug. The input trace and the incorrectly optimized trace for that look
like this (differences highlighted):</p>
<div class="code"><pre class="code python"><a id="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-1" name="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-1"></a><span class="c1"># input                       # optimized</span>
<a id="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-2" name="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-2"></a><span class="p">[</span><span class="n">i0</span><span class="p">]</span>                          <span class="p">[</span><span class="n">i0</span><span class="p">]</span>
<a id="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-3" name="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-3"></a><span class="n">i1</span> <span class="o">=</span> <span class="n">int_add</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>          <span class="n">i1</span> <span class="o">=</span> <span class="n">int_add</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-4" name="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-4"></a><span class="n">i2</span> <span class="o">=</span> <span class="n">int_lt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>           <span class="n">i2</span> <span class="o">=</span> <span class="n">int_lt</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<a id="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-5" name="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-5"></a><span class="n">guard_true</span><span class="p">(</span><span class="n">i2</span><span class="p">)</span>                <span class="n">guard_true</span><span class="p">(</span><span class="n">i2</span><span class="p">)</span>
<a id="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-6" name="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-6"></a><span class="hll"><span class="n">i3</span> <span class="o">=</span> <span class="n">int_lt</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>            <span class="n">jump</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><a id="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-7" name="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-7"></a><span class="hll"><span class="n">guard_true</span><span class="p">(</span><span class="n">i3</span><span class="p">)</span>
</span><a id="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-8" name="rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-8" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_84a312f64bdb4ad38b4a8473c1cc2efa-8"></a><span class="hll"><span class="n">jump</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>
<p>Note that the trace represents just one of the paths through the control flow
graph of the original function, which is typical for tracing JITs (the other
paths could incrementally get added later).</p>
<p>The first guards in both these traces correspond to each other, so the first
chunks to check are the first three operations (lines 1-4). Those operations
don't get changed by the optimizer at all.</p>
<p>These two identical traces get translated to the following Z3 formulas:</p>
<div class="code"><pre class="code text"><a id="rest_code_5576b2f9772747189ccddd6cf0633b26-1" name="rest_code_5576b2f9772747189ccddd6cf0633b26-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_5576b2f9772747189ccddd6cf0633b26-1"></a>i1unoptimized == input_i0 + 10
<a id="rest_code_5576b2f9772747189ccddd6cf0633b26-2" name="rest_code_5576b2f9772747189ccddd6cf0633b26-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_5576b2f9772747189ccddd6cf0633b26-2"></a>i2unoptimized == If(i1unoptimized &lt; 15, 1, 0)
<a id="rest_code_5576b2f9772747189ccddd6cf0633b26-3" name="rest_code_5576b2f9772747189ccddd6cf0633b26-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_5576b2f9772747189ccddd6cf0633b26-3"></a>i1optimized == input_i0 + 10
<a id="rest_code_5576b2f9772747189ccddd6cf0633b26-4" name="rest_code_5576b2f9772747189ccddd6cf0633b26-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_5576b2f9772747189ccddd6cf0633b26-4"></a>i2optimized == If(i1optimized &lt; 15, 1, 0)
</pre></div>
<p>To check that the two corresponding guards are the same, the solver is asked to
prove that <code class="docutils literal">(i2unoptimized == 1) == (i2optimized == 1)</code>. This is
correct, because the formulas for <code class="docutils literal">i2unoptimized</code> and <code class="docutils literal">i2optimized</code> are
completely identical.</p>
<p>After checking that the guards behave the same, we add the knowledge to the
solver that the guards passed. So the Z3 formulas become:</p>
<div class="code"><pre class="code text"><a id="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-1" name="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-1"></a>i1unoptimized == input_i0 + 10
<a id="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-2" name="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-2"></a>i2unoptimized == If(i1unoptimized &lt; 15, 1, 0)
<a id="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-3" name="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-3"></a>i1optimized == input_i0 + 10
<a id="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-4" name="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-4"></a>i2optimized == If(i1optimized &lt; 15, 1, 0)
<a id="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-5" name="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-5"></a>i1optimized == 1
<a id="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-6" name="rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_52b2cd8c71e843ae932ad5d2e9c661e9-6"></a>i2optimized == 1
</pre></div>
<p>Now we continue with the remaining operations of the two traces (lines 6-8).</p>
<p>We start by adding the <code class="docutils literal">int_lt</code> operation in the unoptimized trace to the Z3
formulas:</p>
<div class="code"><pre class="code text"><a id="rest_code_079d18470dd54d6dbb16ef9c666783e3-1" name="rest_code_079d18470dd54d6dbb16ef9c666783e3-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_079d18470dd54d6dbb16ef9c666783e3-1"></a>...
<a id="rest_code_079d18470dd54d6dbb16ef9c666783e3-2" name="rest_code_079d18470dd54d6dbb16ef9c666783e3-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_079d18470dd54d6dbb16ef9c666783e3-2"></a>i3unoptimized == If(input_i0 &lt; 6, 1, 0)
</pre></div>
<p>Because the second guard was optimized away, we need to ask Z3 to prove that
<code class="docutils literal">i3unoptimized == 1</code> is always true, which fails and gives the following
counterexample:</p>
<div class="code"><pre class="code text"><a id="rest_code_ab539927cd5d4008a09593ec7209b164-1" name="rest_code_ab539927cd5d4008a09593ec7209b164-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_ab539927cd5d4008a09593ec7209b164-1"></a>input_i0 = 9223372036854775800
<a id="rest_code_ab539927cd5d4008a09593ec7209b164-2" name="rest_code_ab539927cd5d4008a09593ec7209b164-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_ab539927cd5d4008a09593ec7209b164-2"></a>i1unoptimized = 9223372036854775810
<a id="rest_code_ab539927cd5d4008a09593ec7209b164-3" name="rest_code_ab539927cd5d4008a09593ec7209b164-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_ab539927cd5d4008a09593ec7209b164-3"></a>i2unoptimized = 0
<a id="rest_code_ab539927cd5d4008a09593ec7209b164-4" name="rest_code_ab539927cd5d4008a09593ec7209b164-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_ab539927cd5d4008a09593ec7209b164-4"></a>i1optimized = 9223372036854775810
<a id="rest_code_ab539927cd5d4008a09593ec7209b164-5" name="rest_code_ab539927cd5d4008a09593ec7209b164-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_ab539927cd5d4008a09593ec7209b164-5"></a>i2optimized = 1
<a id="rest_code_ab539927cd5d4008a09593ec7209b164-6" name="rest_code_ab539927cd5d4008a09593ec7209b164-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_ab539927cd5d4008a09593ec7209b164-6"></a>i3unoptimized = 0
</pre></div>
<p>Thus demonstrating the bug. The fact that the Z3-based equivalence check also
managed to find the original motivating bug without manually translating it to
a formula is a good confirmation that the approach works.</p>
</section><section id="second-bug"><h2>Second bug</h2>
<p>So with this code I applied the Z3-based equivalence check to all our optimizer
unit tests. In addition to the bug we've been discussing the whole post, it also
found another buggy test! I had found it too by hand by staring at all the tests
in the process of writing all the Z3 infrastructure, but it was still a good
confirmation that the process worked. This bug was in the range analysis for
<code class="docutils literal">int_neg</code>, integer negation. It failed to account that <code class="docutils literal"><span class="pre">-MININT</span> == MININT</code>
and therefore did a mis-optimization along the following lines:</p>
<div class="code"><pre class="code python"><a id="rest_code_71447cedeb484e7f835cd977b177841d-1" name="rest_code_71447cedeb484e7f835cd977b177841d-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_71447cedeb484e7f835cd977b177841d-1"></a><span class="kn">import</span> <span class="nn">__pypy__</span>
<a id="rest_code_71447cedeb484e7f835cd977b177841d-2" name="rest_code_71447cedeb484e7f835cd977b177841d-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_71447cedeb484e7f835cd977b177841d-2"></a>
<a id="rest_code_71447cedeb484e7f835cd977b177841d-3" name="rest_code_71447cedeb484e7f835cd977b177841d-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_71447cedeb484e7f835cd977b177841d-3"></a><span class="k">def</span> <span class="nf">wrong</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="rest_code_71447cedeb484e7f835cd977b177841d-4" name="rest_code_71447cedeb484e7f835cd977b177841d-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_71447cedeb484e7f835cd977b177841d-4"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">__pypy__</span><span class="o">.</span><span class="n">intop</span><span class="o">.</span><span class="n">int_sub</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<a id="rest_code_71447cedeb484e7f835cd977b177841d-5" name="rest_code_71447cedeb484e7f835cd977b177841d-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_71447cedeb484e7f835cd977b177841d-5"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="rest_code_71447cedeb484e7f835cd977b177841d-6" name="rest_code_71447cedeb484e7f835cd977b177841d-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_71447cedeb484e7f835cd977b177841d-6"></a>        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="rest_code_71447cedeb484e7f835cd977b177841d-7" name="rest_code_71447cedeb484e7f835cd977b177841d-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_71447cedeb484e7f835cd977b177841d-7"></a>            <span class="k">return</span> <span class="mi">0</span>
<a id="rest_code_71447cedeb484e7f835cd977b177841d-8" name="rest_code_71447cedeb484e7f835cd977b177841d-8" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_71447cedeb484e7f835cd977b177841d-8"></a>        <span class="k">return</span> <span class="mi">1</span>
<a id="rest_code_71447cedeb484e7f835cd977b177841d-9" name="rest_code_71447cedeb484e7f835cd977b177841d-9" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_71447cedeb484e7f835cd977b177841d-9"></a>    <span class="k">return</span> <span class="mi">2</span>
</pre></div>
<p>Which was wrongly optimized into:</p>
<div class="code"><pre class="code python"><a id="rest_code_c505b408552047ba8e607850b33a671a-1" name="rest_code_c505b408552047ba8e607850b33a671a-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_c505b408552047ba8e607850b33a671a-1"></a><span class="kn">import</span> <span class="nn">__pypy__</span>
<a id="rest_code_c505b408552047ba8e607850b33a671a-2" name="rest_code_c505b408552047ba8e607850b33a671a-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_c505b408552047ba8e607850b33a671a-2"></a>
<a id="rest_code_c505b408552047ba8e607850b33a671a-3" name="rest_code_c505b408552047ba8e607850b33a671a-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_c505b408552047ba8e607850b33a671a-3"></a><span class="k">def</span> <span class="nf">wrong</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="rest_code_c505b408552047ba8e607850b33a671a-4" name="rest_code_c505b408552047ba8e607850b33a671a-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_c505b408552047ba8e607850b33a671a-4"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">__pypy__</span><span class="o">.</span><span class="n">intop</span><span class="o">.</span><span class="n">int_sub</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<a id="rest_code_c505b408552047ba8e607850b33a671a-5" name="rest_code_c505b408552047ba8e607850b33a671a-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_c505b408552047ba8e607850b33a671a-5"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="rest_code_c505b408552047ba8e607850b33a671a-6" name="rest_code_c505b408552047ba8e607850b33a671a-6" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_c505b408552047ba8e607850b33a671a-6"></a>        <span class="k">return</span> <span class="mi">0</span>
<a id="rest_code_c505b408552047ba8e607850b33a671a-7" name="rest_code_c505b408552047ba8e607850b33a671a-7" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_c505b408552047ba8e607850b33a671a-7"></a>    <span class="k">return</span> <span class="mi">2</span>
</pre></div>
<p>This is wrong precisely for <code class="docutils literal">x == MININT</code>.</p>
</section><section id="generating-random-traces"><h2>Generating Random Traces</h2>
<p>These two bugs were the only two that the Z3 checker found for existing unit
tests. To try to find some more bugs I combined PyPy's existing random trace
generator with the Z3 optimization checker. The random trace generator has so
far been mostly used to find bugs in the machine code backends, particularly
also in the register allocator. So far we haven't used it with our optimizer,
but my experiments show that we should have!</p>
<p>I'm going to describe a little bit how the random trace generator works. It's
actually not that complicated, but there's one neat trick to it.</p>
<p>The basic idea is straightforward, it starts out with an empty trace with a
random number of input variables. Then it adds some number of operations to the
trace, either regular operations or guards. Every operation takes already
existing variables as input.</p>
<p>The neat trick is that our random trace generator keeps a concrete random
example value for every one of the input variables, and an example result for
every operation. In this way, it is possible to generate guards that are
consistent with the example values to ensure that running the trace to its end
is possible with at least one set of values.</p>
<p>Here's an example random trace that is generated, together with the random
example inputs and the results of every operation at the end of every line:</p>
<pre class="literal-block">[i0, i1, i2, i3, i4, i5] # example values: 9, 11, -8, -95, 46, 57
i6 = int_add_ovf(i3, i0) # -86
guard_no_overflow()
i7 = int_sub(i2, -35/ci) # 27
i8 = uint_ge(i3, i5) # 1
guard_true(i8)
i9 = int_lt(i7, i8) # 0
i10 = int_mul_ovf(34/ci, i7) # 918
guard_no_overflow()
i11 = int_and(i10, 63/ci) # 22
i12 = int_rshift(i3, i11) # -1
i13 = int_is_zero(i7) # 0
i14 = int_is_true(i13) # 0
guard_false(i13)
i15 = int_lt(i8, i4) # 1
i16 = int_and(i6, i0) # 8
i17 = uint_ge(i6, -6/ci) # 0
finish()</pre>
<p>Note how every guard generated is true for the example values.</p>
<p>I have been running this combination of random trace generation and Z3 checking
for many nights and it has found some bugs, which I'll describe in the next
section. It should probably be run for a lot longer, but still a useful
exercise already.</p>
<p>In this mode, I'm giving every Z3 call a time limit to make sure that the random
tests don't just take arbitrarily long. This means that asking Z3 to prove
something can have three outcomes, either it's proved, or Z3 finds a
counterexample, or Z3 times out.</p>
</section><section id="bugs-found"><h2>Bugs Found</h2>
<p>In addition to the two bugs I've already described, I'll briefly list the
additional bugs that were found by optimizing random traces and then trying to
prove the equivalence with Z3.</p>
<p>Most of the bugs were actually identified by optimizing random traces alone, not
by the Z3 component. They manifested as assert failures in the JIT compiler.</p>
<ul class="simple">
<li><p>The JIT concluded after <code class="docutils literal">12 == int_mul(x, 12)</code> that <code class="docutils literal">x == 1</code>, which is
incorrect if overflow occurred (a counterexample is <code class="docutils literal">0x8000000000000001</code>).</p></li>
<li><p>An amusing bug, where from <code class="docutils literal">0 == int_lshift(0x1000000000000000, x)</code> with
<code class="docutils literal">x &lt;= 0 &lt;= 15</code>, the JIT concluded that <code class="docutils literal">0x1000000000000000 == 0</code>,
triggering an assert. This wrong conclusion was again caused by not taking the
possibility of overflow into account.</p></li>
<li><p>A corner case in an optimization for chained integer additions with a
constant, where in complex enough expressions, the wrong IR API was used
(which works correctly in simple cases). Again, this triggered an assert.</p></li>
</ul>
<p>This shows that we should have been fuzzing our JIT optimizer already (not a
surprising  observation in hindsight, fuzz all the things!).</p>
<p>Thankfully, there was also one further bug that really failed in the Z3
verifier. It's a bug in common subexpression elimination / arithmetic
simplification, which again does not take overflow correctly into account.</p>
<p>The buggy trace looks like this (unfortunately it's not easily possible to show
this bug in Python code).</p>
<div class="code"><pre class="code text"><a id="rest_code_abd2c358b34a4aa4bc7291509eb05f7e-1" name="rest_code_abd2c358b34a4aa4bc7291509eb05f7e-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_abd2c358b34a4aa4bc7291509eb05f7e-1"></a>[a, b]
<a id="rest_code_abd2c358b34a4aa4bc7291509eb05f7e-2" name="rest_code_abd2c358b34a4aa4bc7291509eb05f7e-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_abd2c358b34a4aa4bc7291509eb05f7e-2"></a>c = int_add(a, b)
<a id="rest_code_abd2c358b34a4aa4bc7291509eb05f7e-3" name="rest_code_abd2c358b34a4aa4bc7291509eb05f7e-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_abd2c358b34a4aa4bc7291509eb05f7e-3"></a>r = int_sub_ovf(c, b)
<a id="rest_code_abd2c358b34a4aa4bc7291509eb05f7e-4" name="rest_code_abd2c358b34a4aa4bc7291509eb05f7e-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_abd2c358b34a4aa4bc7291509eb05f7e-4"></a>guard_no_ovf()
<a id="rest_code_abd2c358b34a4aa4bc7291509eb05f7e-5" name="rest_code_abd2c358b34a4aa4bc7291509eb05f7e-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_abd2c358b34a4aa4bc7291509eb05f7e-5"></a>finish(r)
</pre></div>
<p>This was optimized to:</p>
<div class="code"><pre class="code text"><a id="rest_code_37333ecf11e84f1daebbad0bc7b8713b-1" name="rest_code_37333ecf11e84f1daebbad0bc7b8713b-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_37333ecf11e84f1daebbad0bc7b8713b-1"></a>[a, b]
<a id="rest_code_37333ecf11e84f1daebbad0bc7b8713b-2" name="rest_code_37333ecf11e84f1daebbad0bc7b8713b-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_37333ecf11e84f1daebbad0bc7b8713b-2"></a>finish(a)
</pre></div>
<p>Which is incorrect, because the guard can fail given the right inputs.
But the optimizer concluded that the subtraction is safe, because its the
inverse of an earlier addition, not taking into account that this earlier
addition can have overflowed.</p>
<p>Note that a related optimization is actually correct. Given this code:</p>
<div class="code"><pre class="code text"><a id="rest_code_91661c7b24924b37a29e77daefea7975-1" name="rest_code_91661c7b24924b37a29e77daefea7975-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_91661c7b24924b37a29e77daefea7975-1"></a>[a, b]
<a id="rest_code_91661c7b24924b37a29e77daefea7975-2" name="rest_code_91661c7b24924b37a29e77daefea7975-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_91661c7b24924b37a29e77daefea7975-2"></a>c = int_add_ovf(a, b)
<a id="rest_code_91661c7b24924b37a29e77daefea7975-3" name="rest_code_91661c7b24924b37a29e77daefea7975-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_91661c7b24924b37a29e77daefea7975-3"></a>guard_no_ovf()
<a id="rest_code_91661c7b24924b37a29e77daefea7975-4" name="rest_code_91661c7b24924b37a29e77daefea7975-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_91661c7b24924b37a29e77daefea7975-4"></a>r = int_sub(c, b)
<a id="rest_code_91661c7b24924b37a29e77daefea7975-5" name="rest_code_91661c7b24924b37a29e77daefea7975-5" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_91661c7b24924b37a29e77daefea7975-5"></a>finish(r)
</pre></div>
<p>It can be optimized to:</p>
<div class="code"><pre class="code text"><a id="rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-1" name="rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-1" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-1"></a>[a, b]
<a id="rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-2" name="rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-2" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-2"></a>c = int_add_ovf(a, b)
<a id="rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-3" name="rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-3" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-3"></a>guard_no_ovf()
<a id="rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-4" name="rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-4" href="../posts/2022/12/jit-bug-finding-smt-fuzzing.html#rest_code_f3fd6194cf6c4c85a53de5e0ae69c915-4"></a>finish(a)
</pre></div>
</section><section id="future-work-and-conclusion"><h2>Future Work and Conclusion</h2>
<p>In the current form the Z3 checker is only a start, even though it has already
been concretely useful. There are various directions into which we could extend
it. In addition to generate random tests completely from scratch, we could also
start from the existing manually written unit-tests and randomly mutate those.</p>
<p>I also want to extend the Z3 checker with support more operations, heap
operations in particular (but it's not quite clear to me how to model garbage
collection).</p>
<p>I also want to try to switch the code away from the Z3 API and use the more
general <a class="reference external" href="https://smtlib.cs.uiowa.edu/">smtlib</a> interface directly, in order to be able to use other SMT
checkers than Z3, eg <a class="reference external" href="https://cvc4.github.io/">CVC4</a>.</p>
<p>But all in all this was a fun and not too hard way to find a bunch of bugs in
our optimizer! And the infrastructure is now in place, which means that we run
some random test cases every time we execute our tests. This is going to be
particularly useful when we do further work on the integer reasoning of the JIT
(like Nico is doing, for example). As of time of writing of this post, all the
bugs mentioned have been fixed and the Z3 code has landed on the default branch
and runs as part of PyPy's CI infrastructure.</p>
</section><section id="acknowledgements"><h2>Acknowledgements</h2>
<p>Thanks to <a class="reference external" href="http://saambarati.org/">Saam Barati</a>, <a class="reference external" href="https://bernsteinbear.com">Max Bernstein</a>, <a class="reference external" href="https://www.cs.hhu.de/lehrstuehle-und-arbeitsgruppen/softwaretechnik-und-programmiersprachen/unser-team/team/schmidt">Joshua Schmidt</a> and <a class="reference external" href="https://martinfriedrichberger.net/">Martin
Berger</a>, for great feedback on drafts of this post!</p>
</section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/12/pypy-v7310-release.html" class="u-url">PyPy v7.3.10 release</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/12/pypy-v7310-release.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-12-06T13:22:08Z" itemprop="datePublished" title="2022-12-06 13:22">2022-12-06 13:22</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-10-release-of-python-2-7-3-8-and-3-9"><h2>PyPy v7.3.10: release of python 2.7, 3.8, and 3.9</h2>
<p>The PyPy team is proud to release version 7.3.10 of PyPy. We have some nice
speedups and bugfixes we wish to share. The release includes three different
interpreters:</p>
<blockquote>
<ul class="simple">
<li><p>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.18+ (the <code class="docutils literal">+</code> is for
backported security updates)</p></li>
<li><p>PyPy3.8, which is an interpreter supporting the syntax and the features of
Python 3.8, including the stdlib for CPython 3.8.15.</p></li>
<li><p>PyPy3.9, which is an interpreter supporting the syntax and the features of
Python 3.9, including the stdlib for CPython 3.9.15. We have gained
confidence in the stability of this version, and are removing the "beta"
label.</p></li>
</ul>
</blockquote>
<p>The interpreters are based on much the same codebase, thus the multiple
release. This is a micro release, all APIs are compatible with the other 7.3
releases. Highlights of the release, since the release of 7.3.9 in March 2022
include:</p>
<blockquote>
<ul class="simple">
<li><p>A release of Apple Silicon M1 arm64 versions. This work <a class="reference external" href="https://www.pypy.org/posts/2022/07/m1-support-for-pypy.html">was sponsored</a> by
an anonymous donor and is tested on our buildbots.</p></li>
<li><p>Many improvements to the basic interpreter to make it 15-20% faster</p></li>
<li><p>The conda-forge community <a class="reference external" href="https://www.pypy.org/posts/2022/11/pypy-and-conda-forge.html">has built</a> over 1000 packages for PyPy3.8 and 3.9,
making it easier than ever to use PyPy.</p></li>
<li><p>Update the packaged OpenSSL to 1.1.1s, sqlite3 to 3.39.4, and apply
applicable security fixes from CPython 3.9.15 to PyPy2.7</p></li>
<li><p>Update the <a class="reference external" href="https://hpyproject.org/">HPy</a> backend in PyPy3.8 and PyPy3.9 to 0.0.4</p></li>
</ul>
</blockquote>
<p>We recommend updating. You can find links to download the v7.3.10 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
<a class="reference external" href="https://www.pypy.org/pypy-sponsors.html">direct consulting</a> work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">blog</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: bug fixes,
<a class="reference external" href="../posts/2022/12/index.html">PyPy</a> and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, or general <a class="reference external" href="../posts/2022/12/project-ideas.html">help</a> with making
RPython's JIT even better. Since the previous release, we have accepted
contributions from five new contributors, thanks for pitching in, and welcome
to the project!</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a <a class="reference external" href="https://hpyproject.org/">HPy</a> / <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> / <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> version of your library that would be performant
on PyPy.
In any case, both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.8 and
3.9. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>We provide binary builds for:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS 64 bits, Windows 64 bits)</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux (<code class="docutils literal">aarch64</code>).</p></li>
<li><p>Apple <strong>M1 arm64</strong> machines (<code class="docutils literal">macos_arm64</code>).</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
</ul>
</blockquote>
<p>PyPy support Windows 32-bit, Linux PPC64 big- and little-endian, and Linux ARM
32 bit, but does not release binaries. Please reach out to us if you wish to
sponsor binary releases for those platforms. Downstream packagers provide
binary builds for debian, Fedora, conda, OpenBSD, FreeBSD, Gentoo, and more.</p>
</section><section id="what-else-is-new"><h3>What else is new?</h3>
<p>For more information about the 7.3.10 release, see the <a class="reference external" href="https://doc.pypy.org/en/latest/release-v7.3.10.html#changelog">full changelog</a>.</p>
<p>Please update, and continue to help us make pypy better.</p>
<p>Cheers,
The PyPy Team</p>
</section></section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/11/pypy-and-conda-forge.html" class="u-url">PyPy and conda-forge</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/mattip.html">mattip</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/11/pypy-and-conda-forge.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-11-05T17:00:25Z" itemprop="datePublished" title="2022-11-05 17:00">2022-11-05 17:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <p>You can use PyPy as your python interpreter in a conda environment. The
conda-forge team has graciously provided this service.</p>
<p>The conda-forge <a href="https://conda-forge.org/docs/user/tipsandtricks.html#using-pypy-as-an-interpreter">tips-and-tricks</a>
page says:</p>
<blockquote>
<p>The conda-forge channel supports creating and installing packages into
environments using the PyPy interpreter. Many packages are already available.
You need to enable the conda-forge channel and use the pypy identifier when
creating your environment:</p>
</blockquote>
<div class="code"><pre class="code literal-block">  $ conda create -c conda-forge -n my-pypy-env pypy python=3.8
  $ conda activate my-pypy-env
</pre></div>

<blockquote>
<p>Currently supported python versions are 3.8 and 3.9. Support for pypy3.7 has
been dropped. While you can still create a python 3.7 environment, you you
will not be getting updates as new package versions are released (including
pypy itself).</p>
<p>if you are using defaults as a low priority channel, then you need to use
strict channel priority as the metadata in defaults has not been patched yet
which allows cpython extension packages to be installed alongside pypy.</p>
</blockquote>
<div class="code"><pre class="code literal-block">  $ conda config --set channel_priority strict
</pre></div>

<p>The work required some out-of-the-box thinking on the part of conda-forge since
they needed to add the idea of a <code>pypy</code> identifier to the python version and
the whole conda team has been very supportive of the effort needed. Binary
packages are on offer for the usual platforms:</p>
<ul>
<li>
<code>x86_64</code> windows, macos, linux</li>
<li>
<code>ppc64le</code> and <code>aarch64</code> linux.</li>
</ul>
<p>There are <a href="https://conda-forge.org/status/#pypy38">currently over 1000 packages</a> available for download via the
conda-forge channel, and more are being added as the kind package maintainers
work around various differences between CPython and PyPy. Please let us know if
your favorite package is not supported.</p>
    </div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/10/blog-15-years.html" class="u-url">The PyPy Blog Turns 15 Years</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/10/blog-15-years.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-10-30T12:00:00Z" itemprop="datePublished" title="2022-10-30 12:00">2022-10-30 12:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <p>Exactly 15 years ago today we wrote the <a class="reference external" href="../posts/2007/10/first-post-8150793557471983289.html">first blog post on the PyPy blog</a>!
Over the years, we have written 423 posts, from the <a class="reference external" href="../posts/2007/12/faster-than-c-8057790636822502084.html">shortest</a> to the
<a class="reference external" href="../posts/2022/07/toy-optimizer.html">longest</a>. In 2021 we <a class="reference external" href="../posts/2021/03/pypys-blog-has-moved.html">moved</a> from <a class="reference external" href="https://morepypy.blogspot.com">blogger</a> to our own domain.</p>
<p>The topics over the years varied widely, we published <a class="reference external" href="../posts/2013/05/pypy-20-einstein-sandwich-635158782365435530.html">release</a> <a class="reference external" href="../posts/2017/06/pypy-v58-released-739876359584854017.html">announcements</a>;
<a class="reference external" href="../posts/2009/04/roadmap-for-jit-377358891902851723.html">roadmaps</a>; <a class="reference external" href="../posts/2010/06/blackhole-interpreter-2752965445510091289.html">JIT</a>, <a class="reference external" href="../posts/2013/10/incremental-garbage-collector-in-pypy-8956893523842234676.html">GC</a> and <a class="reference external" href="../posts/2013/10/update-on-stm-7145890443443707910.html">STM</a> <a class="reference external" href="../posts/2019/07/pypy-jit-for-aarch64-7161523403247118006.html">updates</a>; <a class="reference external" href="../posts/2018/06/repeating-matrix-multiplication-8641748742577945875.html">benchmarks</a>; <a class="reference external" href="../posts/2008/10/dsseldorf-sprint-report-days-1-3-5256639868851086032.html">sprint</a>, <a class="reference external" href="../posts/2007/11/pypy-road-show-1-new-york-and-ibm-7837076523877011699.html">trip</a> and
<a class="reference external" href="../posts/2009/07/ecoop-2009-8415055006373020774.html">conference</a> <a class="reference external" href="../posts/2012/04/pycon-2012-wrap-up-559575896040055505.html">reports</a>; <a class="reference external" href="../posts/2016/07/reverse-debugging-for-python-8854823774141612670.html">technical</a> <a class="reference external" href="../posts/2010/11/efficiently-implementing-python-objects-3838329944323946932.html">deep</a> <a class="reference external" href="../posts/2015/10/pypy-memory-and-warmup-improvements-2-4598780879518640015.html">dives</a>; <a class="reference external" href="../posts/2022/02/nlp-icelandic-case-study.html">case studies</a>; <a class="reference external" href="../posts/2008/04/trying-to-get-pypy-to-run-on-python-30-5082015544752137606.html">april</a> <a class="reference external" href="../posts/2008/04/other-aprils-fools-ideas-955926452383759016.html">fool's
jokes</a>; <a class="reference external" href="../posts/2015/03/pydgin-using-rpython-to-generate-fast-1514065178985838697.html">research</a> projects; <a class="reference external" href="../posts/2013/02/announcing-topaz-rpython-powered-ruby-6662407703061538341.html">other</a> <a class="reference external" href="../posts/2012/07/hello-everyone-6869934374873967346.html">languages</a> <a class="reference external" href="../posts/2014/08/a-field-test-of-software-transactional-5659022209916605798.html">using</a> RPython; finished <a class="reference external" href="../posts/2010/10/phd-thesis-about-pypys-cli-jit-backend-969267841095296323.html">PhD</a>
<a class="reference external" href="../posts/2019/04/an-rpython-jit-for-lpegs-4779548053359386284.html">Bachelor</a> and <a class="reference external" href="../posts/2008/10/prolog-jit-masters-thesis-finished-5462132148241449867.html">Master</a>, theses; pictures:</p>
<a class="reference external image-reference" href="../images/2022-pypy-pictures-collage.jpg">
<img alt="a collage of photos taken at PyPy sprints" src="../images/2022-pypy-pictures-collage-small.jpg"></a>
<p>and diagrams:</p>
<a class="reference external image-reference" href="../images/2022-pypy-diagrams-collage.png">
<img alt="a collage of diagrams from previous blog posts" src="../images/2022-pypy-diagrams-collage-small.png"></a>
<p>Quite a number of blog posts were very early iterations of papers that we
published later, here are a few that I can remember:</p>
<ul class="simple">
<li><p><a class="reference external" href="../posts/2009/03/applying-tracing-jit-to-interpreter-3287844903778799266.html">Applying a Tracing JIT to an Interpreter</a> became <a class="reference external" href="https://dl.acm.org/doi/10.1145/1565824.1565827">Tracing the meta-level:
PyPy's tracing JIT compiler</a> at ICOOOLPS 2009, by far our most successful
paper.</p></li>
<li><p><a class="reference external" href="../posts/2010/09/escape-analysis-in-pypys-jit-1780048403046080197.html">Escape Analysis in PyPy's JIT</a> became <a class="reference external" href="https://dl.acm.org/doi/10.1145/1929501.1929508">Allocation removal by partial
evaluation in a tracing JIT</a> at PEPM 2010.</p></li>
<li><p><a class="reference external" href="../posts/2011/03/controlling-tracing-of-interpreter-with_21-6524148550848694588.html">Controlling the Tracing of an Interpreter With Hints</a> was a draft of the
paper <a class="reference external" href="https://dl.acm.org/doi/10.1145/2069172.2069181">Runtime feedback in a meta-tracing JIT for efficient dynamic
languages</a> at ICOOOLPS 2011</p></li>
<li><p><a class="reference external" href="../posts/2010/09/using-escape-analysis-across-loop-2887031293132023676.html">Using Escape Analysis Across Loop Boundaries for Specialization</a> was the
nucleus of <a class="reference external" href="https://dl.acm.org/doi/10.1145/2384577.2384586">Loop-aware optimizations in PyPy's tracing JIT</a> at DLS 2012.</p></li>
<li><p><a class="reference external" href="../posts/2011/10/more-compact-lists-with-list-strategies-8229304944653956829.html">List Strategies</a> was eventually turned into the paper <a class="reference external" href="https://dl.acm.org/doi/10.1145/2509136.2509531">Storage strategies
for collections in dynamically typed languages</a> at OOPSLA 2013.</p></li>
</ul>
<section id="greatest-hits"><h2>Greatest Hits</h2>
<p>In terms of visitors, the top five posts on the old blog were – on the new blog
we simply don't have stats (yet?):</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="../posts/2017/08/lets-remove-global-interpreter-lock-748023554216649595.html">Let's remove the global interpreter lock</a></p></li>
<li><p><a class="reference external" href="../posts/2011/04/tutorial-writing-interpreter-with-pypy-3785910476193156295.html">Tutorial: Writing an Interpreter with PyPy, Part 1</a></p></li>
<li><p><a class="reference external" href="../posts/2019/10/pypys-new-json-parser-492911724084305501.html">PyPy's new JSON parser</a></p></li>
<li><p><a class="reference external" href="../posts/2016/08/pypy-gets-funding-from-mozilla-for-5569307998787871200.html">PyPy gets funding from Mozilla for Python 3.5 support</a></p></li>
<li><p><a class="reference external" href="../posts/2017/10/how-to-make-your-code-80-times-faster-1424098117108093942.html">How to make your code 80 times faster</a></p></li>
</ol>
<p>The number of posts per year developed like this:</p>
<img alt="/images/2022-pypy-posts-per-year.svg" src="../images/2022-pypy-posts-per-year.svg"><p>The most prolific authors are:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="../authors/maciej-fijalkowski.html">Maciej Fijałkowski</a></p></li>
<li><p><a class="reference external" href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a></p></li>
<li><p><a class="reference external" href="../authors/armin-rigo.html">Armin Rigo</a></p></li>
<li><p><a class="reference external" href="../authors/antonio-cuni.html">Antonio Cuni</a></p></li>
<li><p><a class="reference external" href="../authors/mattip.html">Matti Picus</a></p></li>
</ol>
<p>Several blog posts have made it to the Hacker News front page, three of them to
number 1:</p>
<ul class="simple">
<li><p><a class="reference external" href="../posts/2014/07/pypy-stm-first-interesting-release-8684276541915333814.html">PyPy-STM: first “interesting” release</a> (<a class="reference external" href="https://news.ycombinator.com/item?id=7991404">discussion</a>)</p></li>
<li><p><a class="reference external" href="../posts/2017/08/lets-remove-global-interpreter-lock-748023554216649595.html">Let's Remove the Global Interpreter Lock</a> (<a class="reference external" href="https://news.ycombinator.com/item?id=15008636">discussion</a>)</p></li>
<li><p><a class="reference external" href="../posts/2018/09/inside-cpyext-why-emulating-cpython-c-8083064623681286567.html">Inside cpyext: Why emulating CPython C API is so Hard</a> (<a class="reference external" href="https://news.ycombinator.com/item?id=18040664">discussion</a>)</p></li>
</ul></section><section id="personal-favourites"><h2>Personal Favourites</h2>
<p>While looking through the posts, there were a few that stood out to me in some
way, so here's a subjective list of ones that I had fun looking at again:</p>
<ul class="simple">
<li><p>2008: <a class="reference external" href="../posts/2008/10/sprint-discussions-jit-generator-3301578822967655604.html">Sprint Discussions: JIT Generator Planning</a></p></li>
<li><p>2009: <a class="reference external" href="../posts/2009/08/pypy-gets-new-compiler_25-6401910947439531107.html">PyPy gets a new compiler</a></p></li>
<li><p>2010: <a class="reference external" href="../posts/2010/12/oh-and-btw-pypy-gets-funding-through-3568486750776147382.html">Oh, and btw: PyPy gets funding through "Eurostars"</a></p></li>
<li><p>2011: <a class="reference external" href="../posts/2011/07/realtime-image-processing-in-python-6985924592886873374.html">Realtime image processing in Python</a></p></li>
<li><p>2012: <a class="reference external" href="../posts/2012/06/architecture-of-cppyy-9077100041707701102.html">Architecture of Cppyy</a></p></li>
<li><p>2013: <a class="reference external" href="../posts/2013/02/10-years-of-pypy-634401291726575821.html">10 years of PyPy</a></p></li>
<li><p>2014: <a class="reference external" href="../posts/2014/11/pypy-io-improvements-1042070332447047674.html">PyPy IO Improvements</a></p></li>
<li><p>2015: <a class="reference external" href="../posts/2015/10/automatic-simd-vectorization-support-in-639063580401330508.html">Automatic SIMD vectorization support in PyPy</a></p></li>
<li><p>2016: <a class="reference external" href="../posts/2016/04/pypy-enterprise-edition-3688275697656890948.html">PyPy Enterprise Edition</a></p></li>
<li><p>2017: <a class="reference external" href="../posts/2017/03/async-http-benchmarks-on-pypy3-1092124994927894138.html">Async HTTP benchmarks on PyPy3</a></p></li>
<li><p>2018: <a class="reference external" href="../posts/2018/04/improving-syntaxerror-in-pypy-5733639208090522433.html">Improving SyntaxError in PyPy</a></p></li>
<li><p>2018: <a class="reference external" href="../posts/2018/09/the-first-15-years-of-pypy-3412615975376972020.html#incentives-of-oss-compared-to-academia">The First 15 Years of PyPy — a Personal Retrospective</a></p></li>
<li><p>2019: <a class="reference external" href="../posts/2019/01/pypy-for-low-latency-systems-613165393301401965.html">PyPy for low-latency systems</a></p></li>
<li><p>2020: <a class="reference external" href="../posts/2020/02/pypy-and-cffi-have-moved-to-heptapod-5791595152472747032.html">PyPy and CFFI have moved to Heptapod</a></p></li>
<li><p>2021: <a class="reference external" href="../posts/2021/04/ways-pypy-graphviz.html">Some Ways that PyPy uses Graphviz</a></p></li>
</ul>
<p>We'd like to thank our authors, guest authors, commenters, users and readers who
have stuck with us through one and a half decades! If there's any particular
topics you would like to read something about, or any guest posts you'd like to
write, let us know!</p>
</section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/10/toy-optimizer-allocation-removal.html" class="u-url">Allocation Removal in the Toy Optimizer</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/10/toy-optimizer-allocation-removal.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-10-25T07:55:00Z" itemprop="datePublished" title="2022-10-25 07:55">2022-10-25 07:55</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <p>One of the workhorse optimization of RPython's tracing JIT is <a class="reference external" href="https://dl.acm.org/doi/10.1145/1929501.1929508">allocation
removal</a>, which removes short-lived object allocation from traces. Many Python
programs create a lot of objects that only live for a short time, and whose
lifespan is fully predictable (common examples are integer and float boxes, but
also tuples, frames, intermediate string results, etc). Allocation removal will
try (and very often succeed) to remove these allocations from traces. In
this blog post I want to show a toy version of how allocation removal is
implemented.</p>
<p>In the <a class="reference external" href="../posts/2022/07/toy-optimizer.html">previous</a> blog post of this series I showed the complete code for
writing a toy one-pass optimizer that does constant folding, common
subexpression elimination and strength reduction. In this
second post, I want to use allocation removal as a more advanced optimization
pass. The basic optimization framework is the same, we will use the same
datastructures for intermediate representation and also keep using the same
union find data structure to store equivalences between IR operations. Here's
the infrastructure code from the last post:</p>
<div class="code"><pre class="code python"><a id="rest_code_00b059b9999c477385194305353991dd-1" name="rest_code_00b059b9999c477385194305353991dd-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-1"></a><span class="kn">import</span> <span class="nn">pytest</span>
<a id="rest_code_00b059b9999c477385194305353991dd-2" name="rest_code_00b059b9999c477385194305353991dd-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-2"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<a id="rest_code_00b059b9999c477385194305353991dd-3" name="rest_code_00b059b9999c477385194305353991dd-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-3"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-4" name="rest_code_00b059b9999c477385194305353991dd-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-4"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-5" name="rest_code_00b059b9999c477385194305353991dd-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-5"></a><span class="k">class</span> <span class="nc">Value</span><span class="p">:</span>
<a id="rest_code_00b059b9999c477385194305353991dd-6" name="rest_code_00b059b9999c477385194305353991dd-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-6"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-7" name="rest_code_00b059b9999c477385194305353991dd-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-7"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"abstract"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-8" name="rest_code_00b059b9999c477385194305353991dd-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-8"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-9" name="rest_code_00b059b9999c477385194305353991dd-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-9"></a>    <span class="k">def</span> <span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-10" name="rest_code_00b059b9999c477385194305353991dd-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-10"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"abstract"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-11" name="rest_code_00b059b9999c477385194305353991dd-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-11"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-12" name="rest_code_00b059b9999c477385194305353991dd-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-12"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-13" name="rest_code_00b059b9999c477385194305353991dd-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-13"></a><span class="k">class</span> <span class="nc">Operation</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-14" name="rest_code_00b059b9999c477385194305353991dd-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-14"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="rest_code_00b059b9999c477385194305353991dd-15" name="rest_code_00b059b9999c477385194305353991dd-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-15"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Value</span><span class="p">]</span>
<a id="rest_code_00b059b9999c477385194305353991dd-16" name="rest_code_00b059b9999c477385194305353991dd-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-16"></a>    <span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-17" name="rest_code_00b059b9999c477385194305353991dd-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="rest_code_00b059b9999c477385194305353991dd-18" name="rest_code_00b059b9999c477385194305353991dd-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
<a id="rest_code_00b059b9999c477385194305353991dd-19" name="rest_code_00b059b9999c477385194305353991dd-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_00b059b9999c477385194305353991dd-20" name="rest_code_00b059b9999c477385194305353991dd-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_00b059b9999c477385194305353991dd-21" name="rest_code_00b059b9999c477385194305353991dd-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-21"></a><span class="hll">
</span><a id="rest_code_00b059b9999c477385194305353991dd-22" name="rest_code_00b059b9999c477385194305353991dd-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-22"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-23" name="rest_code_00b059b9999c477385194305353991dd-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-23"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="rest_code_00b059b9999c477385194305353991dd-24" name="rest_code_00b059b9999c477385194305353991dd-24" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-24"></a>            <span class="sa">f</span><span class="s2">"Operation(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, "</span>
<a id="rest_code_00b059b9999c477385194305353991dd-25" name="rest_code_00b059b9999c477385194305353991dd-25" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-25"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span><span class="si">}</span><span class="s2">, "</span>
<a id="rest_code_00b059b9999c477385194305353991dd-26" name="rest_code_00b059b9999c477385194305353991dd-26" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-26"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_00b059b9999c477385194305353991dd-27" name="rest_code_00b059b9999c477385194305353991dd-27" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-27"></a>        <span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-28" name="rest_code_00b059b9999c477385194305353991dd-28" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-28"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-29" name="rest_code_00b059b9999c477385194305353991dd-29" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-29"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
<a id="rest_code_00b059b9999c477385194305353991dd-30" name="rest_code_00b059b9999c477385194305353991dd-30" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-30"></a>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span>
<a id="rest_code_00b059b9999c477385194305353991dd-31" name="rest_code_00b059b9999c477385194305353991dd-31" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-31"></a>        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">Operation</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-32" name="rest_code_00b059b9999c477385194305353991dd-32" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-32"></a>            <span class="nb">next</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">forwarded</span>
<a id="rest_code_00b059b9999c477385194305353991dd-33" name="rest_code_00b059b9999c477385194305353991dd-33" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-33"></a>            <span class="k">if</span> <span class="nb">next</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_00b059b9999c477385194305353991dd-34" name="rest_code_00b059b9999c477385194305353991dd-34" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-34"></a>                <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_00b059b9999c477385194305353991dd-35" name="rest_code_00b059b9999c477385194305353991dd-35" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-35"></a>            <span class="n">op</span> <span class="o">=</span> <span class="nb">next</span>
<a id="rest_code_00b059b9999c477385194305353991dd-36" name="rest_code_00b059b9999c477385194305353991dd-36" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-36"></a>        <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_00b059b9999c477385194305353991dd-37" name="rest_code_00b059b9999c477385194305353991dd-37" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-37"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-38" name="rest_code_00b059b9999c477385194305353991dd-38" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-38"></a>    <span class="k">def</span> <span class="nf">arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-39" name="rest_code_00b059b9999c477385194305353991dd-39" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-39"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
<a id="rest_code_00b059b9999c477385194305353991dd-40" name="rest_code_00b059b9999c477385194305353991dd-40" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-40"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-41" name="rest_code_00b059b9999c477385194305353991dd-41" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-41"></a>    <span class="k">def</span> <span class="nf">make_equal_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-42" name="rest_code_00b059b9999c477385194305353991dd-42" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">_set_forwarded</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-43" name="rest_code_00b059b9999c477385194305353991dd-43" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-43"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-44" name="rest_code_00b059b9999c477385194305353991dd-44" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-44"></a>    <span class="k">def</span> <span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-45" name="rest_code_00b059b9999c477385194305353991dd-45" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_00b059b9999c477385194305353991dd-46" name="rest_code_00b059b9999c477385194305353991dd-46" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-46"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-47" name="rest_code_00b059b9999c477385194305353991dd-47" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-47"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-48" name="rest_code_00b059b9999c477385194305353991dd-48" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-48"></a><span class="k">class</span> <span class="nc">Constant</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-49" name="rest_code_00b059b9999c477385194305353991dd-49" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-49"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-50" name="rest_code_00b059b9999c477385194305353991dd-50" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_00b059b9999c477385194305353991dd-51" name="rest_code_00b059b9999c477385194305353991dd-51" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-51"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-52" name="rest_code_00b059b9999c477385194305353991dd-52" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-52"></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-53" name="rest_code_00b059b9999c477385194305353991dd-53" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-53"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Constant(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_00b059b9999c477385194305353991dd-54" name="rest_code_00b059b9999c477385194305353991dd-54" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-54"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-55" name="rest_code_00b059b9999c477385194305353991dd-55" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-55"></a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-56" name="rest_code_00b059b9999c477385194305353991dd-56" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-56"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="rest_code_00b059b9999c477385194305353991dd-57" name="rest_code_00b059b9999c477385194305353991dd-57" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-57"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-58" name="rest_code_00b059b9999c477385194305353991dd-58" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-58"></a>    <span class="k">def</span> <span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-59" name="rest_code_00b059b9999c477385194305353991dd-59" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-59"></a>        <span class="k">assert</span> <span class="p">(</span>
<a id="rest_code_00b059b9999c477385194305353991dd-60" name="rest_code_00b059b9999c477385194305353991dd-60" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-60"></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-61" name="rest_code_00b059b9999c477385194305353991dd-61" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-61"></a>            <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_00b059b9999c477385194305353991dd-62" name="rest_code_00b059b9999c477385194305353991dd-62" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-62"></a>        <span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-63" name="rest_code_00b059b9999c477385194305353991dd-63" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-63"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-64" name="rest_code_00b059b9999c477385194305353991dd-64" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-64"></a><span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-65" name="rest_code_00b059b9999c477385194305353991dd-65" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-65"></a>    <span class="k">def</span> <span class="nf">opbuilder</span><span class="p">(</span><span class="n">opname</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-66" name="rest_code_00b059b9999c477385194305353991dd-66" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-66"></a>        <span class="k">def</span> <span class="nf">wraparg</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-67" name="rest_code_00b059b9999c477385194305353991dd-67" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-67"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-68" name="rest_code_00b059b9999c477385194305353991dd-68" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-68"></a>                <span class="n">arg</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-69" name="rest_code_00b059b9999c477385194305353991dd-69" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-69"></a>            <span class="k">return</span> <span class="n">arg</span>
<a id="rest_code_00b059b9999c477385194305353991dd-70" name="rest_code_00b059b9999c477385194305353991dd-70" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-70"></a>        <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-71" name="rest_code_00b059b9999c477385194305353991dd-71" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-71"></a>            <span class="c1"># construct an Operation, wrap the</span>
<a id="rest_code_00b059b9999c477385194305353991dd-72" name="rest_code_00b059b9999c477385194305353991dd-72" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-72"></a>            <span class="c1"># arguments in Constants if necessary</span>
<a id="rest_code_00b059b9999c477385194305353991dd-73" name="rest_code_00b059b9999c477385194305353991dd-73" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-73"></a>            <span class="n">op</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="n">opname</span><span class="p">,</span>
<a id="rest_code_00b059b9999c477385194305353991dd-74" name="rest_code_00b059b9999c477385194305353991dd-74" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-74"></a>                <span class="p">[</span><span class="n">wraparg</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
<a id="rest_code_00b059b9999c477385194305353991dd-75" name="rest_code_00b059b9999c477385194305353991dd-75" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-75"></a>            <span class="c1"># add it to self, the basic block</span>
<a id="rest_code_00b059b9999c477385194305353991dd-76" name="rest_code_00b059b9999c477385194305353991dd-76" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-76"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-77" name="rest_code_00b059b9999c477385194305353991dd-77" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-77"></a>            <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_00b059b9999c477385194305353991dd-78" name="rest_code_00b059b9999c477385194305353991dd-78" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-78"></a>        <span class="k">return</span> <span class="n">build</span>
<a id="rest_code_00b059b9999c477385194305353991dd-79" name="rest_code_00b059b9999c477385194305353991dd-79" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-79"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-80" name="rest_code_00b059b9999c477385194305353991dd-80" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-80"></a>    <span class="c1"># a bunch of operations we support</span>
<a id="rest_code_00b059b9999c477385194305353991dd-81" name="rest_code_00b059b9999c477385194305353991dd-81" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-81"></a>    <span class="n">add</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"add"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-82" name="rest_code_00b059b9999c477385194305353991dd-82" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-82"></a>    <span class="n">mul</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"mul"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-83" name="rest_code_00b059b9999c477385194305353991dd-83" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-83"></a>    <span class="n">getarg</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"getarg"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-84" name="rest_code_00b059b9999c477385194305353991dd-84" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-84"></a>    <span class="n">dummy</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"dummy"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-85" name="rest_code_00b059b9999c477385194305353991dd-85" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-85"></a>    <span class="n">lshift</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"lshift"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-86" name="rest_code_00b059b9999c477385194305353991dd-86" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-86"></a>    <span class="c1"># some new one for this post</span>
<a id="rest_code_00b059b9999c477385194305353991dd-87" name="rest_code_00b059b9999c477385194305353991dd-87" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-87"></a>    <span class="n">alloc</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"alloc"</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-88" name="rest_code_00b059b9999c477385194305353991dd-88" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-88"></a><span class="hll">    <span class="n">load</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"load"</span><span class="p">)</span>
</span><a id="rest_code_00b059b9999c477385194305353991dd-89" name="rest_code_00b059b9999c477385194305353991dd-89" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-89"></a><span class="hll">    <span class="n">store</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"store"</span><span class="p">)</span>
</span><a id="rest_code_00b059b9999c477385194305353991dd-90" name="rest_code_00b059b9999c477385194305353991dd-90" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-90"></a><span class="hll">    <span class="nb">print</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"print"</span><span class="p">)</span>
</span><a id="rest_code_00b059b9999c477385194305353991dd-91" name="rest_code_00b059b9999c477385194305353991dd-91" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-91"></a><span class="hll">
</span><a id="rest_code_00b059b9999c477385194305353991dd-92" name="rest_code_00b059b9999c477385194305353991dd-92" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-92"></a><span class="hll"><span class="k">def</span> <span class="nf">bb_to_str</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">,</span> <span class="n">varprefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"var"</span><span class="p">):</span>
</span><a id="rest_code_00b059b9999c477385194305353991dd-93" name="rest_code_00b059b9999c477385194305353991dd-93" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-93"></a>    <span class="k">def</span> <span class="nf">arg_to_str</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-94" name="rest_code_00b059b9999c477385194305353991dd-94" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-94"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-95" name="rest_code_00b059b9999c477385194305353991dd-95" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-95"></a>            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-96" name="rest_code_00b059b9999c477385194305353991dd-96" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-96"></a>        <span class="k">else</span><span class="p">:</span>
<a id="rest_code_00b059b9999c477385194305353991dd-97" name="rest_code_00b059b9999c477385194305353991dd-97" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-97"></a>            <span class="k">return</span> <span class="n">varnames</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
<a id="rest_code_00b059b9999c477385194305353991dd-98" name="rest_code_00b059b9999c477385194305353991dd-98" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-98"></a>
<a id="rest_code_00b059b9999c477385194305353991dd-99" name="rest_code_00b059b9999c477385194305353991dd-99" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-99"></a>    <span class="n">varnames</span> <span class="o">=</span> <span class="p">{}</span>
<a id="rest_code_00b059b9999c477385194305353991dd-100" name="rest_code_00b059b9999c477385194305353991dd-100" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-100"></a>    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<a id="rest_code_00b059b9999c477385194305353991dd-101" name="rest_code_00b059b9999c477385194305353991dd-101" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-101"></a>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_00b059b9999c477385194305353991dd-102" name="rest_code_00b059b9999c477385194305353991dd-102" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-102"></a>        <span class="n">var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">varprefix</span><span class="si">}{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span>
<a id="rest_code_00b059b9999c477385194305353991dd-103" name="rest_code_00b059b9999c477385194305353991dd-103" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-103"></a>        <span class="n">varnames</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
<a id="rest_code_00b059b9999c477385194305353991dd-104" name="rest_code_00b059b9999c477385194305353991dd-104" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-104"></a>        <span class="n">arguments</span> <span class="o">=</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="rest_code_00b059b9999c477385194305353991dd-105" name="rest_code_00b059b9999c477385194305353991dd-105" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-105"></a>            <span class="n">arg_to_str</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a id="rest_code_00b059b9999c477385194305353991dd-106" name="rest_code_00b059b9999c477385194305353991dd-106" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-106"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
<a id="rest_code_00b059b9999c477385194305353991dd-107" name="rest_code_00b059b9999c477385194305353991dd-107" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-107"></a>        <span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-108" name="rest_code_00b059b9999c477385194305353991dd-108" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-108"></a>        <span class="n">strop</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">arguments</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_00b059b9999c477385194305353991dd-109" name="rest_code_00b059b9999c477385194305353991dd-109" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-109"></a>        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strop</span><span class="p">)</span>
<a id="rest_code_00b059b9999c477385194305353991dd-110" name="rest_code_00b059b9999c477385194305353991dd-110" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_00b059b9999c477385194305353991dd-110"></a>    <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
<p>There are two changes to the code from the last post: <code class="docutils literal">Operation</code> instances
have a new <code class="docutils literal">.info</code> field, which is set to <code class="docutils literal">None</code> by default. We will learn
how the info field is used a bit further down. Also, we define some new
operations.</p>
<section id="interpreter"><h2>Interpreter</h2>
<p>In this post we will mainly concern ourselves with optimizing
programs that allocate memory. We assume that our language is garbage collected
and memory safe. The new operations that we will optimize are <code class="docutils literal">alloc</code>
(allocates some new object), <code class="docutils literal">store</code> (stores a value into a fixed field of an
object), <code class="docutils literal">load</code> (loads the value from a field in the object).</p>
<p>We are leaving out a lot of details of a "real" system here, usually an
<code class="docutils literal">alloc</code> operation would get some extra information, for example the type of
the freshly allocated object or at least its size. <code class="docutils literal">load</code> and <code class="docutils literal">store</code> would
typically have some kind of field offset and maybe some information about the
field's type</p>
<p>Here's a simple program that uses these operations:</p>
<pre class="literal-block">var0 = getarg(0)
obj0 = alloc()
store(obj0, 0, var0)
var1 = load(obj0, 0)
print(var1)</pre>
<p>The code allocates a new object <code class="docutils literal">obj0</code>, stores <code class="docutils literal">var0</code> into field <code class="docutils literal">0</code> of
the object, the loads the same field and prints the result of the load.</p>
<p>Before we get started in writing the optimizer for these operations, let's try
to understand the semantics of the new operations a bit better. To do this, we
can sketch a small interpreter for basic blocks, supporting only <code class="docutils literal">getarg</code>,
<code class="docutils literal">alloc</code>, <code class="docutils literal">store</code>, <code class="docutils literal">load</code>, <code class="docutils literal">print</code>:</p>
<div class="code"><pre class="code python"><a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-1" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-1"></a><span class="k">def</span> <span class="nf">test_interpret</span><span class="p">():</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-2" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-3" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-4" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-4"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-5" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-5"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-6" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-6"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-7" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-7"></a>    <span class="n">bb</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-8" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-8"></a>    <span class="k">assert</span> <span class="n">interpret</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span> <span class="o">==</span> <span class="mi">17</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-9" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-9"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-10" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-10"></a><span class="k">class</span> <span class="nc">Object</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-11" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-11"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-12" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-13" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-13"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-14" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-14"></a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span> <span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-15" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-16" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-16"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-17" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-17"></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-18" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-18"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-19" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-19"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-20" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-20"></a><span class="k">def</span> <span class="nf">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-21" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-21"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">Constant</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-22" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-22"></a>    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-23" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-23"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-24" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-24" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-24"></a><span class="k">def</span> <span class="nf">interpret</span><span class="p">(</span><span class="n">bb</span> <span class="p">:</span> <span class="n">Block</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span> <span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-25" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-25" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-25"></a>    <span class="k">def</span> <span class="nf">argval</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-26" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-26" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-26"></a>        <span class="n">arg</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-27" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-27" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-27"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-28" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-28" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-28"></a>            <span class="k">return</span> <span class="n">arg</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-29" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-29" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-29"></a>        <span class="k">else</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-30" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-30" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-30"></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-31" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-31" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-31"></a>            <span class="k">return</span> <span class="n">arg</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-32" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-32" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-32"></a>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-33" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-33" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-33"></a>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-34" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-34" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-34"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"getarg"</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-35" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-35" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-35"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-36" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-36" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-36"></a>        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-37" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-37" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-37"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Object</span><span class="p">()</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-38" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-38" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-38"></a>        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"load"</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-39" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-39" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-39"></a>            <span class="n">fieldnum</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-40" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-40" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-40"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">argval</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fieldnum</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-41" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-41" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-41"></a>        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"store"</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-42" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-42" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-42"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">argval</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-43" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-43" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-43"></a>            <span class="n">fieldnum</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-44" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-44" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-44"></a>            <span class="n">fieldvalue</span> <span class="o">=</span> <span class="n">argval</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-45" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-45" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-45"></a>            <span class="n">obj</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">fieldnum</span><span class="p">,</span> <span class="n">fieldvalue</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-46" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-46" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-46"></a>            <span class="c1"># no result, only side effect</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-47" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-47" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-47"></a>            <span class="k">continue</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-48" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-48" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-48"></a>        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"print"</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-49" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-49" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-49"></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">argval</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-50" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-50" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-50"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-51" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-51" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-51"></a>            <span class="k">return</span> <span class="n">res</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-52" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-52" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-52"></a>        <span class="k">else</span><span class="p">:</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-53" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-53" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-53"></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-54" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-54" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-54"></a>                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> not supported"</span><span class="p">)</span>
<a id="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-55" name="rest_code_828b74cdafe74a1cb4a163f205d5e8b9-55" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_828b74cdafe74a1cb4a163f205d5e8b9-55"></a>        <span class="n">op</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">res</span>
</pre></div>
<p>The interpreter  walks the operations of a block, executing each one in turn. It
uses the <code class="docutils literal">info</code> field to store the result of each already executed
<code class="docutils literal">Operation</code>. In this interpreter sketch we stop at the first <code class="docutils literal">print</code> that
we execute and return its argument for the simple but bad reason that it makes
<code class="docutils literal">test_interpret</code> easier to write.</p>
<p>Objects in the interpreter are represented using a class <code class="docutils literal">Object</code>, which
stores the object's field into a Python dictionary. As written above, this is a
simplification, in a real system the <cite>alloc</cite> operation might for example take
some kind of type as an argument, that describes which kinds of fields an
object has and how they are laid out in memory, which would allow more
efficient storage of the content. But we don't want to care about this level of
detail in the post, so using a dict in the interpreter is good enough.</p>
</section><section id="version-1-naive-attempt"><h2>Version 1: Naive Attempt</h2>
<p>In many programs, some allocated objects don't live for very long and have a
completely predictable lifetime. They get allocated, used for a while, and then
there is no way to reference them any more, so the garbage collector will
reclaim them. The very first example block had such an allocation:</p>
<pre class="literal-block">var0 = getarg(0)
obj0 = alloc()
store(obj0, 0, var0)
var1 = load(obj0, 0)
print(var1)</pre>
<p>Here <code class="docutils literal">obj0</code> is written to, then read from, and then it's no longer used. We
want to optimize such programs to remove this <code class="docutils literal">alloc</code> operation. The optimized
version of this program would look like this:</p>
<pre class="literal-block">var0 = getarg(0)
print(var0)</pre>
<p>The <code class="docutils literal">alloc</code>, <code class="docutils literal">store</code> and <code class="docutils literal">load</code> operations have been completely removed.
This is a pretty important optimizations for PyPy's JIT: Allocations, memory
reads and writes are quite costly and occur <em>a lot</em> in Python, so getting rid
of as many of them as possible is instrumental for performance.</p>
<p>Implementing the optimization is not a lot of code! However, understanding all
the corner cases of the
optimization and making sure that the resulting program behave correctly is not
completely trivial. Therefore we will develop the optimization step by step, in
a test driven fashion: I will start each section with a new test that shows a
bug in the version of the optimization that we have so far.</p>
<p>Let's start in a really naive way. Here's the first test we would like to
pass, using the example program above:</p>
<div class="code"><pre class="code python"><a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-1" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-1"></a><span class="k">def</span> <span class="nf">test_remove_unused_allocation</span><span class="p">():</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-2" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-3" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-4" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-4"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-5" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-5"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-6" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-6"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-7" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-7"></a>    <span class="n">bb</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-8" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-8"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-9" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-9"></a>    <span class="c1"># the virtual object looks like this:</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-10" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-10"></a>    <span class="c1">#  obj</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-11" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-11"></a>    <span class="c1"># ┌──────────┐</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-12" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-12"></a>    <span class="c1"># │ 0: var0  │</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-13" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-13"></a>    <span class="c1"># └──────────┘</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-14" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-14"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-15" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-15"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_7bea91734f8a464897ce4dbcfad6479c-16" name="rest_code_7bea91734f8a464897ce4dbcfad6479c-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_7bea91734f8a464897ce4dbcfad6479c-16"></a><span class="s2">optvar1 = print(optvar0)"""</span>
</pre></div>
<p>We will define a class <code class="docutils literal">VirtualObject</code> that is basically identical to
<code class="docutils literal">Object</code> above. But it will not be used by the interpreter, instead we will
use it during optimization.</p>
<div class="code"><pre class="code python"><a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-1" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-1"></a><span class="k">class</span> <span class="nc">VirtualObject</span><span class="p">:</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-2" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-3" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-4" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-4"></a>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-5" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-5"></a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-6" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-7" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-7"></a>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-8" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-8"></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-9" name="rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_23c9a9c51dab46a5a1714cb90a9a5c08-9"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</pre></div>
<p>The structure of the optimizer is going to be like those in the first blog post.
The optimizer makes a single pass over all operations. It removes some and
emits others.</p>
<p>This first version of the allocation removal optimizer is going to be extremely
optimistic. It simply assumes that <em>all</em> the allocations in the program can be
optimized away. That is not realistic in practice. We will have to
refine this approach later, but it's a good way to start. That means whenever
the optimizer sees an <code class="docutils literal">alloc</code> operation, it removes it and creates a
<code class="docutils literal">VirtualObject</code> object which stores the information that is known during
optimization about the result of the <code class="docutils literal">alloc</code>. Like in the interpreter, the
<code class="docutils literal">VirtualObject</code> is stored in the <code class="docutils literal">.info</code> field of the <code class="docutils literal">Operation</code> instance
that represents the <code class="docutils literal">alloc</code>.</p>
<p>When the optimizer sees a <code class="docutils literal">store</code> operation, it will also remove it and
instead execute the store by calling the <code class="docutils literal">VirtualObject.store</code> method.
Here is one important difference between the interpreter and the optimizer: In
the interpreter, the values that were stored into an <code class="docutils literal">Object</code> (and thus
put into the object's <code class="docutils literal">.contents</code> dictionary) were runtime values, for
example integers or other objects. In the optimizer however, the
fields of the <code class="docutils literal">VirtualObject</code> store <code class="docutils literal">Value</code> instances, either <code class="docutils literal">Constant</code>
instances or <code class="docutils literal">Operation</code> instances.</p>
<p>When the optimizer sees a <code class="docutils literal">load</code> operation, it <em>also</em> removes it, and replaces
the <code class="docutils literal">load</code> with the <code class="docutils literal">Operation</code> (or <code class="docutils literal">Constant</code>) that is stored in the
<code class="docutils literal">VirtualObject</code> at that point:</p>
<div class="code"><pre class="code python"><a id="rest_code_3272498ce285485698127a1bcb985796-1" name="rest_code_3272498ce285485698127a1bcb985796-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-1"></a><span class="k">def</span> <span class="nf">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-2" name="rest_code_3272498ce285485698127a1bcb985796-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-3" name="rest_code_3272498ce285485698127a1bcb985796-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-3"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-4" name="rest_code_3272498ce285485698127a1bcb985796-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-4"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span><span class="p">:</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-5" name="rest_code_3272498ce285485698127a1bcb985796-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-5"></a>            <span class="n">op</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">VirtualObject</span><span class="p">()</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-6" name="rest_code_3272498ce285485698127a1bcb985796-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-6"></a>            <span class="k">continue</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-7" name="rest_code_3272498ce285485698127a1bcb985796-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-7"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"load"</span><span class="p">:</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-8" name="rest_code_3272498ce285485698127a1bcb985796-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-8"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-9" name="rest_code_3272498ce285485698127a1bcb985796-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-9"></a>            <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-10" name="rest_code_3272498ce285485698127a1bcb985796-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-10"></a>            <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-11" name="rest_code_3272498ce285485698127a1bcb985796-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-11"></a>            <span class="k">continue</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-12" name="rest_code_3272498ce285485698127a1bcb985796-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-12"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"store"</span><span class="p">:</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-13" name="rest_code_3272498ce285485698127a1bcb985796-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-13"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-14" name="rest_code_3272498ce285485698127a1bcb985796-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-14"></a>            <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-15" name="rest_code_3272498ce285485698127a1bcb985796-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-15"></a>            <span class="n">info</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-16" name="rest_code_3272498ce285485698127a1bcb985796-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-16"></a>            <span class="k">continue</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-17" name="rest_code_3272498ce285485698127a1bcb985796-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-17"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_3272498ce285485698127a1bcb985796-18" name="rest_code_3272498ce285485698127a1bcb985796-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3272498ce285485698127a1bcb985796-18"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
</pre></div>
<p>This is the first version of the optimization. It doesn't handle all kinds of
difficult cases, and we'll have to do something about its optimism.
But, already in this minimalistic form, we can write a slightly more complicated
test with two allocations, one object pointing to the other. It works correctly
too, both allocations are removed:</p>
<div class="code"><pre class="code python"><a id="rest_code_741d7a376c38438398deb1b590d35c07-1" name="rest_code_741d7a376c38438398deb1b590d35c07-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-1"></a><span class="k">def</span> <span class="nf">test_remove_two_allocations</span><span class="p">():</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-2" name="rest_code_741d7a376c38438398deb1b590d35c07-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-3" name="rest_code_741d7a376c38438398deb1b590d35c07-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-4" name="rest_code_741d7a376c38438398deb1b590d35c07-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-4"></a>    <span class="n">obj0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-5" name="rest_code_741d7a376c38438398deb1b590d35c07-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-5"></a>    <span class="n">sto1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-6" name="rest_code_741d7a376c38438398deb1b590d35c07-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-6"></a>    <span class="n">obj1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-7" name="rest_code_741d7a376c38438398deb1b590d35c07-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-7"></a>    <span class="n">sto2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj0</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-8" name="rest_code_741d7a376c38438398deb1b590d35c07-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-8"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-9" name="rest_code_741d7a376c38438398deb1b590d35c07-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-9"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-10" name="rest_code_741d7a376c38438398deb1b590d35c07-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-10"></a>    <span class="n">bb</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">var2</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-11" name="rest_code_741d7a376c38438398deb1b590d35c07-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-11"></a>    <span class="c1"># the virtual objects look like this:</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-12" name="rest_code_741d7a376c38438398deb1b590d35c07-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-12"></a>    <span class="c1">#  obj0</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-13" name="rest_code_741d7a376c38438398deb1b590d35c07-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-13"></a>    <span class="c1"># ┌──────┐</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-14" name="rest_code_741d7a376c38438398deb1b590d35c07-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-14"></a>    <span class="c1"># │ 0: ╷ │</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-15" name="rest_code_741d7a376c38438398deb1b590d35c07-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-15"></a>    <span class="c1"># └────┼─┘</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-16" name="rest_code_741d7a376c38438398deb1b590d35c07-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-16"></a>    <span class="c1">#      │</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-17" name="rest_code_741d7a376c38438398deb1b590d35c07-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-17"></a>    <span class="c1">#      ▼</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-18" name="rest_code_741d7a376c38438398deb1b590d35c07-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-18"></a>    <span class="c1">#     obj1</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-19" name="rest_code_741d7a376c38438398deb1b590d35c07-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-19"></a>    <span class="c1">#   ┌─────────┐</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-20" name="rest_code_741d7a376c38438398deb1b590d35c07-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-20"></a>    <span class="c1">#   │ 0: var0 │</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-21" name="rest_code_741d7a376c38438398deb1b590d35c07-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-21"></a>    <span class="c1">#   └─────────┘</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-22" name="rest_code_741d7a376c38438398deb1b590d35c07-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-22"></a>    <span class="c1"># therefore</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-23" name="rest_code_741d7a376c38438398deb1b590d35c07-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-23"></a>    <span class="c1"># var1 is the same as obj0</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-24" name="rest_code_741d7a376c38438398deb1b590d35c07-24" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-24"></a>    <span class="c1"># var2 is the same as var0</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-25" name="rest_code_741d7a376c38438398deb1b590d35c07-25" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-25"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-26" name="rest_code_741d7a376c38438398deb1b590d35c07-26" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-26"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-27" name="rest_code_741d7a376c38438398deb1b590d35c07-27" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-27"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_741d7a376c38438398deb1b590d35c07-28" name="rest_code_741d7a376c38438398deb1b590d35c07-28" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_741d7a376c38438398deb1b590d35c07-28"></a><span class="s2">optvar1 = print(optvar0)"""</span>
</pre></div>
</section><section id="version-2-re-materializing-allocations"><h2>Version 2: Re-Materializing Allocations</h2>
<p>To make it easier to talk about how the optimizer operates, let's introduce
some terminology. As already seen by the choice
of the class name <code class="docutils literal">VirtualObject</code>, we will call an object <strong>virtual</strong> if the
optimizer has optimized away the <code class="docutils literal">alloc</code> operation that creates the object.
Other objects are equivalently <strong>not virtual</strong>, for example those that have
existed before we enter the current code block.</p>
<p>The first problem that we need to fix is the assumption that every
allocation can be removed. So far we only looked at small programs where every
allocation could be removed, or equivalently, where every object is virtual.
A program that creates virtual objects, stores into and loads from them, and
then forgets the objects. In this simple case removing the allocations is fine.
As we saw in the previous section, it's also fine to have a virtual object
reference another virtual, both allocations can be removed.</p>
<p>What are the cases were we <em>can't</em> remove an allocation?
The first version of the optimizer simply assumed that every allocation can be
removed. This can't work. We will replace this assumption with the following
simple heuristic:</p>
<p>If a reference to a virtual object <code class="docutils literal">a</code> is stored into an object <code class="docutils literal">b</code>
that is not virtual, then <code class="docutils literal">a</code> will also stop being virtual. If an object <code class="docutils literal">a</code>
that was virtual stops being virtual, we say that it <strong>escapes</strong>. <a class="reference internal" href="../posts/2022/10/toy-optimizer-allocation-removal.html#target-4">¹</a></p>
<p>The simplest test case for this happening looks like this:</p>
<div class="code"><pre class="code python"><a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-1" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-1"></a><span class="k">def</span> <span class="nf">test_materialize</span><span class="p">():</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-2" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-3" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-4" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-4"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-5" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-5"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-6" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-6"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-7" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-7"></a>    <span class="c1">#  obj is virtual, without any fields</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-8" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-8"></a>    <span class="c1"># ┌───────┐</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-9" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-9"></a>    <span class="c1"># │ empty │</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-10" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-10"></a>    <span class="c1"># └───────┘</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-11" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-11"></a>    <span class="c1"># then we store a reference to obj into</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-12" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-12"></a>    <span class="c1"># field 0 of var0. Since var0 is not virtual,</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-13" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-13"></a>    <span class="c1"># obj escapes, so we have to put it back</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-14" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-14"></a>    <span class="c1"># into the optimized basic block</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-15" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-15"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-16" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-16"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-17" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-17"></a><span class="s2">optvar1 = alloc()</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-18" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-18"></a><span class="s2">optvar2 = store(optvar0, 0, optvar1)"""</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-19" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-19"></a>    <span class="c1"># so far, fails like this:</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-20" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-20"></a>    <span class="c1"># the line:</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-21" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-21"></a>    <span class="c1"># info.store(field, op.arg(2))</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-22" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-22"></a>    <span class="c1"># produces an AttributeError because info</span>
<a id="rest_code_865c3da0dd28405498c4c20b2e3bfe67-23" name="rest_code_865c3da0dd28405498c4c20b2e3bfe67-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_865c3da0dd28405498c4c20b2e3bfe67-23"></a>    <span class="c1"># is None</span>
</pre></div>
<p>If the optimizer reaches a point where a virtual object escapes (like the
<code class="docutils literal">store</code> operation in the test), the optimizer has already removed the <code class="docutils literal">alloc</code>
operation that created the virtual object. If the object escapes, we don't want
to go back in the operations list and re-insert the <code class="docutils literal">alloc</code> operation, that
sounds potentially very complicated. Instead, we re-insert the <code class="docutils literal">alloc</code>
operation that will recreate the virtual object at the point of escape using a
helper function <code class="docutils literal">materialize</code>.</p>
<div class="code"><pre class="code python"><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-1" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-1"></a><span class="hll"><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-2" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-2"></a><span class="hll">    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-3" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-3"></a><span class="hll">    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-4" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-4"></a><span class="hll">    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-5" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-5"></a><span class="hll">    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">VirtualObject</span><span class="p">)</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-6" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-6"></a><span class="hll">    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-7" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-7"></a><span class="hll">    <span class="c1"># put the alloc operation back into the trace</span>
</span><a id="rest_code_ef6d6206b45b4eafab48ca9322aae493-8" name="rest_code_ef6d6206b45b4eafab48ca9322aae493-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ef6d6206b45b4eafab48ca9322aae493-8"></a><span class="hll">    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></pre></div>
<p>I've added a number of fairly strong assertions to <code class="docutils literal">materialize</code> to encode our
current assumptions about the situations in which it expects to be called. We
will remove some of them later as we generalize the code.</p>
<p>Now that we have <code class="docutils literal">materialize</code> we need to change <code class="docutils literal">optimize_alloc_removal</code> to
recognize the case of storing a virtual object into a non-virtual one. We can
recognize <code class="docutils literal">Operation</code> instances that produced a virtual object by looking at
their <code class="docutils literal">.info</code> field. If it is <code class="docutils literal">None</code>, the object is not virtual, otherwise
it is. If we store something into a virtual object, we leave the code as above.
If we store a virtual object into an object that is not virtual, we will first
materialize the virtual object, and then emit the store.</p>
<div class="code"><pre class="code python"><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-1" name="rest_code_b615420c2cef4c14913ec23f92b9899a-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-1"></a><span class="k">def</span> <span class="nf">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-2" name="rest_code_b615420c2cef4c14913ec23f92b9899a-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-3" name="rest_code_b615420c2cef4c14913ec23f92b9899a-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-3"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-4" name="rest_code_b615420c2cef4c14913ec23f92b9899a-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-4"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span><span class="p">:</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-5" name="rest_code_b615420c2cef4c14913ec23f92b9899a-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-5"></a>            <span class="n">op</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">VirtualObject</span><span class="p">()</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-6" name="rest_code_b615420c2cef4c14913ec23f92b9899a-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-6"></a>            <span class="k">continue</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-7" name="rest_code_b615420c2cef4c14913ec23f92b9899a-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-7"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"load"</span><span class="p">:</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-8" name="rest_code_b615420c2cef4c14913ec23f92b9899a-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-8"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-9" name="rest_code_b615420c2cef4c14913ec23f92b9899a-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-9"></a>            <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-10" name="rest_code_b615420c2cef4c14913ec23f92b9899a-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-10"></a>            <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-11" name="rest_code_b615420c2cef4c14913ec23f92b9899a-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-11"></a>            <span class="k">continue</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-12" name="rest_code_b615420c2cef4c14913ec23f92b9899a-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-12"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"store"</span><span class="p">:</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-13" name="rest_code_b615420c2cef4c14913ec23f92b9899a-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-13"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-14" name="rest_code_b615420c2cef4c14913ec23f92b9899a-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-14"></a><span class="hll">            <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="c1"># virtual</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-15" name="rest_code_b615420c2cef4c14913ec23f92b9899a-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-15"></a><span class="hll">                <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-16" name="rest_code_b615420c2cef4c14913ec23f92b9899a-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-16"></a><span class="hll">                <span class="n">info</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-17" name="rest_code_b615420c2cef4c14913ec23f92b9899a-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-17"></a><span class="hll">                <span class="k">continue</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-18" name="rest_code_b615420c2cef4c14913ec23f92b9899a-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-18"></a><span class="hll">            <span class="k">else</span><span class="p">:</span> <span class="c1"># not virtual</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-19" name="rest_code_b615420c2cef4c14913ec23f92b9899a-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-19"></a><span class="hll">                <span class="c1"># first materialize the</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-20" name="rest_code_b615420c2cef4c14913ec23f92b9899a-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-20"></a><span class="hll">                <span class="c1"># right hand side</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-21" name="rest_code_b615420c2cef4c14913ec23f92b9899a-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-21"></a><span class="hll">                <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-22" name="rest_code_b615420c2cef4c14913ec23f92b9899a-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-22"></a><span class="hll">                <span class="c1"># then emit the store via</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-23" name="rest_code_b615420c2cef4c14913ec23f92b9899a-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-23"></a><span class="hll">                <span class="c1"># the general path below</span>
</span><a id="rest_code_b615420c2cef4c14913ec23f92b9899a-24" name="rest_code_b615420c2cef4c14913ec23f92b9899a-24" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-24"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b615420c2cef4c14913ec23f92b9899a-25" name="rest_code_b615420c2cef4c14913ec23f92b9899a-25" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b615420c2cef4c14913ec23f92b9899a-25"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
</pre></div>
<p>This is the general idea, and it is enough to pass <code class="docutils literal">test_materialize</code>. But of
course there are still a number of further problems that we now need to solve.</p>
</section><section id="version-3-don-t-materialize-twice"><h2>Version 3: Don't Materialize Twice</h2>
<p>The first problem is the fact that after we materialize a virtual object, it is
no longer virtual. So if it escapes a second time, it should <em>not</em> be
materialized a second time. A test for that case could simply repeat the
<code class="docutils literal">store</code> operation:</p>
<div class="code"><pre class="code python"><a id="rest_code_ec0c737e38534b24a97f90a407cac041-1" name="rest_code_ec0c737e38534b24a97f90a407cac041-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-1"></a><span class="k">def</span> <span class="nf">test_dont_materialize_twice</span><span class="p">():</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-2" name="rest_code_ec0c737e38534b24a97f90a407cac041-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-2"></a>    <span class="c1"># obj is again an empty virtual object,</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-3" name="rest_code_ec0c737e38534b24a97f90a407cac041-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-3"></a>    <span class="c1"># and we store it into var0 *twice*.</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-4" name="rest_code_ec0c737e38534b24a97f90a407cac041-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-4"></a>    <span class="c1"># this should only materialize it once</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-5" name="rest_code_ec0c737e38534b24a97f90a407cac041-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-5"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-6" name="rest_code_ec0c737e38534b24a97f90a407cac041-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-6"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-7" name="rest_code_ec0c737e38534b24a97f90a407cac041-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-7"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-8" name="rest_code_ec0c737e38534b24a97f90a407cac041-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-8"></a>    <span class="n">sto0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-9" name="rest_code_ec0c737e38534b24a97f90a407cac041-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-9"></a>    <span class="n">sto1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-10" name="rest_code_ec0c737e38534b24a97f90a407cac041-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-10"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-11" name="rest_code_ec0c737e38534b24a97f90a407cac041-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-11"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-12" name="rest_code_ec0c737e38534b24a97f90a407cac041-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-12"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-13" name="rest_code_ec0c737e38534b24a97f90a407cac041-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-13"></a><span class="s2">optvar1 = alloc()</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-14" name="rest_code_ec0c737e38534b24a97f90a407cac041-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-14"></a><span class="s2">optvar2 = store(optvar0, 0, optvar1)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-15" name="rest_code_ec0c737e38534b24a97f90a407cac041-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-15"></a><span class="s2">optvar3 = store(optvar0, 0, optvar1)"""</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-16" name="rest_code_ec0c737e38534b24a97f90a407cac041-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-16"></a>    <span class="c1"># fails so far: the operations that we get</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-17" name="rest_code_ec0c737e38534b24a97f90a407cac041-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-17"></a>    <span class="c1"># at the moment are:</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-18" name="rest_code_ec0c737e38534b24a97f90a407cac041-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-18"></a>    <span class="c1"># optvar0 = getarg(0)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-19" name="rest_code_ec0c737e38534b24a97f90a407cac041-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-19"></a>    <span class="c1"># optvar1 = alloc()</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-20" name="rest_code_ec0c737e38534b24a97f90a407cac041-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-20"></a>    <span class="c1"># optvar2 = store(optvar0, 0, optvar1)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-21" name="rest_code_ec0c737e38534b24a97f90a407cac041-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-21"></a>    <span class="c1"># optvar3 = alloc()</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-22" name="rest_code_ec0c737e38534b24a97f90a407cac041-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-22"></a>    <span class="c1"># optvar4 = store(optvar0, 0, optvar3)</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-23" name="rest_code_ec0c737e38534b24a97f90a407cac041-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-23"></a>    <span class="c1"># ie the object is materialized twice,</span>
<a id="rest_code_ec0c737e38534b24a97f90a407cac041-24" name="rest_code_ec0c737e38534b24a97f90a407cac041-24" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ec0c737e38534b24a97f90a407cac041-24"></a>    <span class="c1"># which is incorrect</span>
</pre></div>
<p>We solve the problem by setting the <code class="docutils literal">.info</code> field of an object that we
materialize to <code class="docutils literal">None</code> to mark it as no longer being virtual.</p>
<div class="code"><pre class="code python"><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-1" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-1"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-2" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-2"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-3" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-3"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-4" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-4"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-5" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-5"></a><span class="hll">    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-6" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-6"></a><span class="hll">        <span class="k">return</span> <span class="c1"># already materialized</span>
</span><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-7" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-7"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-8" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-8"></a><span class="hll">    <span class="c1"># put the alloc operation back into the trace</span>
</span><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-9" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-9"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-10" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-10"></a><span class="hll">    <span class="c1"># but only once</span>
</span><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-11" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-11"></a><span class="hll">    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
</span><a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-12" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-12"></a>
<a id="rest_code_51c8bd5e64a742ca93c90a970d16a92f-13" name="rest_code_51c8bd5e64a742ca93c90a970d16a92f-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_51c8bd5e64a742ca93c90a970d16a92f-13"></a><span class="c1"># optimize_alloc_removal unchanged</span>
</pre></div>
<p>This fixes the problem, only one <code class="docutils literal">alloc</code> is created. This fix also allows
another test case to pass, one where we store a non-virtual into another
non-virtual, code which we cannot optimize at all:</p>
<div class="code"><pre class="code python"><a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-1" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-1"></a><span class="k">def</span> <span class="nf">test_materialize_non_virtuals</span><span class="p">():</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-2" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-2"></a>    <span class="c1"># in this example we store a non-virtual var1</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-3" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-3"></a>    <span class="c1"># into another non-virtual var0</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-4" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-4"></a>    <span class="c1"># this should just lead to no optimization at</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-5" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-5"></a>    <span class="c1"># all</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-6" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-6"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-7" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-7"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-8" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-8"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-9" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-9"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-10" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-10"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-11" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-11"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-12" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-12"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-13" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-13"></a><span class="s2">optvar1 = getarg(1)</span>
<a id="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-14" name="rest_code_07b40a2b8e224f7db52e79a5f3287eeb-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_07b40a2b8e224f7db52e79a5f3287eeb-14"></a><span class="s2">optvar2 = store(optvar0, 0, optvar1)"""</span>
</pre></div>
</section><section id="version-4-materialization-of-constants"><h2>Version 4: Materialization of Constants</h2>
<p>Another straightforward extension is to support materializing constants. A
constant is never virtual, so materializing it should do nothing.</p>
<div class="code"><pre class="code python"><a id="rest_code_27099929a51a4e33ab16e089d44a86d4-1" name="rest_code_27099929a51a4e33ab16e089d44a86d4-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-1"></a><span class="k">def</span> <span class="nf">test_materialization_constants</span><span class="p">():</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-2" name="rest_code_27099929a51a4e33ab16e089d44a86d4-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-2"></a>    <span class="c1"># in this example we store the constant 17</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-3" name="rest_code_27099929a51a4e33ab16e089d44a86d4-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-3"></a>    <span class="c1"># into the non-virtual var0</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-4" name="rest_code_27099929a51a4e33ab16e089d44a86d4-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-4"></a>    <span class="c1"># again, this will not be optimized</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-5" name="rest_code_27099929a51a4e33ab16e089d44a86d4-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-5"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-6" name="rest_code_27099929a51a4e33ab16e089d44a86d4-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-6"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-7" name="rest_code_27099929a51a4e33ab16e089d44a86d4-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-7"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-8" name="rest_code_27099929a51a4e33ab16e089d44a86d4-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-8"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-9" name="rest_code_27099929a51a4e33ab16e089d44a86d4-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-9"></a>    <span class="c1"># the previous line fails so far, triggering</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-10" name="rest_code_27099929a51a4e33ab16e089d44a86d4-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-10"></a>    <span class="c1"># the assert:</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-11" name="rest_code_27099929a51a4e33ab16e089d44a86d4-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-11"></a>    <span class="c1"># assert not isinstance(value, Constant)</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-12" name="rest_code_27099929a51a4e33ab16e089d44a86d4-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-12"></a>    <span class="c1"># in materialize</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-13" name="rest_code_27099929a51a4e33ab16e089d44a86d4-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-13"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-14" name="rest_code_27099929a51a4e33ab16e089d44a86d4-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-14"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_27099929a51a4e33ab16e089d44a86d4-15" name="rest_code_27099929a51a4e33ab16e089d44a86d4-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27099929a51a4e33ab16e089d44a86d4-15"></a><span class="s2">optvar1 = store(optvar0, 0, 17)"""</span>
</pre></div>
<p>To implement that case, we check for <code class="docutils literal">value</code> being a constant and return
early:</p>
<div class="code"><pre class="code python"><a id="rest_code_387b06762c224ef5805901bb1d205045-1" name="rest_code_387b06762c224ef5805901bb1d205045-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-1"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-2" name="rest_code_387b06762c224ef5805901bb1d205045-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-2"></a><span class="hll">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
</span><a id="rest_code_387b06762c224ef5805901bb1d205045-3" name="rest_code_387b06762c224ef5805901bb1d205045-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-3"></a><span class="hll">        <span class="k">return</span>
</span><a id="rest_code_387b06762c224ef5805901bb1d205045-4" name="rest_code_387b06762c224ef5805901bb1d205045-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-4"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-5" name="rest_code_387b06762c224ef5805901bb1d205045-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-5"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-6" name="rest_code_387b06762c224ef5805901bb1d205045-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-6"></a>    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-7" name="rest_code_387b06762c224ef5805901bb1d205045-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-7"></a>        <span class="k">return</span> <span class="c1"># already materialized</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-8" name="rest_code_387b06762c224ef5805901bb1d205045-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-8"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-9" name="rest_code_387b06762c224ef5805901bb1d205045-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-9"></a>    <span class="c1"># put the alloc operation back into the trace</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-10" name="rest_code_387b06762c224ef5805901bb1d205045-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-10"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-11" name="rest_code_387b06762c224ef5805901bb1d205045-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-11"></a>    <span class="c1"># but only once</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-12" name="rest_code_387b06762c224ef5805901bb1d205045-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-12"></a>    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_387b06762c224ef5805901bb1d205045-13" name="rest_code_387b06762c224ef5805901bb1d205045-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-13"></a>
<a id="rest_code_387b06762c224ef5805901bb1d205045-14" name="rest_code_387b06762c224ef5805901bb1d205045-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_387b06762c224ef5805901bb1d205045-14"></a><span class="c1"># optimize_alloc_removal unchanged</span>
</pre></div>
</section><section id="version-5-materializing-fields"><h2>Version 5: Materializing Fields</h2>
<p>Now we need to solve a more difficult problem. So far, the virtual objects that
we have materialized have all been empty, meaning they didn't have any fields
written to at the point of materialization. Let's write a test for this:</p>
<div class="code"><pre class="code python"><a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-1" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-1"></a><span class="k">def</span> <span class="nf">test_materialize_fields</span><span class="p">():</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-2" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-3" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-4" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-4"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-5" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-5"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-6" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-6"></a>    <span class="n">contents0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-7" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-7"></a>    <span class="n">contents1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-8" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-8"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-9" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-9"></a>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-10" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-10"></a>    <span class="c1"># the virtual obj looks like this</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-11" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-11"></a>    <span class="c1">#  obj</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-12" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-12"></a>    <span class="c1"># ┌──────┬──────────┐</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-13" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-13"></a>    <span class="c1"># │ 0: 8 │ 1: var1  │</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-14" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-14"></a>    <span class="c1"># └──────┴──────────┘</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-15" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-15"></a>    <span class="c1"># then it needs to be materialized</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-16" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-16"></a>    <span class="c1"># this is the first example where a virtual</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-17" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-17"></a>    <span class="c1"># object that we want to materialize has any</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-18" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-18"></a>    <span class="c1"># content and is not just an empty object</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-19" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-19"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-20" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-20"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-21" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-21"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-22" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-22"></a><span class="s2">optvar1 = getarg(1)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-23" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-23"></a><span class="s2">optvar2 = alloc()</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-24" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-24" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-24"></a><span class="s2">optvar3 = store(optvar2, 0, 8)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-25" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-25" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-25"></a><span class="s2">optvar4 = store(optvar2, 1, optvar1)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-26" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-26" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-26"></a><span class="s2">optvar5 = store(optvar0, 0, optvar2)"""</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-27" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-27" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-27"></a>    <span class="c1"># fails so far! the operations we get</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-28" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-28" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-28"></a>    <span class="c1"># at the moment are:</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-29" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-29" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-29"></a>    <span class="c1"># optvar0 = getarg(0)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-30" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-30" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-30"></a>    <span class="c1"># optvar1 = getarg(1)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-31" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-31" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-31"></a>    <span class="c1"># optvar2 = alloc()</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-32" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-32" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-32"></a>    <span class="c1"># optvar3 = store(optvar0, 0, optvar2)</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-33" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-33" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-33"></a>    <span class="c1"># which is wrong, because the store operations</span>
<a id="rest_code_3ed8e753c9154fabbf5e9214142afbe9-34" name="rest_code_3ed8e753c9154fabbf5e9214142afbe9-34" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_3ed8e753c9154fabbf5e9214142afbe9-34"></a>    <span class="c1"># into optvar1 got lost</span>
</pre></div>
<p>To fix this problem, we need to re-create a <code class="docutils literal">store</code> operation for every
element of the <code class="docutils literal">.contents</code> dictionary of the virtual object we are
materializing. <a class="reference internal" href="../posts/2022/10/toy-optimizer-allocation-removal.html#target-5">²</a></p>
<div class="code"><pre class="code python"><a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-1" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-1"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-2" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-2"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-3" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-3"></a>        <span class="k">return</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-4" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-4"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-5" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-5"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-6" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-6"></a>    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-7" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-7"></a>        <span class="k">return</span> <span class="c1"># already materialized</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-8" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-8"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-9" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-9"></a>    <span class="c1"># put the alloc operation back into the trace</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-10" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-10"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-11" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-11"></a><span class="hll">    <span class="c1"># put the content back</span>
</span><a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-12" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-12"></a><span class="hll">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-13" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-13"></a><span class="hll">        <span class="c1"># re-create store operation</span>
</span><a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-14" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-14"></a><span class="hll">        <span class="n">opt_bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span><a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-15" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-15"></a>    <span class="c1"># only materialize once</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-16" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-16"></a>    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-17" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-17"></a>
<a id="rest_code_cd7b3822ecac4fae8e718375c3bb2758-18" name="rest_code_cd7b3822ecac4fae8e718375c3bb2758-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_cd7b3822ecac4fae8e718375c3bb2758-18"></a><span class="c1"># optimize_alloc_removal unchanged</span>
</pre></div>
<p>This is enough to pass the test.</p>
</section><section id="version-6-recursive-materialization"><h2>Version 6: Recursive Materialization</h2>
<p>In the above example, the fields of the virtual objects contained
only constants or non-virtual objects. However, we could have a situation where
a whole tree of virtual objects is built, and then the root of the tree escapes.
This makes it necessary to escape the whole tree. Let's write a test for a small
tree of two virtual objects:</p>
<div class="code"><pre class="code python"><a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-1" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-1"></a><span class="k">def</span> <span class="nf">test_materialize_chained_objects</span><span class="p">():</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-2" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-3" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-4" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-4"></a>    <span class="n">obj0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-5" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-5"></a>    <span class="n">obj1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-6" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-6"></a>    <span class="n">contents</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj1</span><span class="p">)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-7" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-7"></a>    <span class="n">const</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-8" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-8"></a>    <span class="n">sto</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj0</span><span class="p">)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-9" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-9"></a>    <span class="c1">#  obj0</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-10" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-10"></a>    <span class="c1"># ┌──────┐</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-11" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-11"></a>    <span class="c1"># │ 0: ╷ │</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-12" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-12"></a>    <span class="c1"># └────┼─┘</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-13" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-13"></a>    <span class="c1">#      │</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-14" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-14"></a>    <span class="c1">#      ▼</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-15" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-15"></a>    <span class="c1">#     obj1</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-16" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-16"></a>    <span class="c1">#   ┌─────────┐</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-17" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-17"></a>    <span class="c1">#   │ 0: 1337 │</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-18" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-18"></a>    <span class="c1">#   └─────────┘</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-19" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-19"></a>    <span class="c1"># now obj0 escapes</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-20" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-20"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-21" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-21"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-22" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-22"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-23" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-23"></a><span class="s2">optvar1 = alloc()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-24" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-24" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-24"></a><span class="s2">optvar2 = alloc()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-25" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-25" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-25"></a><span class="s2">optvar3 = store(optvar2, 0, 1337)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-26" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-26" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-26"></a><span class="s2">optvar4 = store(optvar1, 0, optvar2)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-27" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-27" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-27"></a><span class="s2">optvar5 = store(optvar0, 0, optvar1)"""</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-28" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-28" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-28"></a>    <span class="c1"># fails in an annoying way! the resulting</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-29" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-29" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-29"></a>    <span class="c1"># basic block is not in proper SSA form</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-30" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-30" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-30"></a>    <span class="c1"># so printing it fails. The optimized</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-31" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-31" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-31"></a>    <span class="c1"># block would look like this:</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-32" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-32" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-32"></a>    <span class="c1"># optvar0 = getarg(0)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-33" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-33" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-33"></a>    <span class="c1"># optvar1 = alloc()</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-34" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-34" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-34"></a>    <span class="c1"># optvar3 = store(optvar1, 0, optvar2)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-35" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-35" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-35"></a>    <span class="c1"># optvar4 = store(optvar0, 0, optvar1)</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-36" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-36" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-36"></a>    <span class="c1"># where optvar2 is an ``alloc`` Operation</span>
<a id="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-37" name="rest_code_ff02ac407b134f2d8494d699ed6f1ca7-37" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ff02ac407b134f2d8494d699ed6f1ca7-37"></a>    <span class="c1"># that is not itself in the output block</span>
</pre></div>
<p>To fix it, <code class="docutils literal">materialize</code> needs to call itself recursively for all the field
values of the virtual object:</p>
<div class="code"><pre class="code python"><a id="rest_code_27177a34a73544cc9837c917f98bbb95-1" name="rest_code_27177a34a73544cc9837c917f98bbb95-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-1"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-2" name="rest_code_27177a34a73544cc9837c917f98bbb95-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-2"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-3" name="rest_code_27177a34a73544cc9837c917f98bbb95-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-3"></a>        <span class="k">return</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-4" name="rest_code_27177a34a73544cc9837c917f98bbb95-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-4"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-5" name="rest_code_27177a34a73544cc9837c917f98bbb95-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-5"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-6" name="rest_code_27177a34a73544cc9837c917f98bbb95-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-6"></a>    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-7" name="rest_code_27177a34a73544cc9837c917f98bbb95-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-7"></a>        <span class="k">return</span> <span class="c1"># already materialized</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-8" name="rest_code_27177a34a73544cc9837c917f98bbb95-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-8"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-9" name="rest_code_27177a34a73544cc9837c917f98bbb95-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-9"></a>    <span class="c1"># put the alloc operation back into the trace</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-10" name="rest_code_27177a34a73544cc9837c917f98bbb95-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-10"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-11" name="rest_code_27177a34a73544cc9837c917f98bbb95-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-11"></a>    <span class="c1"># put the content back</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-12" name="rest_code_27177a34a73544cc9837c917f98bbb95-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-12"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-13" name="rest_code_27177a34a73544cc9837c917f98bbb95-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-13"></a><span class="hll">        <span class="c1"># materialize recursively</span>
</span><a id="rest_code_27177a34a73544cc9837c917f98bbb95-14" name="rest_code_27177a34a73544cc9837c917f98bbb95-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-14"></a><span class="hll">        <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span><a id="rest_code_27177a34a73544cc9837c917f98bbb95-15" name="rest_code_27177a34a73544cc9837c917f98bbb95-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-15"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-16" name="rest_code_27177a34a73544cc9837c917f98bbb95-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-16"></a>    <span class="c1"># only materialize once</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-17" name="rest_code_27177a34a73544cc9837c917f98bbb95-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-17"></a>    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-18" name="rest_code_27177a34a73544cc9837c917f98bbb95-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-18"></a>
<a id="rest_code_27177a34a73544cc9837c917f98bbb95-19" name="rest_code_27177a34a73544cc9837c917f98bbb95-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_27177a34a73544cc9837c917f98bbb95-19"></a><span class="c1"># optimize_alloc_removal unchanged</span>
</pre></div>
<p>Getting there, the materialization logic is almost done. We need to fix a
subtle remaining problem though.</p>
</section><section id="version-7-dealing-with-object-cycles"><h2>Version 7: Dealing with Object Cycles</h2>
<p>The bug we need to fix in this section is a bit tricky, and does not immediately
occur in a lot of programs. In
fact, in PyPy a variant of it was hiding out in our optimizer
until we found it much later (despite us being aware of the general problem and
correctly dealing with it in other cases).</p>
<p>The problem is this: a virtual object can (directly or indirectly) point to
itself, and we must carefully deal with that case to avoid infinite recursion in
<code class="docutils literal">materialize</code>. Here's the simplest test:</p>
<div class="code"><pre class="code python"><a id="rest_code_4a6b175045e848a28837f4e538cec11b-1" name="rest_code_4a6b175045e848a28837f4e538cec11b-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-1"></a><span class="k">def</span> <span class="nf">test_object_graph_cycles</span><span class="p">():</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-2" name="rest_code_4a6b175045e848a28837f4e538cec11b-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-3" name="rest_code_4a6b175045e848a28837f4e538cec11b-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-4" name="rest_code_4a6b175045e848a28837f4e538cec11b-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-4"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-5" name="rest_code_4a6b175045e848a28837f4e538cec11b-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-5"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-6" name="rest_code_4a6b175045e848a28837f4e538cec11b-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-6"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-7" name="rest_code_4a6b175045e848a28837f4e538cec11b-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-7"></a>    <span class="c1">#   ┌────────┐</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-8" name="rest_code_4a6b175045e848a28837f4e538cec11b-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-8"></a>    <span class="c1">#   ▼        │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-9" name="rest_code_4a6b175045e848a28837f4e538cec11b-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-9"></a>    <span class="c1">#  obj0      │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-10" name="rest_code_4a6b175045e848a28837f4e538cec11b-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-10"></a>    <span class="c1"># ┌──────┐   │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-11" name="rest_code_4a6b175045e848a28837f4e538cec11b-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-11"></a>    <span class="c1"># │ 0: ╷ │   │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-12" name="rest_code_4a6b175045e848a28837f4e538cec11b-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-12"></a>    <span class="c1"># └────┼─┘   │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-13" name="rest_code_4a6b175045e848a28837f4e538cec11b-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-13"></a>    <span class="c1">#      │     │</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-14" name="rest_code_4a6b175045e848a28837f4e538cec11b-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-14"></a>    <span class="c1">#      └─────┘</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-15" name="rest_code_4a6b175045e848a28837f4e538cec11b-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-15"></a>    <span class="c1"># obj0 points to itself, and then it is</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-16" name="rest_code_4a6b175045e848a28837f4e538cec11b-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-16"></a>    <span class="c1"># escaped</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-17" name="rest_code_4a6b175045e848a28837f4e538cec11b-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-17"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-18" name="rest_code_4a6b175045e848a28837f4e538cec11b-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-18"></a>    <span class="c1"># the previous line fails with an</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-19" name="rest_code_4a6b175045e848a28837f4e538cec11b-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-19"></a>    <span class="c1"># InfiniteRecursionError</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-20" name="rest_code_4a6b175045e848a28837f4e538cec11b-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-20"></a>    <span class="c1"># materialize calls itself, infinitely</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-21" name="rest_code_4a6b175045e848a28837f4e538cec11b-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-21"></a>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-22" name="rest_code_4a6b175045e848a28837f4e538cec11b-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-22"></a>    <span class="c1"># what we want is instead this output:</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-23" name="rest_code_4a6b175045e848a28837f4e538cec11b-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-23"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-24" name="rest_code_4a6b175045e848a28837f4e538cec11b-24" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-24"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-25" name="rest_code_4a6b175045e848a28837f4e538cec11b-25" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-25"></a><span class="s2">optvar1 = alloc()</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-26" name="rest_code_4a6b175045e848a28837f4e538cec11b-26" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-26"></a><span class="s2">optvar2 = store(optvar1, 0, optvar1)</span>
<a id="rest_code_4a6b175045e848a28837f4e538cec11b-27" name="rest_code_4a6b175045e848a28837f4e538cec11b-27" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_4a6b175045e848a28837f4e538cec11b-27"></a><span class="s2">optvar3 = store(optvar0, 1, optvar1)"""</span>
</pre></div>
<p>The fix is not a big change, but a little bit subtle nevertheless.
We have to change the
order in which things are done in <code class="docutils literal">materialize</code>. Right after emitting the
<code class="docutils literal">alloc</code>, we set the <code class="docutils literal">.info</code> to <code class="docutils literal">None</code>, to mark the object as not virtual.
Only <em>afterwards</em> do we re-create the stores and call <code class="docutils literal">materialize</code> recursively.
If a recursive call reaches the same object, it's already marked as non-virtual,
so <code class="docutils literal">materialize</code> won't recurse further:</p>
<div class="code"><pre class="code python"><a id="rest_code_dddc53240ddd40529a69442d80c5471d-1" name="rest_code_dddc53240ddd40529a69442d80c5471d-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-1"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Operation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-2" name="rest_code_dddc53240ddd40529a69442d80c5471d-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-2"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-3" name="rest_code_dddc53240ddd40529a69442d80c5471d-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-3"></a>        <span class="k">return</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-4" name="rest_code_dddc53240ddd40529a69442d80c5471d-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-4"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-5" name="rest_code_dddc53240ddd40529a69442d80c5471d-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-5"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-6" name="rest_code_dddc53240ddd40529a69442d80c5471d-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-6"></a>    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-7" name="rest_code_dddc53240ddd40529a69442d80c5471d-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-7"></a>        <span class="k">return</span> <span class="c1"># already materialized</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-8" name="rest_code_dddc53240ddd40529a69442d80c5471d-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-8"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-9" name="rest_code_dddc53240ddd40529a69442d80c5471d-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-9"></a>    <span class="c1"># put the alloc operation back into the trace</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-10" name="rest_code_dddc53240ddd40529a69442d80c5471d-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-10"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_dddc53240ddd40529a69442d80c5471d-11" name="rest_code_dddc53240ddd40529a69442d80c5471d-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-11"></a><span class="hll">    <span class="c1"># only materialize once</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-12" name="rest_code_dddc53240ddd40529a69442d80c5471d-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-12"></a><span class="hll">    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-13" name="rest_code_dddc53240ddd40529a69442d80c5471d-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-13"></a><span class="hll">    <span class="c1"># put the content back</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-14" name="rest_code_dddc53240ddd40529a69442d80c5471d-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-14"></a><span class="hll">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-15" name="rest_code_dddc53240ddd40529a69442d80c5471d-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-15"></a><span class="hll">        <span class="c1"># materialize recursively</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-16" name="rest_code_dddc53240ddd40529a69442d80c5471d-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-16"></a><span class="hll">        <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span><a id="rest_code_dddc53240ddd40529a69442d80c5471d-17" name="rest_code_dddc53240ddd40529a69442d80c5471d-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_dddc53240ddd40529a69442d80c5471d-17"></a><span class="hll">        <span class="n">opt_bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></pre></div>
</section><section id="version-8-loading-from-non-virtual-objects"><h2>Version 8: Loading from non-virtual objects</h2>
<p>Now materialize is done. We need to go back to <code class="docutils literal">optimize_alloc_removal</code> and
improve it further. The last time we changed it, we added a case analysis to the
code dealing with <code class="docutils literal">store</code>, distinguishing between storing to a virtual and to
a non-virtual object. We need to add an equivalent distinction to the <code class="docutils literal">load</code>
case, because right now loading from a non-virtual crashes.</p>
<div class="code"><pre class="code python"><a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-1" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-1"></a><span class="k">def</span> <span class="nf">test_load_non_virtual</span><span class="p">():</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-2" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-3" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-4" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-4"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-5" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-5"></a>    <span class="n">bb</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-6" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-6"></a>    <span class="c1"># the next line fails in the line</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-7" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-7"></a>    <span class="c1"># op.make_equal_to(info.load(field))</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-8" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-8"></a>    <span class="c1"># because info is None</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-9" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-9"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-10" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-10"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-11" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-11"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-12" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-12"></a><span class="s2">optvar1 = load(optvar0, 0)</span>
<a id="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-13" name="rest_code_ba7d0bc47a0d462da6591b08370ec9c4-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_ba7d0bc47a0d462da6591b08370ec9c4-13"></a><span class="s2">optvar2 = print(optvar1)"""</span>
</pre></div>
<p>To fix it, we split the <code class="docutils literal">load</code> code into two cases, leaving the virtual path
as before, and letting the <code class="docutils literal">load</code> from a non-virtual fall through to the
general code at the end of the function.</p>
<div class="code"><pre class="code python"><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-1" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-1"></a><span class="k">def</span> <span class="nf">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-2" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-3" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-3"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-4" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-4"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span><span class="p">:</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-5" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-5"></a>            <span class="n">op</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">VirtualObject</span><span class="p">()</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-6" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-6"></a>            <span class="k">continue</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-7" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-7"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"load"</span><span class="p">:</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-8" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-8"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-9" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-9"></a><span class="hll">            <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="c1"># virtual</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-10" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-10"></a><span class="hll">                <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-11" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-11"></a><span class="hll">                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-12" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-12"></a><span class="hll">                <span class="k">continue</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-13" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-13"></a><span class="hll">            <span class="c1"># otherwise not virtual, use the</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-14" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-14"></a><span class="hll">            <span class="c1"># general path below</span>
</span><a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-15" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-15"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"store"</span><span class="p">:</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-16" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-16"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-17" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-17"></a>            <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="c1"># virtual</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-18" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-18"></a>                <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-19" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-19"></a>                <span class="n">info</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-20" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-20"></a>                <span class="k">continue</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-21" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-21"></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># not virtual</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-22" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-22"></a>                <span class="c1"># first materialize the</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-23" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-23"></a>                <span class="c1"># right hand side</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-24" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-24" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-24"></a>                <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-25" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-25" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-25"></a>                <span class="c1"># then emit the store via</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-26" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-26" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-26"></a>                <span class="c1"># the general path below</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-27" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-27" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-27"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-28" name="rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-28" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b2ec32770e0a424ea4ec8bb37c1567c1-28"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
</pre></div>
</section><section id="version-9-final-materialize-on-other-operations"><h2>Version 9 (Final): Materialize on Other Operations</h2>
<p>We're almost at the end now. There's one final generalization left to do. We
started with the heuristic that storing a virtual into a non-virtual would
escape it. This should be generalized. Every time we pass a virtual into any
operation where it is not the first argument of a <code class="docutils literal">load</code> and a <code class="docutils literal">store</code>
should also escape it (imagine passing the virtual to some function call).
Let's test this as usual with our <code class="docutils literal">print</code> operation:</p>
<div class="code"><pre class="code python"><a id="rest_code_9e2666b30d6345dc9df789b2327ad059-1" name="rest_code_9e2666b30d6345dc9df789b2327ad059-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-1"></a><span class="k">def</span> <span class="nf">test_materialize_on_other_ops</span><span class="p">():</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-2" name="rest_code_9e2666b30d6345dc9df789b2327ad059-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-2"></a>    <span class="c1"># materialize not just on store</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-3" name="rest_code_9e2666b30d6345dc9df789b2327ad059-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-3"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-4" name="rest_code_9e2666b30d6345dc9df789b2327ad059-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-4"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-5" name="rest_code_9e2666b30d6345dc9df789b2327ad059-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-5"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-6" name="rest_code_9e2666b30d6345dc9df789b2327ad059-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-6"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">var1</span><span class="p">)</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-7" name="rest_code_9e2666b30d6345dc9df789b2327ad059-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-7"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-8" name="rest_code_9e2666b30d6345dc9df789b2327ad059-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-8"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-9" name="rest_code_9e2666b30d6345dc9df789b2327ad059-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-9"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-10" name="rest_code_9e2666b30d6345dc9df789b2327ad059-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-10"></a><span class="s2">optvar1 = alloc()</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-11" name="rest_code_9e2666b30d6345dc9df789b2327ad059-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-11"></a><span class="s2">optvar2 = print(optvar1)"""</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-12" name="rest_code_9e2666b30d6345dc9df789b2327ad059-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-12"></a>    <span class="c1"># again, the resulting basic block is not in</span>
<a id="rest_code_9e2666b30d6345dc9df789b2327ad059-13" name="rest_code_9e2666b30d6345dc9df789b2327ad059-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_9e2666b30d6345dc9df789b2327ad059-13"></a>    <span class="c1"># valid SSA form</span>
</pre></div>
<p>To fix this, we will take the call to <code class="docutils literal">materialize</code> out of the <code class="docutils literal">store</code> code
path and instead put it into the generic code path the end of the <code class="docutils literal">while</code>
loop:</p>
<div class="code"><pre class="code python"><a id="rest_code_b308a95053064308bea999d5bcf1d83e-1" name="rest_code_b308a95053064308bea999d5bcf1d83e-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-1"></a><span class="c1"># materialize is unchanged</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-2" name="rest_code_b308a95053064308bea999d5bcf1d83e-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-2"></a><span class="k">def</span> <span class="nf">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-3" name="rest_code_b308a95053064308bea999d5bcf1d83e-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-3"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-4" name="rest_code_b308a95053064308bea999d5bcf1d83e-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-4"></a>        <span class="k">return</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-5" name="rest_code_b308a95053064308bea999d5bcf1d83e-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-5"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Operation</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-6" name="rest_code_b308a95053064308bea999d5bcf1d83e-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-6"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-7" name="rest_code_b308a95053064308bea999d5bcf1d83e-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-7"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-8" name="rest_code_b308a95053064308bea999d5bcf1d83e-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-8"></a>        <span class="c1"># Already materialized</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-9" name="rest_code_b308a95053064308bea999d5bcf1d83e-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-9"></a>        <span class="k">return</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-10" name="rest_code_b308a95053064308bea999d5bcf1d83e-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-10"></a>    <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-11" name="rest_code_b308a95053064308bea999d5bcf1d83e-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-11"></a>    <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-12" name="rest_code_b308a95053064308bea999d5bcf1d83e-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-12"></a>    <span class="n">value</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-13" name="rest_code_b308a95053064308bea999d5bcf1d83e-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-13"></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-14" name="rest_code_b308a95053064308bea999d5bcf1d83e-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-14"></a>        <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-15" name="rest_code_b308a95053064308bea999d5bcf1d83e-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-15"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-16" name="rest_code_b308a95053064308bea999d5bcf1d83e-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-16"></a>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-17" name="rest_code_b308a95053064308bea999d5bcf1d83e-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-17"></a><span class="k">def</span> <span class="nf">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-18" name="rest_code_b308a95053064308bea999d5bcf1d83e-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-18"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-19" name="rest_code_b308a95053064308bea999d5bcf1d83e-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-19"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-20" name="rest_code_b308a95053064308bea999d5bcf1d83e-20" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-20"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"alloc"</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-21" name="rest_code_b308a95053064308bea999d5bcf1d83e-21" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-21"></a>            <span class="n">op</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">VirtualObject</span><span class="p">()</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-22" name="rest_code_b308a95053064308bea999d5bcf1d83e-22" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-22"></a>            <span class="k">continue</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-23" name="rest_code_b308a95053064308bea999d5bcf1d83e-23" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-23"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"load"</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-24" name="rest_code_b308a95053064308bea999d5bcf1d83e-24" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-24"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-25" name="rest_code_b308a95053064308bea999d5bcf1d83e-25" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-25"></a>            <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="c1"># virtual</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-26" name="rest_code_b308a95053064308bea999d5bcf1d83e-26" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-26"></a>                <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-27" name="rest_code_b308a95053064308bea999d5bcf1d83e-27" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-27"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-28" name="rest_code_b308a95053064308bea999d5bcf1d83e-28" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-28"></a>                <span class="k">continue</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-29" name="rest_code_b308a95053064308bea999d5bcf1d83e-29" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-29"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"store"</span><span class="p">:</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-30" name="rest_code_b308a95053064308bea999d5bcf1d83e-30" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-30"></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">info</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-31" name="rest_code_b308a95053064308bea999d5bcf1d83e-31" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-31"></a>            <span class="k">if</span> <span class="n">info</span><span class="p">:</span> <span class="c1"># virtual</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-32" name="rest_code_b308a95053064308bea999d5bcf1d83e-32" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-32"></a>                <span class="n">field</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-33" name="rest_code_b308a95053064308bea999d5bcf1d83e-33" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-33"></a>                <span class="n">info</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-34" name="rest_code_b308a95053064308bea999d5bcf1d83e-34" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-34"></a>                <span class="k">continue</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-35" name="rest_code_b308a95053064308bea999d5bcf1d83e-35" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-35"></a><span class="hll">        <span class="c1"># materialize all the arguments of</span>
</span><a id="rest_code_b308a95053064308bea999d5bcf1d83e-36" name="rest_code_b308a95053064308bea999d5bcf1d83e-36" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-36"></a><span class="hll">        <span class="c1"># operations that are put into the</span>
</span><a id="rest_code_b308a95053064308bea999d5bcf1d83e-37" name="rest_code_b308a95053064308bea999d5bcf1d83e-37" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-37"></a><span class="hll">        <span class="c1"># output basic block</span>
</span><a id="rest_code_b308a95053064308bea999d5bcf1d83e-38" name="rest_code_b308a95053064308bea999d5bcf1d83e-38" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-38"></a><span class="hll">        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
</span><a id="rest_code_b308a95053064308bea999d5bcf1d83e-39" name="rest_code_b308a95053064308bea999d5bcf1d83e-39" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-39"></a><span class="hll">            <span class="n">materialize</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">())</span>
</span><a id="rest_code_b308a95053064308bea999d5bcf1d83e-40" name="rest_code_b308a95053064308bea999d5bcf1d83e-40" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-40"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b308a95053064308bea999d5bcf1d83e-41" name="rest_code_b308a95053064308bea999d5bcf1d83e-41" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b308a95053064308bea999d5bcf1d83e-41"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
</pre></div>
<p>That's it, we're done. It's not a lot of code, but actually quite a powerful
optimization. In addition to removing allocations for objects that are only used
briefly and in predictable ways, it also has another effect. If an object is
allocated, used in a number of operations and then escapes further down in the
block, the operations in between can often be optimized away. This is
demonstrated by the next test (which already passes):</p>
<div class="code"><pre class="code python"><a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-1" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-1" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-1"></a><span class="k">def</span> <span class="nf">test_sink_allocations</span><span class="p">():</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-2" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-2" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-2"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-3" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-3" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-3"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-4" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-4" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-4"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-5" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-5" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-5"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-6" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-6" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-6"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">456</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-7" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-7" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-7"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-8" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-8" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-8"></a>    <span class="n">var5</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-9" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-9" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-9"></a>    <span class="n">var6</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var4</span><span class="p">,</span> <span class="n">var5</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-10" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-10" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-10"></a>    <span class="n">var7</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var6</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-11" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-11" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-11"></a>    <span class="n">var8</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-12" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-12" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-12"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize_alloc_removal</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-13" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-13" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-13"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-14" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-14" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-14"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-15" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-15" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-15"></a><span class="s2">optvar1 = add(123, 456)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-16" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-16" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-16"></a><span class="s2">optvar2 = alloc()</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-17" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-17" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-17"></a><span class="s2">optvar3 = store(optvar2, 0, optvar1)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-18" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-18" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-18"></a><span class="s2">optvar4 = store(optvar2, 1, 456)</span>
<a id="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-19" name="rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-19" href="../posts/2022/10/toy-optimizer-allocation-removal.html#rest_code_b0c311d17d9a48e99333d69e8b5a3fe1-19"></a><span class="s2">optvar5 = store(optvar0, 1, optvar2)"""</span>
</pre></div>
<p>Note that the addition is not optimized away, because the code from this blog
post does not contain constant folding and the other optimizations from
the last one. Combining them would not be too hard though.</p>
</section><section id="conclusion"><h2>Conclusion</h2>
<p>That's it! The core idea of PyPy's allocation removal optimization in one or
two screens of code. The real implementation has a number of refinements,
but the core ideas are all here.</p>
<p>I'm not going to show any benchmark numbers or anything like that here, if you
are interested in numbers you could look at the evaluation Section 6.
"Implementation and Evaluation" of the <a class="reference external" href="https://www3.hhu.de/stups/downloads/pdf/BoCuFiLePeRi2011.pdf">paper</a> that describes the work.</p>
<p>There's a complementary optimization that improves <code class="docutils literal">load</code> and <code class="docutils literal">store</code>
operations for objects that are <em>not</em> virtual. I'll probably not write that
down as another post, but <a class="reference external" href="https://bernsteinbear.com/">Max Bernstein</a> and I developed that together on a
<a class="reference external" href="../posts/2022/10/twitch.tv/pypyproject">PyPy Twitch channel</a> channel a few weeks ago, here's the recording:</p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/w-UHg0yOPSE" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></section><section id="footnotes"><h2>Footnotes</h2>
<p id="target-4">¹ This is how PyPy uses the terminology, not really used consistently by other
projects. The term "escape" is fairly standard throughout the <a class="reference external" href="https://en.wikipedia.org/wiki/Escape_analysis">escape
analysis</a> literature. The term "virtual" was used originally in <a class="reference external" href="https://dl.acm.org/doi/abs/10.1145/1014007.1014010">Armin Rigo's
Psyco</a> but is e.g. also used by the paper <a class="reference external" href="https://www.ssw.uni-linz.ac.at/Research/Papers/Stadler14/Stadler2014-CGO-PEA.pdf">Partial Escape Analysis and Scalar
Replacement for Java</a>.</p>
<p id="target-5">² The order in which we put the <cite>store</cite> operations back is relying on
dictionary iteration order, which is insertion order. That's not a bad
ordering, we could also be explicit and sort the fields in some order (ideally
the order in which the object lays them out in memory).</p>
</section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/07/ddorf-sprint-sep-2022.html" class="u-url">Düsseldorf HPy/PyPy/GraalPy sprint September 19-23rd 2022</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/07/ddorf-sprint-sep-2022.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-07-29T12:00:00Z" itemprop="datePublished" title="2022-07-29 12:00">2022-07-29 12:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <p>The programming language group of the Computer Science department of
Heinrich-Heine Universität Düsseldorf is happy to invite everybody to another
sprint in Düsseldorf, from the 19th to the 23rd of September 2022. This is a
fully public sprint, everyone and particularly newcomers are welcome to join
us! The goal is to bring together people from the <a class="reference external" href="https://hpyproject.org/">HPy</a>, PyPy, <a class="reference external" href="https://www.graalvm.org/python/">GraalPy</a> and
CPython communities.</p>
<section id="topics-and-goals"><h2>Topics and goals</h2>
<ul class="simple">
<li><p>work on HPy APIs, discussions around next steps for the project</p></li>
<li><p>continuing new and ongoing ports to HPy, including Cython, NumPy, Pillow, Matplotlib</p></li>
<li><p>3.10 support on PyPy and GraalPy</p></li>
<li><p>preparing the next PyPy release</p></li>
<li><p>discussions around ways to improve collaboration between the different Python
implementations</p></li>
</ul></section><section id="what-is-a-sprint"><h2>What is a sprint?</h2>
<p>The experience of the PyPy project has shown the benefits of regular
sprints. They are focussed one week physical meetings where people pair-program
on new features and discuss future plans. Coming to one is a great way to get
started with a project!</p>
</section><section id="location"><h2>Location</h2>
<p>The sprint will take place in a seminar room of the computer science
department.  It is in the building 25.12, room 02.50 (second floor) of the
university campus. For travel instructions see</p>
<blockquote>
<p><a class="reference external" href="https://www.cs.hhu.de/lehrstuehle-und-arbeitsgruppen/softwaretechnik-und-programmiersprachen/kontakt/service/lage-und-anreise">https://www.cs.hhu.de/lehrstuehle-und-arbeitsgruppen/softwaretechnik-und-programmiersprachen/kontakt/service/lage-und-anreise</a></p>
</blockquote>
<p>We ask participants to wear masks during the indoor working hours.</p>
<figure><a class="reference external image-reference" href="https://commons.wikimedia.org/wiki/File:Universitaets-_und_Landesbibliothek_Duesseldorf_in_Duesseldorf-Bilk,_von_Nordwesten.jpg">
<img alt="Photograph of the statue of Heinrich Heine in front of the University library on the campus in Düsseldorf" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/00/Universitaets-_und_Landesbibliothek_Duesseldorf_in_Duesseldorf-Bilk%2C_von_Nordwesten.jpg/640px-Universitaets-_und_Landesbibliothek_Duesseldorf_in_Duesseldorf-Bilk%2C_von_Nordwesten.jpg"></a>
<figcaption><p>Wiegels, CC BY 3.0, via Wikimedia Commons</p>
</figcaption></figure></section><section id="exact-times"><h2>Exact times</h2>
<p>Work days: starting September 19th (~morning), ending September 23rd (~afternoon).
We will do a to-be-planned social activity on Wednesday afternoon.</p>
</section><section id="registration"><h2>Registration</h2>
<p>Please register by editing this file or by opening a <a class="reference external" href="https://doc.pypy.org/en/latest/coding-guide.html">pull request</a>:</p>
<blockquote>
<p><a class="reference external" href="https://foss.heptapod.net/pypy/extradoc/-/blob/branch/extradoc/sprintinfo/ddorf2022/people.txt">https://foss.heptapod.net/pypy/extradoc/-/blob/branch/extradoc/sprintinfo/ddorf2022/people.txt</a></p>
</blockquote>
<p>or by sending a quick mail to the pypy-dev mailing list:</p>
<blockquote>
<p><a class="reference external" href="http://mail.python.org/mailman/listinfo/pypy-dev">http://mail.python.org/mailman/listinfo/pypy-dev</a></p>
</blockquote>
</section>
</div>
    </article>
</div>
</div>
<div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2024/08/portaone.html" class="listtitle">Guest Post: How PortaOne uses PyPy for high-performance processing, connecting over 1B of phone calls every month</a>
      </li>
      <li>
        <a href="/posts/2024/08/pypy-v7317-release.html" class="listtitle">PyPy v7.3.17 release</a>
      </li>
      <li>
        <a href="/posts/2024/08/conda-forge-proposes-dropping-support-for-pypy.html" class="listtitle">Conda-forge proposes sunsetting support for PyPy</a>
      </li>
      <li>
        <a href="/posts/2024/08/toy-knownbits.html" class="listtitle">A Knownbits Abstract Domain for the Toy Optimizer, Correctly</a>
      </li>
      <li>
        <a href="/posts/2024/07/toy-abstract-interpretation.html" class="listtitle">Abstract interpretation in the Toy Optimizer</a>
      </li>
      <li>
        <a href="/posts/2024/07/mining-jit-traces-missing-optimizations-z3.html" class="listtitle">Mining JIT traces for missing optimizations with Z3</a>
      </li>
      <li>
        <a href="/posts/2024/07/finding-simple-rewrite-rules-jit-z3.html" class="listtitle">Finding Simple Rewrite Rules for the JIT with Z3</a>
      </li>
      <li>
        <a href="/posts/2024/05/vmprof-firefox-converter.html" class="listtitle">Profiling PyPy using the Firefox profiler user interface</a>
      </li>
      <li>
        <a href="/posts/2024/04/pypy-v7316-release.html" class="listtitle">PyPy v7.3.16 release</a>
      </li>
      <li>
        <a href="/posts/2024/03/fixing-bug-incremental-gc.html" class="listtitle">Fixing a Bug in PyPy's Incremental GC</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (11)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (1)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (1)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (22)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (4)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (62)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (4)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (3)</li>
          </ul>
        </div></div>
</main>
</div>
<div style="clear: both; width: 75%; margin: 1em auto;">
        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-44.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-42.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
         
                 <footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2024 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2024-08-30T08:28
  </div>
  <div style="margin-left: auto">
  <a href="../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../assets/js/styles.js"></script></footer>
</body>
</html>